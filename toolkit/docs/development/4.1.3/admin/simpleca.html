<?php 
$title="GT 4.0 : SimpleCA Introduction";
include_once( "/mcs/www-unix.globus.org/include/globus_header.inc" ); ?>

<?php
include_once( "http://www-unix.globus.org/toolkit/docs/development/4.0-drafts/draft.inc" );
?>


<h1><?php echo $title; ?></h1>
<p>The following are instructions for how to use SimpleCA to set up certificates
  for a GT 4.0 installation. </p>
<p>SimpleCA provides a wrapper around the OpenSSL CA functionality and is sufficient
  for simple Grid services. Alternatively, you can use OpenSSL's <code>CA.sh</code> command
on its own. SimpleCA is suitable for testing or when a certificate authority
  (CA) is not available. You can find other CA options <a href="index.html#hostcert">here</a>. </p>
<p>At this point you should have already gone through
    the instructions for basic GT 4.0 configuration up through <a href="index.html#envvariable">5.1
    Set environment variables</a>.</p>
<ul>
  <li><a href="#simplecausers">1 Create users</a></li>
  <li><a href="#simplecasetup">2 Run the setup script</a>
    <ul>
      <li><a href="#subjectname">2.1  Configure the subject name</a></li>
      <li><a href="#email">2.2 Configure the CA's email</a></li>
      <li><a href="#expiration">2.3 Configure the expiration date </a></li>
      <li><a href="#passphrase">2.4 Enter a passphrase</a></li>
      <li><a href="#confirmcert">2.5 Confirm generated certificate</a></li>
      <li><a href="#Finalizing">2.6 Complete setup of GSI</a></li>
    </ul>
  </li>
  <li> <a href="#hostcert">3 Host certificates</a>
    <ul>
      <li><a href="#reqhostcert">3.1 Request host certificate</a></li>
      <li><a href="#signhostcert">3.2 Sign host certificate </a></li>
    </ul>
  </li>
  <li> <a href="#usercert">4 User certificates</a>
    <ul>
      <li><a href="#requsercert">4.1 Request user certificate</a></li>
      <li><a href="#signusercert">4.2 Sign user certificate </a> </li>
    </ul>
  </li>
  <li> <a href="#testcainstall">5 Verify the certificate installation</a></li>
  <li><a href="#multiplemachines">6 Configure CA for multiple machines</a></li>
  <li><a href="#wheretogo">7 Where to go from here</a></li>
</ul>
<h2><a name=simplecausers id="simplecausers"></a>1 Create
    users </h2>
<p>Make sure you have the following users on your machine:</p>
<ul>
  <li>Your <code>user</code> account, which will be used to run the client programs.<br>
  </li>
  <li>A generic <code>globus</code> account, which will be used to perform administrative
    tasks such as starting and stopping the container, deploying services, etc.
    This user will also be in charge of managing the SimpleCA. To do this, make
    sure this account has read and write permissions in the <code>$GLOBUS_LOCATION</code> directory. </li>
</ul>
<h2><a name="simplecasetup"></a>2 Run the setup script</h2>
<p>A script was installed to set up a new SimpleCA. You only need to run this
  script <b>once</b> per Grid. </p>
<p>Run the setup script:</p>
<pre>$GLOBUS_LOCATION/setup/globus/setup-simple-ca 
</pre>
<h3><a name="subjectname"></a>2.1 Configure the subject name</h3>
<p>This script prompts you for information about the CA you wish to create:</p>
<pre>The unique subject name for this CA is:

cn=Globus Simple CA, ou=simpleCA-mayed.mcs.anl.gov, ou=GlobusTest, o=Grid

Do you want to keep this as the CA subject (y/n) [y]:</pre>
<p>where:</p>
<table width="auto"  border="1" cellspacing="0" cellpadding="5">
  <tr>
    <td valign="top"><code>cn</code></td>
    <td valign="top">Represents <em>common  name</em>.  Identifies this particular
      certificate as the CA certificate within the <em>GloubusTest/simpleCA-hostname </em>domain,
      which in this case is Globus Simple CA.</td>
  </tr>
  <tr>
    <td valign="top"><code>ou</code></td>
    <td valign="top">Represents <em>organizational unit</em>.  Identifies this CA from other
      CAs created by SimpleCA by other people. The second <strong>ou</strong> is
      specific to your hostname (in this cases GlobusTest).</td>
  </tr>
  <tr>
    <td valign="top"><code>o</code></td>
    <td valign="top">Represents <em>organization</em>. Identifies the Grid.</td>
  </tr>
</table>
<p>Press <code>y</code> to keep the default subject name (recommended). </p>
<h3><a name="email"></a>2.2 Configure the CA's email</h3>
<p>The next prompt looks like:</p>
<pre class="command">
Enter the email of the CA (this is the email where certificate
requests will be sent to be signed by the CA):</pre>
<p>Enter the email address where you intend to receive certificate requests.
  It should be your real email address that you check, not the address of the
  globus user.</p>
<h3><a name="expiration"></a>2.3 Configure the expiration date </h3>
<p>Then you'll see: </p>
<pre>
The CA certificate has an expiration date. Keep in mind that 
once the CA certificate has expired, all the certificates 
signed by that CA become invalid.  A CA should regenerate 
the CA certificate and start re-issuing ca-setup packages 
before the actual CA certificate expires.  This can be done 
by re-running this setup script.  Enter the number of DAYS 
the CA certificate should last before it expires.
[default: 5 years (1825 days)]:</pre>
<p>This is the number of days for which the CA certificate is valid. Once this
  time expires, the CA certificate will have to be recreated, and all of its
  certificates regranted. </p>
<p>Accept the default (recommended). </p>
<h3><a name="passphrase"></a>2.4 Enter a passphrase</h3>
<p>Next you'll see: </p>
<pre>
Generating a 1024 bit RSA private key
........++++++
................++++++
writing new private key to '/home/globus/.globus/simpleCA//private/cakey.pem'
Enter PEM pass phrase:</pre>
<p>The passphrase of the CA certificate will be used only when signing certificates
  (with <code>grid-cert-sign</code>). It should be hard to guess, as its compromise
  may compromise all the certificates signed by the CA.</p>
<p>Enter your passphrase. </p>
<p><strong>Important:</strong> Your passphrase must <strong>not</strong> contain
  any spaces. </p>
<h3><a name="confirmcert" id="confirmcert"></a>2.5 Confirm generated certificate</h3>
<p>Finally you'll see the following: </p>
<pre>
A self-signed certificate has been generated 
for the Certificate Authority with the subject: 

/O=Grid/OU=GlobusTest/OU=simpleCA-mayed.mcs.anl.gov/CN=Globus Simple CA

If this is invalid, rerun this script 

setup/globus/setup-simple-ca

and enter the appropriate fields.

-------------------------------------------------------------------

The private key of the CA is stored in /home/globus/.globus/simpleCA//private/cak
ey.pem
The public CA certificate is stored in /home/globus/.globus/simpleCA//cacert.pem

The distribution package built for this CA is stored in

/home/globus/.globus/simpleCA//globus_simple_ca_68ea3306_setup-0.17.tar.gz</pre>
              
<p>This information will be important for setting up other machines in your grid.
  The number <code>68ea3306</code> in the last line is known as your <em>CA hash</em>.
  It will be an 8 hexadecimal digit string. </p>
<p>Press any key to acknowledge this screen.</p>
<p>Your CA setup package finishes installing and ends the procedure with the
  following reminder: </p>
<pre>
***************************************************************************

Note: To complete setup of the GSI software you need to run the
following script as root to configure your security configuration
directory:

/opt/gt4/setup/globus_simple_ca_68ea3306_setup/setup-gsi

For further information on using the setup-gsi script, use the -help
option.  The -default option sets this security configuration to be 
the default, and -nonroot can be used on systems where root access is 
not available.

***************************************************************************

setup-ssl-utils: Complete
</pre>
<p>We'll run the setup-gsi script in the next section. For now, just notice that
  it refers to your <code>$GLOBUS_LOCATION</code> and
  the <em>CA
    Hash</em> from the last message.</p>
<h3><a name="Finalizing"></a>2.6 Complete setup of GSI</h3>
<p>To finish the setup of GSI, we'll run the script noted in the previous step.</p>
<p>Run the following as root (or, if no root privileges are available, add the <kbd>-nonroot</kbd> option
  to the command line):</p>
<pre>$GLOBUS_LOCATION/setup/globus_simple_ca_<em>CA_Hash</em>_setup/setup-gsi -default</pre>
<p>The output should look like:</p>
<pre class="command">
setup-gsi: Configuring GSI security
Installing /etc/grid-security/certificates//grid-security.conf.CA_Hash...
Running grid-security-config...
Installing Globus CA certificate into trusted CA certificate directory...
Installing Globus CA signing policy into trusted CA certificate directory...
setup-gsi: Complete</pre>
<h2><a name="hostcert"></a>3 Host certificates </h2>
<p>You must request and sign a host certificate and then copy it into the appropriate
  directory for secure services. The certificate must be for a machine which
  has a consistent name in DNS; you should not run it on a computer using DHCP
  where a different name could be assigned to your computer. </p>
<h3><a name="reqhostcert"></a>3.1 Request a host certificate</h3>
<p>As root, run:</p>
<pre>grid-cert-request -host 'hostname'</pre>
<p>This creates the following files:</p>
<ul>
  <li><code> /etc/grid-security/hostkey.pem</code></li>
  <li><code> /etc/grid-security/hostcert_request.pem</code></li>
  <li> (an empty)<code> /etc/grid-security/hostcert.pem</code></li>
</ul>
<p><b>Note:</b> If you are using your own CA, follow their instructions about
  creating a hostcert (one which has a commonName (CN) of your hostname), then
  place the cert and key in the /etc/grid-security/ location. You may then proceed
  to <a href="#usercert">user certificates</a>.</p>
<h3><a name="signhostcert"></a>3.2 Sign the host certificate</h3>
<ol>
  <li>As globus, run:
      <pre>grid-ca-sign -in hostcert_request.pem -out hostsigned.pem</pre>
  </li>
  <li>A signed host certificate, named <code>hostsigned.pem</code> is written
    to the current directory.</li>
  <li> When prompted for a passphrase, enter the one you specified in <a href="#passphrase">2.4
  Enter a passphrase</a> (for the private key of the CA certificate.)</li>
  <li>As root, move the signed host certificate to <code>/etc/grid-security/hostcert.pem</code>. </li>
</ol>
<p> The certificate should be owned by root, and read-only for other users. </p>
<p> The key should be read-only by root.</p>
<h2><a name="usercert"></a>4 User certificates</h2>
<p>Users also must request user certificates, which you will sign using the <code>globus</code>  user. </p>
<h3><a name="requsercert"></a>4.1 Request a user certificate</h3>
<p>As your normal user account (<strong>not</strong> <code>globus</code>), run:</p>
<pre>grid-cert-request</pre>
<p>After you enter a passphrase, this creates
<ul>
    <li><code>~$USER/.globus/usercert.pem</code> (empty)</li>
    <li><code>~$USER/.globus/userkey.pem</code></li>
    <li><code>~$USER/.globus/usercert_request.pem</code></li>
</ul>
  <p>Email the <code>usercert_request.pem</code> file to the SimpleCA maintainer. </p>
  <p><b>Note:</b> If you are using your own CA, follow their instructions about
    creating a usercert (one which has a commonName (<em>CN</em>) of your real
    name), then place the cert and key in the <code>~USER/.globus/</code> location.
    You may then proceed to <font color="purple">[verifying proxy creation???
    wait, does this paragraph belong here?]</font>.
  <h3><a name="signusercert"></a>4.2 Sign the user certificate</h3>
  <ol>
    <li>As the SimpleCA owner <code>globus</code>, run:
        <pre>grid-ca-sign -in usercert_request.pem -out signed.pem</pre>
    </li>
    <li>When prompted for a password, enter the one you specified in <a href="#passphrase">2.4
        Enter a passphrase</a> (for the private key of the CA certificate).</li>
    <li>Now send the signed copy (<code>signed.pem</code>) back to the user who
      requested the certificate.</li>
    <li>As your normal user account (<strong>not</strong> <code>globus</code>),
      copy the signed user certificate into <font face="Courier New"><code>~/.globus/</code></font> and
      rename it as <code>usercert.pem</code>, thus replacing the empty file. </li>
  </ol>
  <p>The certificate should be owned by the user, and read-only for other users. </p>
  <p>The key should be read-only by the owner.</p>
  <h2><a name="testcainstall"></a>5 Verify the SimpleCA certificate installation </h2>
  <p>To verify that the SimpleCA certificate is installed in <code>/etc/grid-security/certificates</code> and
    that your certificate is in place with the correct permissions, run:
<pre>user$ grid-proxy-init -debug -verify</pre>
<p>After entering your passphrase, successful output looks like:</p>
            <pre>
[bacon@mayed schedulers]$ grid-proxy-init -debug -verify

User Cert File: /home/user/.globus/usercert.pem
User Key File: /home/user/.globus/userkey.pem

Trusted CA Cert Dir: /etc/grid-security/certificates

Output File: /tmp/x509up_u1817
Your identity: /O=Grid/OU=GlobusTest/OU=simpleCA-mayed.mcs.anl.gov/OU=mcs.anl.gov/CN=User Name
Enter GRID pass phrase for this identity:
Creating proxy ..............................++++++++++++
...............++++++++++++
 Done
Proxy Verify OK
Your proxy is valid until: Sat Mar 20 03:01:46 2004</pre>
            <h2><a name="multiplemachines"></a>6 Configure SimpleCA for multiple
              machines </h2>
            <p>So far , you have a single machine configured with SimpleCA
              certificates. Recall that in <a href="#Finalizing">2.6
                Complete setup of  GSI</a> a
                CA setup package was created in <code>.globus/simpleCA/globus_simple_ca_HASH_setup-0.17.tar.gz</code>.
                If you want to use your certificates on another machine, you
                must install that CA setup package on that machine.             
            <p>To install it, copy that package to the second machine and run:
            <pre> $GLOBUS_LOCATION/sbin/gpt-build globus_simple_ca_HASH_setup-0.17.tar.gz gcc32dbg</pre>
            <p>Then you will have to perform <code>setup-gsi -default</code> from <a href="#signhostcert">4.2
                Sign the host certificate</a>.             
            <p>If you are going to run services on the second host, it will need
              its own <a href="#hostcert">host certificate</a>              and grid-mapfile (as described in the basic configuration instructions
              in <a href="index.html#authorization">5.4
              Add authorization</a>).
            <p>You may re-use your user certificates on the new host. You will
                need to copy the requests to the host where the SimpleCA was
                first installed in order to sign them.
<h2><a name="wheretogo"></a>7 Where to go from here </h2>
            <p>At this point, your SimpleCA certificate is configured and you
              are ready to continue your GT 4.0 basic configuration starting
              with <a href="index.html#perms">5.3
              Make the host credentials accessible by the container</a>.
                <!-- content ENDS here -->
            <h2>&nbsp;</h2>

<?php include("/mcs/www-unix.globus.org/include/globus_footer.inc"); ?>
