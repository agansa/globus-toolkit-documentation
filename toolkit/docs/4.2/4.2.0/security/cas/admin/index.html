<h1>GT4 CAS : System Administrator's Guide</h1>
<ul>
  <li><a href="#introduction">Introduction</a></li>
  <li> <a href="#installing">Building and Installing</a></li>
  <li><a href="#configuring">Configuring</a></li>
  <li><a href="#deploying">Deploying</a></li>
  <li><a href="#testing">Testing</a></li>
  <li><a href="#troubleshooting">Troubleshooting</a></li>
</ul>
<h2><a name="introduction"></a>Introduction</h2>

<p>This document contains information about deploying a CAS server
	and is not needed for a CAS client installation.</p>

<h2><a name="installing"></a>Building and Installing</h2>
<p>The CAS server is built and installed as part of a normal GT4
	installation.</p>

<h2><a name="configuring"></a>Configuring </h2>

<p>Information on configuration settings and environment variables can be found
  in the <a href="../WS_AA_CAS_Public_Interfaces.html">public interface guide</a>.</p>

<h2><a name="deploying"></a>Deploying</h2>
<h3> <a name="casCreds">Obtaining credentials for CAS server </a> </h3>

<p> The CAS service could run with its own set of credentials. Instructions
 to obtain service credentials may be found <a
 href="http://www.globus.org/gt2.2/admin/guide-verify.html#ldapcert">here</a>.

 <p> The standard administrator clients that come with the
 distribution can be used to perform host authorization and expect
 that the CAS service have credentials that have service name
 "cas". The command in the above mentioned webpage maybe altered as
 follows,
   
<pre>  casadmin$ grid-cert-request -service <i>cas</i> -host <i>FQDN</i><br></pre>
      
<p> These the certificate and private key are typically placed in
<i>/etc/grid-security/cas-cert.pem</i>
and <i>/etc/grid-security/cas-key.pem</i>, resepectively. In this
document, the location of certificate and key files is referred to as
CAS_CERT_FILE and CAS_KEY_FILE respectively.

<h3><a name="dbInstall">Database Install and Configuration </a> </h3>
  
CAS uses a backend database to store all user data. Any JDBC compliant
database may be used. This section describes briefly the installation
of such a database and the creation of database using schema required
for CAS backend.

<h4> Installing the Database </h4>

Any JDBC compliant database may be used. PostgreSQL has been used for
development and testing. The drivers for the same are included in the
distribution. If a different database is used, the corresponding
driver should be added to GLOBUS_LOCATION/lib

<p> Brief instructions to install a JDBC compliant database and
specifically PostGres can be found <a
href="http://www-unix.globus.org/toolkit/3.0/ogsa/docs/admin/installation.html">here</a>. For more detailed instructions, please refer to specific database
documentation.

<h4> Initializing the CAS database </h4>

<p> The schema of the database that needs to be created for CAS can be
 found at:
   

<p> GLOBUS_LOCATION/etc/databaseSchema/cas_database_schema.sql 
   
<p> To create a database, for example <i>casDatabase</i>, on a PostgreSQL
install on local machine,
    
<pre>  casadmin$ createdb casDatabase <br>  casadmin$ psql -U casadmin -d casDatabase -f GLOBUS_LOCATION/etc/databaseSchema/cas_database_schema.sql</pre>

<p> On running the above command, a list of notices will be seen on
the screen. Unless any of them say "ERROR", these are just output for
information.

<h4><a name="dbConfig"> CAS Database configuration file </a></h4> 

 CAS server requires to be configured with a properties file with
 database configuration information. A sample file has been provided
 in the distribution, GLOBUS_LOCATION/etc/casDBProperties. The values
 need to be modified to suit the particular database install.

 <ul>

     <li><i>dbDriver</i>: Name of the JDBC driver that will be used by
      the CAS install. The default value,
      <i>org.postgresql.Driver</i>, has been set to work with
      PostgreSQL and the driver is shipped with the distribution.
      </li>
     <li><i>dbConnectionURL</i>:   The  URL   to  make   the  database
       connection. For the example,
        <i>jdbc:postgresql://127.0.0.1/casDatabase</i></li>
     <li><i>dbUsername</i>: User name for database access. In this
     example, <i>casadmin</i></li>
     <li><i>dbPassword</i>: Password for the above user</li>

 </ul>
      
<b>Note: Since this file contains the database access username and
password, set appropriate permissions to protect the file. </b>


<h2><a name="testing"></a>Testing</h2>

<p> CAS has two sets of tests, one for the backend database access
module and another set to test the service itself. To install both
tests, the CAS test package
(<i>gt4-cas-delegation-test-3.9-src_bundle.tar.gz</i>) needs to be
installed using GPT <b>FILLME: instructions </b> into
<i>GLOBUS_LOCATION</i>.</p>

<p> It is assumed thet a backend database has been set up and
configured and that CAS service and tests are installed in
<i>$GLOBUS_LOCATION</i>. The sample commands assume that the service
is running on localhost and port 8080, and that the database is set up
with a) username as tester, b) database name as casDatabase, c) host as
foo.bar.gov and default port.</p>

<ul>
<li> Testing backend database module
<ul>
<li> cd $GLOBUS_LOCATION
<li> The file <i>etc/globus_cas_unit_test/casTestProperties</i> needs to be populated with database configuration information.

<a name="testDbConfig"></a><table>
<tr><td>dbDriver </td><td> The JDBC driver to be used</td></tr>
<tr><td>dbConnectionURL </td><td> JDBC connection url to be used to connect to database</td></tr>
<tr><td>dbUsername </td><td> user name to connect to database as</td></tr>
<tr><td>dbPassword </td><td> database password for the said username </td></tr>
</table>

<li> The database needs to be empty for these tests to work. To delete
all the data in the database the following can be used:

<pre>psql -d casDatabase -U tester -h foo.bar.gov -f etc/globus_cas_utils/database_delete.sql </pre>
<li> ant -f share/globus_cas_unit_test/cas-test-build.xml testDatabase
<li> Test reports are palced in $GLOBUS_LOCATION/share/globus_cas_unit_test/cas-test-reports
</ul>
<li> Testing CAS service module

<p> These tests can be set up so as to be able to test multiple user
scenario or it can be configured to run just as a single identity. The first set of tests are used to test admin functionality and sets up the database for second user. As the second user the permissions and queries are tested to ensure that the set up worked.</p>

<p> All the configuraiton information for the test, needs to be
configured in
<i>etc/globus_cas_unit_test/casTestProperties</i> file. The database
section of the properties file needs to be configured as described <a
href="testDbConfig">here</a>. Other than those, the following
properties also need to be configured for these tests:</p>

<table>
<tr><td>user1SubjectDN</td><td> The DN of the user running the first
set of tests.</td></tr>
<tr><td>user2SubjectDN</td><td> The DN of the user running the second
set of tests. Can be the same as previous property</td></tr>
<tr><td>maxAssertionLifetime</td><td> Should match the value set in
service configuration as shown in <a
href="./../WS_AA_CAS_Public_Interfaces.html#config">Configuration
information</a></td></tr> </table>

<p> Steps for testing:</p>

<ol>
<li> cd $GLOBUS_LOCATION

<li> The database needs to be empty for these tests to work. To delete
all the data in the database the following can be used:

<pre>psql -d casDatabase -U tester -h foo.bar.gov -f etc/globus_cas_utils/database_delete.sql </pre>

<li> In the test properties file, set <i>user2SubjectDN</i> to be the
subject in your regular proxy. The following returns the appropriate
string

<pre>  casadmin$ bin\grid-cert-info -subject -globus</pre>

<li> Generated an independent proxy using the following command. 
    
<pre>  casadmin$ bin\grid-proxy-init -independent<br></pre>

<li> Set the identity in the proxy generated from the above step as
<i>user1SubjectDN</i> in the test properties file. The following
command will return the relevant string.

<pre>  casadmin$ java org.globus.tools.ProxyInfo -subject -globus</pre>

<li> Start a container on port, say testPort and host, hostPort.

<li> The following command, runs tests for self permissions and sets up the database for user with subjectDN that is user2SubjectDN. 
            
<pre>  casadmin$ ant -f share/globus_cas_unit_test/cas-test-build.xml -Dtest.port=testPort -Dtest.host=testHost user1TestService</pre>

<li> To test as the second user, generate proxy for the subject DN specified for the second user.

    <pre>  casadmin$ bin/grid-proxy-init <br></pre></li>

<li> To test as second user, run the following. If you are not running container on default host/port, set properties as shown <a href="#testParams">here.</a>

    <pre>  casadmin$ ant -f share/globus_cas_unit_test/cas-test-build.xml -Dtest.port=testPort -Dtest.host=testHost user2TestService</pre>

<li> Test reports are palced in $GLOBUS_LOCATION/share/globus_cas_unit_test/cas-test-reports

<li>After these tests, the CAS database needs to be reset. The following
command will delete all entries from the database.

<pre> casadmin$ psql -U casadmin -d casDatabase -f GLOBUS_LOCATION/share/cas/database_delete.sql<br></pre>

</li>
</ul>

<h2><a name="troubleshooting"></a>Troubleshooting</h2>
<p><font color="purple">[help for common problems sysadmins may experience] </font></p>
