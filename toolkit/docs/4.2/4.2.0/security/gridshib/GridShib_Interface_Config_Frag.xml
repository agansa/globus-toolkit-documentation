<?xml version='1.0' encoding='UTF-8'?>
<!DOCTYPE chapter PUBLIC "-//OASIS//DTD DocBook XML V4.4//EN"
"http://www.oasis-open.org/docbook/xml/4.4/docbookx.dtd">

  <chapter id="gridshib-configuring" xreflabel="Configuring GridShib">
    <title>Configuring </title>
    <para>
      GridShib provides the <varname>GridShibPDP</varname> interceptor, and configuring GridShib involves placing this PDP into the authorization interceptor chain of the container or service you wish to protect. For details of configuring security interceptors, see the <olink targetdoc="wsaajava-secdesc">Java WS Security Descriptor Framework documentation</olink>, specifically the <olink targetdoc="wsaajava-secdesc-configAuthz">Configuring authorization mechanisms section</olink>.
    </para>

    <section id="gridshib-configuring-server-config">
      <title>GridShib configuration options</title>
      <para>
	GridShib supports the following configuration options in the <filename>server-config.wsdd</filename> file. If you are deploying GridShib for a specific service, you should edit thats service's configuration (e.g. <filename>$GLOBUS_LOCATION/etc/gram-service/server-config.wsdd</filename> for GRAM). If you are deploying GridShib at the container level then... (XXX)
      </para>
      <para>
	<table>
	  <title>GridShib configuration options</title>
	  <tgroup cols="2">
	    <thead>
	      <row>
		<entry>Variable</entry>
		<entry>Usage</entry>
	      </row>
	    </thead>
	    <tbody>
	      <row>
		<entry>metadataPath</entry>
		<entry>Specify the path to the <link linkend="gridshib-configuring-metadata-directory">metadata directory</link>.</entry>
	      </row>
	      <row>
		<entry>enableBlacklisting</entry>
		<entry>Enables <link linkend="gridshib-configuring-ip-addr-blacklisting">blacklisting</link>. Should be <literal>true</literal> or <literal>false</literal>.</entry>
	      </row>
	      <row>
		<entry>blacklistIPAddressFile</entry>
		<entry>Path to file containing <link linkend="gridshib-configuring-ip-addr-blacklisting">blacklisted IP addresses</link>. (XXX Add link)</entry>
	      </row>
	      <row>
		<entry>consultDefaultGridmap</entry>
		<entry>(???)</entry>
	      </row>
	      <row>
		<entry>gridshibAuthzPolicyFile</entry>
		<entry>Path to <link linkend="gridshib-configuring-authz-policy">authorization policy file</link>.</entry>
	       </row>
	       <row>
		 <entry>samlMapPolicy</entry>
		 <entry>(???)</entry>
	       </row>
	       <row>
		 <entry>useVOMS</entry>
		 <entry>(???)</entry>
	       </row>
	       <row>
		 <entry>enableAttributeQuery</entry>
		 <entry>(???)</entry>
	       </row>
	     </tbody>
	   </tgroup>
	 </table>
       </para>
       <para>
	 <example>
	   <title>Example GridShib Container Configuration</title>
	   <screen>
	     <![CDATA[
<containerSecurityConfig xmlns="http://www.globus.org/security/descriptor/container" 
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" 
  xsi:schemaLocation="http://www.globus.org/security/descriptor 
  name_value_type.xsd"
  xmlns:param="http://www.globus.org/security/descriptor">
   <authzChain>
     <pdps>
       <interceptor name="gridshib:org.globus.gridshib.GridShibPDP">
                    <parameter>
                        <param:nameValueParam>
                            <param:parameter name="metadataPath"
                                            value="/etc/grid-security/metadata"/>
                        </param:nameValueParam>
                    </parameter>
                    <parameter>
                        <param:nameValueParam>
                            <param:parameter name="enableBlacklisting"
                                            value="true"/>
                        </param:nameValueParam>
                    </parameter>
                    <parameter>
                        <param:nameValueParam>
                            <param:parameter name="blacklistIPAddressesFile"
                                            value="/etc/grid-security/blacklists/blacklist-ip-addresses.txt"/>
                        </param:nameValueParam>
                    </parameter>
                    <parameter>
                        <param:nameValueParam>
                            <param:parameter name="consultDefaultGridmap"
                                            value="false"/>
                        </param:nameValueParam>
                    </parameter>
                    <parameter>
                        <param:nameValueParam>
                            <param:parameter name="gridshibAuthzPolicyFile"
                                            value="/etc/grid-security/policy/core-authz-policy.xml"/>
                        </param:nameValueParam>
                    </parameter>
           </interceptor>
	</pdps>
    </authzChain>
</containerSecurityConfig>
	     ]]>
	   </screen>
	 </example>
       </para>
     </section>
     <section id="gridshib-configuring-metadata-directory">
       <title>The Metadata Directory</title>
       <para>The metadata directory currently contains a single file, <filename>trusted-authorities-entity-map.txt</filename>, which contains information about trusted attribute authorities.  Each line of this file contains an entityID followed by a DN, separated by one or more whitespace characters.  If the DN contains whitespace, it must be quoted.  (A URI must not contain whitespace characters, so it need not be quoted.)</para>
       <para>The suggested path for this directory is <filename>/etc/grid-security/metadata/</filename>.</para>
       <para>
	 <example>
	   <title>Example Trusted Authorities Entity Map File</title>
	   <screen>
# GridShib CA:
https://test-sp.ncsa.uiuc.edu/shibboleth "CN=GridShib CA,O=Certificate Authority,DC=computer,DC=ncsa,DC=uiuc,DC=edu"

# Community Test Account:
https://gridshib.example.org/idp "CN=AAA Testbed Community User,O=National Center for Supercomputing Applications,C=US"
	   </screen>
	 </example>
       </para>
     </section>
     <section id="gridshib-configuring-authz-policy">
       <title>The Authorization Policy File</title>
       <para>(??? What does this do ???)</para>
       <para>
	 <example>
	   <title>Example Authorization Policy File</title>
	   <screen>
	     <![CDATA[
<AttributePolicy
   xmlns="http://gridshib.globus.org/namespaces/2005/08/policy"
   xmlns:saml="urn:oasis:names:tc:SAML:1.0:assertion">
   <!-- empty policy -->
</AttributePolicy>
	     ]]>
	   </screen>
	 </example>
       </para>
     </section>
     <section id="gridshib-configuring-ip-addr-blacklisting">
       <title>IP Address Blacklist File</title>
       <para>
	 The IP address blacklist file contains a list of IP addresses, one per line, which should be denied access.
       </para>
       <para>
	 <example>
	   <title>Example Blacklisted IP Address Files</title>
	   <screen>
# Blacklist of IP addresses
#
# This file contains a list of IP addresses, one per line.
111.111.111.111
	   </screen>
	 </example>
       </para>
     </section>
 
  </chapter>
