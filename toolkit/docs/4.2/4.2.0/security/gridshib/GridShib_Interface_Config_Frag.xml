<?xml version='1.0' encoding='UTF-8'?>
<!DOCTYPE chapter PUBLIC "-//OASIS//DTD DocBook XML V4.4//EN"
"http://www.oasis-open.org/docbook/xml/4.4/docbookx.dtd">

  <chapter id="gridshib-configuring" xreflabel="Configuring GridShib">
    <title>Configuring </title>
    <para>
      GridShib consists of a hierarchy of interceptors, a set of low-level intercepts which implement specific functions and then a set of combining interceptors which combine and orchestrate the low-level intereptors to perform common functionality. Most of the time, the <varname>GridShibPDP</varname> combined interceptor will do what you want, but it is possible to combine the low-level interceptors in unique ways to perform custom logic. Most of this configuration guide assumes you are using the <varname>GridShibPDP</varname> interceptor except where explicitly noted.
    </para>
    <section id="gridshib-configuring-server-config">
      <title>GridShib configuration options</title>
      <para>
	GridShib supports the following configuration options in the <filename>server-config.wsdd</filename> file. If you are deploying GridShib for a specific service, you should edit thats service's configuration (e.g. <filename>$GLOBUS_LOCATION/etc/gram-service/server-config.wsdd</filename> for GRAM). If you are deploying GridShib at the container level then... (XXX)
      </para>
      <para>
	<table>
	  <title>GridShib configuration options</title>
	  <tgroup cols="2">
	    <thead>
	      <row>
		<entry>Variable</entry>
		<entry>Usage</entry>
	      </row>
	    </thead>
	    <tbody>
	      <row>
		<entry>metadataPath</entry>
		<entry>Specify the path to the <link linkend="gridshib-configuring-metadata-directory">metadata directory</link>.</entry>
	      </row>
	      <row>
		<entry>enableBlacklisting</entry>
		<entry>Enables <link linkend="gridshib-configuring-ip-addr-blacklisting">blacklisting</link>. Should be <literal>true</literal> or <literal>false</literal>.</entry>
	      </row>
	      <row>
		<entry>blacklistIPAddressFile</entry>
		<entry>Path to file containing <link linkend="gridshib-configuring-ip-addr-blacklisting">blacklisted IP addresses</link>. (XXX Add link)</entry>
	      </row>
	      <row>
		<entry>consultDefaultGridmap</entry>
		<entry>(???)</entry>
	      </row>
	      <row>
		<entry>gridshibAuthzPolicyFile</entry>
		<entry>Path to <link linkend="gridshib-configuring-authz-policy">authorization policy file</link>.</entry>
	       </row>
	     </tbody>
	   </tgroup>
	 </table>
       </para>
       <para>
	 <example>
	   <title>Example GridShib Configuration in <filename>server-config.wsdd</filename></title>
	   <screen>
	     <![CDATA[
<deployment name="defaultServerConfig" ...>
    <globalConfiguration>
        ...
        <parameter name="containerSecDesc"
            value="etc/globus_wsrf_core/global_security_descriptor.xml"/>

        <!-- add the following GridShib config params -->

        <parameter name="global-metadataPath"
            value="/etc/grid-security/metadata"/>

        <parameter name="global-enableBlacklisting" value="true"/>

        <parameter name="global-blacklistIPAddressesFile"
            value="/etc/grid-security/blacklists/blacklist-ip-addresses.txt"/>

        <parameter name="global-consultDefaultGridmap" value="false"/>

        <parameter name="global-gridshibAuthzPolicyFile"
            value="/etc/grid-security/policy/core-authz-policy.xml"/>
        ...b
    </globalConfiguration>
    ...
</deployment>
	     ]]>
	   </screen>
	 </example>
       </para>
     </section>
     <section id="gridshib-configuring-metadata-directory">
       <title>The Metadata Directory</title>
       <para>The metadata directory currently contains a single file, <filename>trusted-authorities-entity-map.txt</filename>, which contains information about trusted attribute authorities.  Each line of this file contains an entityID followed by a DN, separated by one or more whitespace characters.  If the DN contains whitespace, it must be quoted.  (A URI must not contain whitespace characters, so it need not be quoted.)</para>
       <para>The suggested path for this directory is <filename>/etc/grid-security/metadata/</filename>.</para>
       <para>
	 <example>
	   <title>Example Trusted Authorities Entity Map File</title>
	   <screen>
# GridShib CA:
https://test-sp.ncsa.uiuc.edu/shibboleth "CN=GridShib CA,O=Certificate Authority,DC=computer,DC=ncsa,DC=uiuc,DC=edu"

# Community Test Account:
https://gridshib.example.org/idp "CN=AAA Testbed Community User,O=National Center for Supercomputing Applications,C=US"
	   </screen>
	 </example>
       </para>
     </section>
     <section id="gridshib-configuring-authz-policy">
       <title>The Authorization Policy File</title>
       <para>(???)</para>
       <para>
	 <example>
	   <title>Example Authorization Policy File</title>
	   <screen>
	     <![CDATA[
<AttributePolicy
   xmlns="http://gridshib.globus.org/namespaces/2005/08/policy"
   xmlns:saml="urn:oasis:names:tc:SAML:1.0:assertion">
   <!-- empty policy -->
</AttributePolicy>
	     ]]>
	   </screen>
	 </example>
       </para>
     </section>
     <section id="gridshib-configuring-ip-addr-blacklisting">
       <title>IP Address Blacklist File</title>
       <para>
	 The IP address blacklist file contains a list of IP addresses, one per line, which should be denied access.
       </para>
       <para>
	 <example>
	   <title>Example Blacklisted IP Address Files</title>
	   <screen>
# Blacklist of IP addresses
#
# This file contains a list of IP addresses, one per line.
111.111.111.111
	   </screen>
	 </example>
       </para>
     </section>
     
    <section id="gridshib-configuring-low-level-interceptors">
      <title>GridShib Low-level Interceptors</title>
      <para>
	The following are low-level interceptors provided by GridShib.
      </para>
      <para>
	<variablelist>
	  <varlistentry>
	    <term>SAMLAssertionPushPIP</term>
	    <listitem><para>This PIP <ulink url="http://dev.globus.org/wiki/SAML_in_X.509_Validation#Walking_the_Certificate_Chain">walks the certificate chain</ulink> presented by the requester, extracts any SAML assertions bound to the certificates in the chain, and updates the security context with the security information extracted from the bound assertions. </para></listitem>
	  </varlistentry>
	  <varlistentry>
	    <term>AttributeAcceptancePIP</term>
	    <listitem><para>Iterates over the attributes in the security context and filters those attributes that do not satisfy Attribute Acceptance Policy. </para></listitem>
	  </varlistentry>
	  <varlistentry>
	    <term>SAMLAttributePDP</term>
	    <listitem><para>Makes an access control decision based on attributes from the user's security context. Renders either a PERMIT decision or NOT APPLICABLE decision (never DENY). <note><para>In GT4.0.x, NOT APPLICABLE equals DENY.</para></note></para></listitem>
	  </varlistentry>
	  <varlistentry>
	    <term>SAMLBlacklistPDP</term>
	    <listitem><para>Makes an access control decision based on authentication context and attributes from the user's security context. Renders either a DENY decision or NOT APPLICABLE decision (never PERMIT). <note><para>In GT4.0.x, NOT APPLICABLE equals PERMIT.</para></note></para></listitem>
	  </varlistentry>
	  <varlistentry>
	    <term>SAMLQueryPIP</term>
	    <listitem><para>Queries a SAML Attribute Authority and updates the security context with the resulting attributes. </para></listitem>
	  </varlistentry>
	  <varlistentry>
	    <term>SAMLMapPIP</term>
	    <listitem><para>Maps attributes from the user's security context into one or more local accounts (similar to grid-mapfile but based on SAML attributes instead of DNs). Updates the security context with this mapping information. </para></listitem>
	  </varlistentry>
	</variablelist>
      </para>
    </section>

  </chapter>
