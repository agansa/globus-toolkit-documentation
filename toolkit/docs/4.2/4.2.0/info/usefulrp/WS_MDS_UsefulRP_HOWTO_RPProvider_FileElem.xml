<?xml version='1.0' encoding='UTF-8'?>
<!DOCTYPE article PUBLIC "-//OASIS//DTD DocBook XML V4.4//EN"
"http://www.oasis-open.org/docbook/xml/4.4/docbookx.dtd"
[

<!ENTITY % myents SYSTEM "../../entities">

%myents;

]>
<article>
<title>GT &shortversion; Index Service: How to Write a File
Element producer using the RPProvider Framework in MDS4</title>
<titleabbrev>Writing a File Element Information Provider</titleabbrev>

<!-- 
<para> This howto was written by <ulink
url="http://www.thecodefactory.org/neillm">Neill Miller</ulink> under
the guidance of <ulink
url="http://www-unix.mcs.anl.gov/~schopf/">Jennifer
Schopf</ulink>.</para>
 -->

<section id="usefulrp-howto-fileelement-intro"><title>Introduction</title>

<para>
This document is intended to be a starting guide to writing one of the
simplest kinds of <glossterm baseform="information
provider">information providers</glossterm> for the MDS4 using the
RPProvider Framework.  It covers the concepts and walks through a
simple example of how to get arbitrary information into the MDS4 using
the File Element producer.  This File Element producer is part of the
RPProvider Framework and is used for storing arbitrary XML information
by pulling in the static contents from a file.  This is mostly useful
for scenarios where you would like to publish static information into
the MDS4.
</para>

<para>
This document covers writing a simple information provider that takes
the contents of a Message Of The Day (MOTD) file and stores it in the
MDS4's <glossterm>Index Service</glossterm>.  While the XML data
stored in the file is static, the MDS4 will check it periodically and
pull in any changes so that it works in some sense, like a logging
system as well.  This example was chosen because it is dynamic and
simple, yet it illustrates all the fundamentals of this type of
information provider.
</para>

</section>

<section id="usefulrp-howto-fileelement-schema"><title>Choosing (or conforming to) a Schema</title>

<para>
The first step to getting information into the MDS4 is to decide which
information you would like to have published.  Since the data is in
XML format, you should choose (or pick) the schema that you'd like the
data to conform to.  This generally means coming up with element names
and types and creating some mapping of the data you're about to
retrieve from the MOTD file before putting it in to the MDS4.  For
this example, I'm going to choose this very simple format for the
data:
</para>

<screen>
&lt;myns:MOTD xmlns:myns="http://myorg.ns.for.testing"&gt;

  &lt;myns:MessageEntry myns:Status="STATUS"&gt;
    &lt;myns:DateEntered&gt;START DATE&lt;/myns:DateEntered&gt;
    &lt;myns:DateValidUntil&gt;END DATE&lt;/myns:DateValidUntil&gt;
    &lt;myns:Content&gt; ... content here ... &lt;/myns:Content&gt;
  &lt;/myns:MessageEntry&gt;

  &lt;myns:MessageEntry myns:Status="STATUS"&gt;
     ... another message can be here ...
  &lt;/myns:MessageEntry&gt;

&lt;/myns:MOTD&gt;
</screen>


<para>As you can see, that format is very simple.  An example output
will look like this:</para>

<screen>
&lt;myns:MOTD>
  &lt;myns:MessageEntry myns:Status="Urgent"&gt;
    &lt;myns:DateEntered&gt;Wed Nov 15 10:38:25 CST 2006&lt;/myns:DateEntered&gt;
    &lt;myns:DateValidUntil&gt;Wed Nov 15 11:38:25 CST 2006&lt;/myns:DateValidUntil&gt;
    &lt;myns:Content&gt;
    URGENT:  It has come to our attention that a disk in the BBX
    machine is failing and we will be replacing it within the hour.
    Sorry for the inconvenience.
    -- Your friendly Systems Staff (systems@foo.org)
    &lt;/myns:Content&gt;
  &lt;/myns:MessageEntry&gt;
&lt;/myns:MOTD&gt;
</screen>

<para>
Once you've chosen how to represent your data in XML format, you can
start thinking about how you're going to retrieve and prepare that
data for publication.  For this kind of information provider, the most
common scenarios of getting the formatted XML data into a file
published to the Index Service is either by editing it by hand, or by
having it auto-generated by some kind of script.  For this example, we
will assume hand edits are done by a System's person with adequate
permissions to the MOTD file.
</para>


</section>

<section id="usefulrp-howto-fileelement--code"><title>The File</title>

<para>
The second step to getting information into the MDS4 is to write a
file that contains the appropriate data.  For this example, we've
provided a sample file that you can download and test.  After you've
verified that it's all working, feel free to modify the file as you
see fit.
</para>

<para>
Download the sample file: <ulink url="motd.xml">motd.xml</ulink>.
</para>

<para>
This file could be saved in your
<emphasis>$GLOBUS_LOCATION/etc</emphasis> directory, although if
you feel more comfortable placing it somewhere else on your file
system, it's ok to do so.  For this example, we will assume it's
located at the suggested location.
</para>
</section>

<section id="usefulrp-howto-fileelement--enabling"><title>Enabling The Provider</title>

<para>
Now that we have the data for publication, the next step is to
enable it so that we can test it.  To do this you will need to do a
few things.  First, enable the RPProvider framework (if it's not
already).  Second, enable the MOTD Provider that we've just
prepared, and finally restart your container to view the new
information.
</para>

<section><title>Enable the RPProvider framework</title>

<para>
It's possible that your Globus Toolkit installation already has the
RPProvider framework enabled.  This section shows you how to verify if
it is, and what to do if it is not.  To do this, you will need to edit the
<filename>$GLOBUS_LOCATION/etc/globus_wsrf_mds_index/server-config.wsdd</filename> file.
</para>

<para>
You should see an <emphasis>DefaultIndexService Handler</emphasis> section that looks
something like this:
<screen>
&lt;service name="DefaultIndexService" provider="Handler"
     use="literal" style="document"&gt;
     &lt;parameter name="providers"
                value="org.globus.wsrf.impl.servicegroup.ServiceGroupRegistrationProvider
                       org.globus.mds.usefulrp.rpprovider.ResourcePropertyProviderCollection
                       GetRPProvider
                       GetMRPProvider
                       QueryRPProvider
                       DestroyProvider
                       SetTerminationTimeProvider
                       SubscribeProvider
                       GetCurrentMessageProvider"/&gt;

     &lt;parameter name="handlerClass"
         value="org.globus.axis.providers.RPCProvider"/&gt;
     &lt;parameter name="scope" value="Application"/&gt;
     &lt;parameter name="allowedMethods" value="*"/&gt;
     &lt;parameter name="rpProviderConfigFile"
         value="/etc/globus_wsrf_mds_usefulrp/rp-provider-config.xml"/&gt;
     &lt;parameter name="className"
         value="org.globus.mds.index.impl.DefaultIndexService"/&gt;
     &lt;wsdlFile&gt;share/schema/mds/index/index_service.wsdl&lt;/wsdlFile&gt;
&lt;/service&gt;
</screen>
</para>

<para>
If the DefaultIndexService <emphasis>Handler</emphasis> section
doesn't look like this, cut and paste the above and replace the
existing Handler section for the DefaultIndexService.  The two key
distinctions are in the <emphasis>providers</emphasis> value section that has the line
<emphasis>org.globus.mds.usefulrp.rpprovider.ResourcePropertyProviderCollection</emphasis>
and the <emphasis>rpProviderConfigFile</emphasis> value.  This latter
value can be anything you want (relative to the system's
<filename>$GLOBUS_LOCATION</filename>), but this document assumes the
value that's specified above.
</para></section>

<section><title>Enable the MOTD Provider</title>

<para>
This step involves editing the
<filename>$GLOBUS_LOCATION/etc/globus_wsrf_mds_usefulrp/rp-provider-config.xml</filename>
file that was specified in the above step.  It can be a different
file, but you will have to adjust the value in the above step to
change it here.  For now, we're assuming that it's left as the
default.  If this file doesn't already exist, feel free to copy the
sample file located at
<filename>$GLOBUS_LOCATION/etc/globus_wsrf_mds_usefulrp/gluece-rpprovider-sample-config.xml</filename>
to
<filename>$GLOBUS_LOCATION/etc/globus_wsrf_mds_usefulrp/rp-provider-config.xml</filename>
and start editing from there.
</para>

<para>
To enable the MOTD provider, you will need to add a config block
that looks like this:

<screen>
&lt;ns1:resourcePropertyProviderConfiguration xsi:type="ns1:resourcePropertyProviderConfig"&gt;
 &lt;ns1:resourcePropertyName xsi:type="xsd:QName" xmlns:myns="http://myorg.ns.for.testing"&gt;myns:MOTD&lt;/ns1:resourcePropertyName&gt;
 &lt;ns1:resourcePropertyImpl xsi:type="xsd:string"&gt;org.globus.mds.usefulrp.rpprovider.SingleValueResourcePropertyProvider&lt;/ns1:resourcePropertyImpl&gt;
 &lt;ns1:resourcePropertyElementProducers xsi:type="ns1:resourcePropertyElementProducerConfig"&gt;
   &lt;ns1:className xsi:type="xsd:string"&gt;org.globus.mds.usefulrp.rpprovider.producers.FileElementProducer&lt;/ns1:className&gt;
   &lt;ns1:arguments xsi:type="xsd:string"&gt;/PATH/TO/GLOBUS_LOCATION/etc/motd.xml&lt;/ns1:arguments&gt;
   &lt;ns1:period xsi:type="xsd:int"&gt;120&lt;/ns1:period&gt;
 &lt;/ns1:resourcePropertyElementProducers&gt;
&lt;/ns1:resourcePropertyProviderConfiguration&gt;
</screen>
</para>

<para>
As you can see, there are a number of configurable parameters there
such as the name of the RP that the data will be published as, the
location of the MOTD file (motd.xml), as well as the period at which
it will be checked for updates and refreshed.  Feel free to edit those
as necessary.  In this example, any updates to the file will appear in
the Index Service within 2 minutes (120 seconds).  This should
generally be sufficient for hand edited updates, but of course it can
be configured to suit your needs.
</para>

<para>
At this point, the MOTD provider has been enabled for use with the
RPProvider framework!  As you can see, this framework simplifies much
of the work of details of getting information into the IndexService.
Simply restart the container and make sure there are no errors.  If
errors are reported, please check over all of the above steps and make
sure that they were completed successfully.  It's very easy to make
unexpected typos!
</para>
</section>
</section>

<section id="usefulrp-howto-fileelement-example"><title>An Example Query</title>

<para>
<screen>
neillm@macglob /usr/local/gt-current/bin $ ./wsrf-query -s
http://127.0.0.1:20202/wsrf/services/DefaultIndexService "//*[local-name()='MOTD']"

&lt;myns:MOTD xmlns:myns="http://myorg.ns.for.testing"&gt;

  &lt;myns:MessageEntry myns:Status="Urgent"&gt;
    &lt;myns:DateEntered&gt;Wed Nov 15 10:38:25 CST 2006&lt;/myns:DateEntered&gt;
    &lt;myns:DateValidUntil&gt;Wed Nov 15 11:38:25 CST
    2006&lt;/myns:DateValidUntil&gt;
    &lt;myns:Content&gt;
    URGENT:  It has come to our attention that a disk in the BBX
    machine is failing and we will be replacing it within the hour.
    Sorry for the inconvenience.
    -- Your friendly Systems Staff (systems@foo.org)
    &lt;/myns:Content&gt;
  &lt;/myns:MessageEntry&gt;

  &lt;myns:MessageEntry myns:Status="Normal"&gt;
    &lt;myns:DateEntered&gt;Tue Nov 14 10:00:25 CST 2006&lt;/myns:DateEntered&gt;
    &lt;myns:DateValidUntil&gt;--&lt;/myns:DateValidUntil&gt;
    &lt;myns:Content&gt;
    Free donuts in the Coffee Room!  Come one, Come All!!  Get 'em
    while they're hot!
    -- Bob (bob@foo.org)
    &lt;/myns:Content&gt;
  &lt;/myns:MessageEntry&gt;

&lt;/myns:MOTD&gt;
</screen>
</para>

<para>
This segment of the query output represents the MOTD data we've
just written and configured for use.  As you can see the
<emphasis>MOTD</emphasis> block was properly published into the Index
Service since it's now been properly configured!
</para>
</section>

<section id="usefulrp-howto-fileelement--contact"><title>Contact the author</title>
<para>Contact the author at <ulink url="mailto:neillm@mcs.anl.gov">neillm@mcs.anl.gov</ulink>.</para>
</section>
</article>