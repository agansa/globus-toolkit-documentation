<?xml version='1.0' encoding='UTF-8'?>
<!DOCTYPE chapter PUBLIC "-//OASIS//DTD DocBook XML V4.4//EN"
"http://www.oasis-open.org/docbook/xml/4.4/docbookx.dtd">

  <chapter id="gram4-migrating-gt40">
    <title>Migrating GRAM from GT4.0</title>
      <para>The <replaceable role="entity">version</replaceable>
      protocol has been changed to be WSRF 1.2, WSN 1.3 and WS Addressing
      1.0 compliant. There is no backward compatibility between
      <replaceable role="entity">version</replaceable> and 4.0.</para>

<section> <title>Admin - Migration Guide</title>

  <section id="gram4-admin-migrating-gt4-default-lrm">
    <title>Default local resource manager</title>
    <para>
      In GRAM4 an administrator can configure a default local resource manager
      being used for job submission if the client did not specify any in a job
      submission request. Check section <olink targetdoc="gram4Admin"
      targetptr="gram4-Interface_Config_default-lrm">Defining a default local
      resource manager</olink> in the <olink targetdoc="gram4Admin">System
      Administrator's Guide</olink> for more information.
    </para>
  </section>

  <section id="gram4-admin-migrating-gt4-audit">
    <title>Audit Logging</title>
    <para>
      The log4j configuration for audit logging in GRAM4 in 4.2 is slightly
      different compared to the 4.0 series. This involves log4j and database
      configuration changes. For the log4j configuration check section
      section <olink targetdoc="gram4Admin"
      targetptr="gram4-audit-logging-config-log4j">Configure Log4j</olink> in the
      <olink targetdoc="gram4Admin">System Administrator's Guide</olink> for more
      information. For the database related changes check
      <olink targetdoc="gram4Admin"
      targetptr="gram4-audit-logging-config-database">Configure the Database in
      JNDI</olink> in the <olink targetdoc="gram4Admin">System
      Administrator's Guide</olink>.
    </para>
  </section>

  <section id="gram4-admin-migrating-gt4-lifetime">
    <title>Job lifetime</title>
    <para>
      An administrator can configure lifetime parameters for all jobs in GRAM4's
      JNDI configuration. In short these parameters restrict the maximum lifetime
      a client can set on a job, and the maximum time a job is kept in the container
      and thus in the persistence directory after the job had been fully processed.
      Check section <olink targetdoc="executionKey"
      targetptr="execution-approach-lifetime">Job Lifetime</olink> in the
      <olink targetdoc="executionKey">Execution key concepts</olink> and section
      <olink targetdoc="gram4Admin" targetptr="gram4-Interface_Config_lifetime">Job
      lifetime configuration </olink> in the <olink targetdoc="gram4Admin">System
      Administrator's Guide</olink> for more information.
    </para>
  </section>

  <section id="gram4-admin-migrating-gt4-li">
    <title>Local invocations from GRAM4 to RFT</title>
    <para>
      By default GRAM4 in the 4.0 series does Web Service invocations when
      calling RFT to perform staging and file cleanup. The default in GRAM4 in 
      4.2 is local java calls to improve performance in jobs with staging and
      file cleanup. If GRAM4 is configured to use RFT in a separate machine
      local invocations are disabled.
    </para>
  </section>

  <section id="gram4-admin-migrating-gt4-seg-threadpool">
    <title>Threads for SEG event processing</title>
    <para>
      An administrator can configure the number of threads in the thread-pool that
      is responsible for handling scheduler events. The default size should be fine
      for all Scheduler Event Generators (SEGs) provided by Globus. It might be
      interesting for custom written SEGs. Check section
      <olink targetdoc="gram4Admin" targetptr="gram4-Interface_Config_threadpools">Configuring
      thread-pools</olink> in the <olink targetdoc="gram4Admin">System
      Administrator's Guide</olink> for more information.
    </para>
  </section>

</section>

<section> <title>User - Migration Guide</title>

  <section id="gram4-user-migrating-gt4-specupgrade">
    <title>Job description changes</title>
    <para>
      Due to the WSRF, WSN and WS-Adressing specification upgrade some
      namespaces changed. All occurences of the following namespaces must be
      updated to the new namespaces:
      <informaltable><tgroup cols="2">
      <thead>
        <row>
          <entry>4.0</entry>
          <entry>4.2</entry>
        </row>
      </thead>
      <tbody>
        <row>
          <entry><para>http://schemas.xmlsoap.org/ws/2004/03/addressing</para></entry>
          <entry><para>http://www.w3.org/2005/08/addressing</para></entry>
        </row>
        <row>
          <entry><para>http://www.globus.org/namespaces/2004/10/gram/job</para></entry>
          <entry><para>http://www.globus.org/namespaces/2008/03/gram/job</para></entry>
        </row>
        <row>
          <entry><para>http://www.globus.org/namespaces/2004/10/rft</para></entry>
          <entry><para>http://www.globus.org/namespaces/2008/04/rft</para></entry>
        </row>
      </tbody>
      </tgroup></informaltable>
      Additionally the ReferenceProperties element must be renamed to
      ReferenceParameters.
    </para>
    <para>
      In a job description the following elements are involved:
      <itemizedlist>
        <listitem><para>factoryEndpoint</para></listitem>
        <listitem><para>jobCredentialEndpoint</para></listitem>
        <listitem><para>stagingCredentialEndpoint</para></listitem>
        <listitem><para>fileStageIn, fileStageOut and fileCleanUp</para></listitem>
      </itemizedlist>
      The following shows a factoryEndpoint element of a 4.0 job description
      and a 4.2 job description:
    </para>
    <screen># Endpoint in 4.0
&lt;factoryEndpoint
  xmlns:gram="http://www.globus.org/namespaces/2004/10/gram/job"
  xmlns:wsa="http://schemas.xmlsoap.org/ws/2004/03/addressing"&gt;
  &lt;wsa:Address&gt;
    https://grid-w.ncsa.teragrid.org:8444/wsrf/services/ManagedJobFactoryService
  &lt;/wsa:Address&gt;
  &lt;wsa:ReferenceProperties&gt;
    &lt;gram:ResourceID&gt;Fork&lt;/gram:ResourceID&gt;
  &lt;/wsa:ReferenceProperties&gt;
&lt;/factoryEndpoint&gt;</screen>
    <screen># Endpoint in 4.2
&lt;factoryEndpoint
  xmlns:gram="http://www.globus.org/namespaces/2008/03/gram/job"
  xmlns:wsa="http://www.w3.org/2005/08/addressing"&gt;
  &lt;wsa:Address&gt;
    https://grid-w.ncsa.teragrid.org:8444/wsrf/services/ManagedJobFactoryService
  &lt;/wsa:Address&gt;
  &lt;wsa:ReferenceParameters&gt;
    &lt;gram:ResourceID&gt;Fork&lt;/gram:ResourceID&gt;
  &lt;/wsa:ReferenceParameters&gt;
&lt;/factoryEndpoint&gt;</screen>
  </section>

  <section id="gram4-user-migrating-gt4-default-lrm">
    <title>Default local resource manager</title>
    <para>
      no need to specify one, can do so however if jobs are specific
      links
    </para>
  </section>

  <section id="gram4-user-migrating-gt4-rps">
    <title>Resource properties</title>
    <para>
      ManagedJobService
        fault is an array
        new RP localJobId
      ManagedJobFactoryService
        availableLocalResourceManagers
        maxJobLifetime
        jobTTLAfterProcessing
    </para>
  </section>

  <section id="gram4-user-migrating-gt4-lifetime">
    <title>Job Lifetime</title>
    <para>
      globusrun-ws in 4.0 set a default lifetime of 24h on a job if a user
      did not explicitly set it. In 4.2 a job will run to completion
      in any event, i.e. it will not be terminated after 24h. However, there
      are server-side settings that limit max lifetime explicitly requested by
      a user, and that determine what will happen to a completed job if no
      lifetime had been set.
      Check section <olink targetdoc="executionKey"
      targetptr="execution-approach-lifetime">Job Lifetime</olink> in the
      <olink targetdoc="executionKey">Execution key concepts</olink> and section
      <olink targetdoc="gram4User" targetptr="gram4-user-lifetime">Job
      Lifetime</olink> in the
      <olink targetdoc="gram4User">User's Guide</olink> for more
      information.
    </para>
  </section>

</section>

<section> <title>Developer - Migration Guide</title>

  <section id="gram4-developer-migrating-gt4-specupgrade">
    <title>Core specification upgrade</title>
    <para></para>
  </section>

  <section id="gram4-developer-migrating-gt4-default-lrm">
    <title>Default local resource manager</title>
    <para></para>
  </section>

  <section id="gram4-developer-migrating-gt4-termination">
    <title>Job termination</title>
    <para></para>
  </section>

  <section id="gram4-developer-migrating-gt4-lifetime">
    <title>Job lifetime</title>
    <para></para>
  </section>

  <section id="gram4-developer-migrating-gt4-subscriptions">
    <title>Subscription resources</title>
    <para></para>
  </section>
    
  <section id="gram4-developer-migrating-gt4-client-mj-uuid">
    <title>Client-side generated UUIDS for MultiJobs</title>
    <para></para>
  </section>

  <section id="gram4-developer-migrating-gt4-api">
    <title>API changes</title>

    <section id="gram4-developer-migrating-gt4-api-service">
      <title>Service</title>
      <para>
        namespace, termination, destruction, fault types,
        RPs (fault, defaultLRM, availableLRMs, lifetime-things),
        topic name change, final job states
      </para>
    </section>

    <section id="gram4-developer-migrating-gt4-api-client">
      <title>Client</title>
          
      <section id="gram4-developer-migrating-gt4-api-client-gramjob">
        <title>Java client GramJob</title>
        <para></para>
      </section>

      <section id="gram4-developer-migrating-gt4-api-client-c">
        <title>C client API</title>
        <para></para>
      </section>
    
    </section>
  </section>
</section>

</chapter>