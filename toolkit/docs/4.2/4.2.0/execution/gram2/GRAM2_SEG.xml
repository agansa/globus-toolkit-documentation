<?xml version='1.0' encoding='UTF-8'?>
<!DOCTYPE article PUBLIC "-//OASIS//DTD DocBook XML V4.4//EN"
"http://www.oasis-open.org/docbook/xml/4.4/docbookx.dtd"
[

<!ENTITY % myents SYSTEM "../../entities">

%myents;

]>
<article id="gram2SEG">
<title>GT &shortversion; Using Scheduler Event Generator with GRAM2</title>
<titleabbrev>Using Scheduler Event Generator with GRAM2</titleabbrev>

<sect1 id="gram2-seg-intro">
    <title>Introduction</title>

    <para>
        Starting with Globus Toolkit 4.1.0, the GRAM2 Job Manager
        supports using the Scheduler Event Generator (SEG) for
        obtaining job state information from the scheduler
        log files in place of running a poll command periodically. This
        has the effect in most situations of reducing the impact
        (in terms of CPU usage) of the job manager. This document describes how
        to configure and use this new feature.
    </para>
</sect1>

<sect1 id="gram2-seg-overview">
    <title>Overview of Operation</title>

    <para>
        The WS-GRAM Scheduler Event Generator (SEG) is a program which parses
        native log files generated by the schedulers supported by GRAM, and
        uses the information in them to issue events to stdout which are piped
        back to the WS-GRAM Job Manager service. This avoids the sometimes
        costly poll operation periodically done by the GRAM scheduler adapters.
    </para>

    <para>
        For GRAM2, a progam called 
        <command>globus-job-manager-event-generator</command> runs the SEG and
        writes job state change records into a log file which all users can
        read. This log contains the minimal information about jobs to determine
        when they are queued, become active, and terminate. No user-specific or
        job-specific data is revealed in this log file. The GRAM2
        Job Manager can be configured to use this log file as a source for 
        job state change events. A single instance of the
        <command>globus-job-manager-event-generator</command> will be run
        for each scheduler on the system.
    </para>
</sect1>

<sect1 id="gram2-seg-configuration">
    <title>Configuration</title>

    <sect2>
        <title>Job Manager Configuration</title>
        <para>
            By default, the job manager uses the GRAM2
            script-based polling method. A new command line option
            (<emphasis>-seg</emphasis>) 
            enables SEG-driven job state change
            notifications. 
        </para>

        <para>
            There are two ways to configure the job manager to use the
            scheduler event generator: globally, in the
            <filename>$GLOBUS_LOCATION/etc/globus-job-manager.conf</filename>
            file, or on a per-service basis in the service entry file in the
            <filename>$GLOBUS_LOCATION/etc/grid-services</filename> directory. 
        </para>

        <sect3>
            <title>Global Job Manager Configuration</title>

            <para>
                To enable using the Scheduler Event Generator interface for all
                Job Managers started from a particular GLOBUS_LOCATION, add a
                line containing the string 

                <programlisting>-seg</programlisting>

                to the file $GLOBUS_LOCATION/etc/globus-job-manager.conf. 
            </para>

            <example>
                <title>Example $GLOBUS_LOCATION/etc/globus-job-manager.conf</title>

                <programlisting>-home "/opt/globus"
-globus-gatekeeper-host globus.yourdomain.org
-globus-gatekeeper-port 2119
-globus-gatekeeper-subject "/O=Grid/OU=Your Organization/CN=host/globus.yourdomain.org"
-globus-host-cputype i686
-globus-host-manufacturer pc
-globus-host-osname Linux
-globus-host-osversion 2.6.10
-save-logfile on_error
-state-file-dir /opt/globus/tmp/gram_job_state
-machine-type unknown
<emphasis role="strong">-seg</emphasis></programlisting>
            </example>
        </sect3>

        <sect3>
            <title>Scheduler-specific Job Manager Configuration</title>

            <para>
                To enable using the Scheduler Event Generator interface for a
                particular Job Manager, add the string <emphasis
                role="strong">-seg</emphasis> to the end of the
                line in the service's file in the
                <filename>$GLOBUS_LOCATION/etc/grid-services</filename>
                directory. 
            </para>

            <example>
                <title>Example $GLOBUS_LOCATION/etc/grid-services/jobmanager-lsf</title>

                <programlisting>stderr_log,local_cred - /opt/globus/libexec/globus-job-manager globus-job-manager -conf /opt/globus/etc/globus-job-manager.conf -type lsf -rdn jobmanager-lsf -machine-type unknown -publish-jobs <emphasis role="strong">-seg</emphasis></programlisting>
            </example>

            <important>
                <para>
                    The Job GRAM2 Job ManagerManager does not support
                    using the SEG for the fork scheduler. if the
                    <code>-seg</code> option is passed to a fork Job Manager,
                    it will be ignored. 
                </para>
            </important>
        </sect3>

    </sect2>

    <sect2>
        <title>globus-job-manager-event-generator Configuration</title>

        <para>
            The globus-job-manager-event-generator program requires that the
            globus_job_manager_event_generator setup package be installed and
            run.  This setup package creates the
            <filename>$GLOBUS_LOCATION/etc/globus-job-manager-seg.conf</filename>
            file and initializes a directory to use for the scheduler logs. 
        </para>

        <para>
            By default, this setup script will create a configuration entry and
            directory for each scheduler installed on the system. For each
            scheduler to be handled by the globus-job-manager-event-generator
            program, there must be an entry in the file in the pattern: 

            <programlisting><emphasis>SCHEDULER_TYPE</emphasis>_log_path=<emphasis>PATH</emphasis></programlisting>
        </para>

        <para>
            The two variable substitutions for this pattern are 

            <variablelist>
                <varlistentry>
                    <term>SCHEDULER_TYPE</term>
                    <listitem>
                        <simpara>
                            Must match the name of the
                            scheduler-event-generator module for the scheduler
                            (supported with GT 4.1 are lsf, condor, and pbs).
                        </simpara>
                    </listitem>
                </varlistentry>

                <varlistentry>
                    <term>PATH</term>

                    <listitem>
                        <simpara>
                            A path to a directory which must be writable by the
                            account which will run the
                            globus-job-manager-event-generator program for the
                            SCHEDULER_TYPE, and world-readable (or readable for
                            a group which contains all users which will run
                            jobs via GRAM on that system). Each directory
                            specified in the configuration file must be unique,
                            or behavior is undefined.  
                        </simpara>
                    </listitem>
                </varlistentry>
            </variablelist>
        </para>

        <example>
                <title>Example $GLOBUS_LOCATION/etc/globus-job-manger-seg.conf</title> 
                <programlisting>lsf_log_path=/opt/globus/var/globus-job-manager-seg-lsf
pbs_log_path=/opt/globus/var/globus-job-manager-seg-pbs</programlisting>
        </example>

        <para>
            In this example, pbs and lsf schedulers are configured to use
            distinct subdirectories of the
            <filename>/opt/globus/var/</filename> directory. 
        </para>

        <important>
            <para>
                For best performance, the log paths should be persistent across
                system reboots and mounted locally (non-networked). 
            </para>
        </important>

        <important>
            <para>
                If a scheduler is added after the configuration step is done,
                administrator must rerun the setup package's script
                (<command>$GLOBUS_LOCATION/setup/globus/setup-seg-job-manager.pl</command>)
                or modify the configuration file and create the log directory
                with appropriate permissions. 
            </para>
        </important>
    </sect2>
</sect1>

<sect1 id="gram2-seg-running">
    <title>Running the
    <command>globus-job-manager-event-generator</command></title>

    <para>
        The globus-job-manager-event-generator script creates a log of all
        scheduler events related to a particular scheduler instance. This
        script was created for two purposes 

        <itemizedlist>
            <listitem>
                <para>
                    To avoid requiring that all GRAM users have the privileges
                    to read the scheduler's log file. Users may not be allowed
                    read access to the scheduler's log files. Since the Pre-WS
                    GRAM Job Manager runs with the permissions of the user
                    account, it may be unable to access the log files. Instead
                    the <command>globus-job-manager-event-generator</command>
                    program will run as a privileged user and then 
                    store job state change records in a file which GRAM2
                    users may access.
                </para>
            </listitem>

            <listitem>
                <para>
                    To provide a simple format for the scheduler event
                    generator logs so that the job manager will be able to
                    quickly recover state information if the job manager is
                    terminated and restarted. Some scheduler logs are difficult
                    to parse, or inefficient for seeking to a particular
                    timestamp (as is necessary for recovering job state change
                    information). The data written by this script is easily
                    locatably by date, and it is simple to remove old job
                    information without compromising current job manager
                    execution. 
                </para>
            </listitem>
        </itemizedlist>

    </para>

    <para>
        One instance of the
        <command>globus-job-manager-event-generator</command> must be running
        for each scheduler type to be implemented using the Scheduler Event
        Generator interface to receive job state changes. This program is
        located at <filename>$GLOBUS_LOCATION/sbin</filename>.  The typical
        command line for this program is
        <command>$GLOBUS_LOCATION/sbin/globus-job-manager-event-generator -s
        SCHEDULER_TYPE</command>, where <emphasis>SCHEDULER_TYPE</emphasis> is
        the scheduler name of the
        SEG module which should be used to generate
        events (lsf, condor, pbs). 
    </para>

    <para>
        For example, to start the event generator program to monitor an LSF
        batch system: 
        <screen><command>$GLOBUS_LOCATION/sbin/globus-job-manager-event-generator -s lsf</command></screen>
    </para>

    <important>
        <para>
            If the <command>globus-job-manager-event-generator</command> is not
            running, no job state changes will be sent from any job manager
            program which is configured to use the SEG.
        </para>
    </important>
</sect1>

<sect1 id="gram2-seg-troubleshooting">
    <title>Troubleshooting</title>

    <para>
        PROBLEM: The globus-job-manager-event-generator program terminates
        immediately with the output:
        <screen>Error: SCHEDULER not configured</screen>

        <itemizedlist>
            <listitem>
                <para>
                    Make sure that you specified the correct name for the
                    <emphasis>SCHEDULER</emphasis> module on the command line
                    to the
                    <command>globus-job-manager-event-generator</command>
                    program.
                </para>
            </listitem>

            <listitem>
                <para>
                    There is no entry for <emphasis>SCHEDULER</emphasis> in the
                    <filename>$GLOBUS_LOCATION/etc/globus-job-manager-seg.conf</filename>
                    file. See the section on globus-job-manager-event-generator
                    Configuration. 
                </para>
            </listitem>
        </itemizedlist>
    </para>

    <para>
        PROBLEM: The <command>globus-job-manager-event-generator</command>
        program terminates immediately with the output: 
        <screen>Fault: globus_xio: Operation was canceled</screen>

        <itemizedlist>
            <listitem>
                <para>
                    The scheduler module selected on the command line could not
                    be loaded by the SEG. Check that the name is correct, the
                    module is installed, and the setup script for that module
                    has been run. 
                </para>
            </listitem>
        </itemizedlist>
    </para>

    <para>
        PROBLEM: The Job Manager never receives any events from the scheduler. 

        <itemizedlist>
            <listitem>
                <para>
                    Verify that the directory specified in the
                    <filename>$GLOBUS_LOCATION/etc/globus-job-manager-seg.conf</filename>
                    for the scheduler exists, is writable by the account
                    running the
                    <command>globus-job-manager-event-generator</command> and
                    is readable by the user account running the job manager. 
                </para>
            </listitem>

            <listitem>
                <para>
                    Verify that the
                    <command>globus-job-manager-event-generator</command>
                    program is running. 
                </para>
            </listitem>

            <listitem>
                <para>
                    Verify that the
                    <command>globus-job-manager-event-generator</command>
                    program has permissions to read the scheduler logs. To help
                    diagnose this, run (as the account you wish to run the
                    globus-job-manager-event-generator as) the command 

                    <command>$GLOBUS_LOCATION/libexec/globus-scheduler-event-generator -s SCHEDULER_TYPE -t 1</command>
                    
                    You should see events printed to the stdout of that process
                    if it is working correctly. 
                </para>
            </listitem>
        </itemizedlist>
    </para>
</sect1>
</article>