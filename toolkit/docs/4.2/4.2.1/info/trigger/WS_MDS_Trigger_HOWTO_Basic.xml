<?xml version='1.0' encoding='UTF-8'?>
<chapterinfo><date>(version 2.0) November 2006</date></chapterinfo>
<title>Trigger Service - Easy HowTo </title>
  <section id="trigger-howto-basic"><title>Purpose</title>
    <para>The purpose of this Easy HowTo is to introduce the GT4/MDS4 component known as the <emphasis>Trigger</emphasis>, 
      as well as to provide an example of setting one up successfully.  The current GT 4.2-drafts <ulink url="http://www-unix.globus.org/toolkit/docs/development/4.2-drafts/info/trigger/">documentation</ulink> provides a basic reference and will be updated as features are added, but for those of you who would like to get a simple trigger working without going through all of the documentation, this document is for you.</para>
    <para>We will be creating a simple trigger from scratch, and setting it up completely. To get the basic idea of how this is done, we will only use elements available in the default GT4 installation to show you how to use triggers.</para>
  </section>
  
  <section id="trigger-howto-basic-prereq"><title>Prerequisites</title>
  <itemizedlist>
    <listitem>
      <para>Basic GT4 installation (one of the following):
          <itemizedlist>
<!--            <listitem>
              <para><ulink url="http://www.globus.org/toolkit/downloads/4.0.4/">GT 4.0.4</ulink> Installation (including Java WS Core and WS MDS Aggregator Framework), 
                in addition to <ulink url="http://www-unix.mcs.anl.gov/%7Erobertm/globus/gt4.0.3-wsmds-update-1.0-src_bundle.tar.gz">this update patch</ulink>.</para>
              <para>Patching GT 4.0.4 is as simple as getting the proper patch and issuing the following command: </para>
              <screen>$GLOBUS_LOCATION/sbin/gpt-build  -update gt4.0.3-wsmds-update-1.0-src_bundle.tar.gz</screen>
                
            </listitem>-->
            <listitem>
              <para>GT 4.1.3+ Installation (including Java WS Core and WS MDS Aggregator Framework).</para> 
                <note><simpara>GT 4.1.3+ is simply a preview to some of the upcoming GT 4.2 functionality.  The trigger state is still highly developmental.</simpara></note>
            </listitem>
          </itemizedlist>
      </para>
    </listitem>
    <listitem>
      <para>Basic <ulink url="http://www.w3.org/TR/xpath">XML Path Language (XPath)</ulink></para>
    </listitem>
  </itemizedlist>
  </section>
  
  <section id="trigger-howto-basic-intro"><title>Introduction</title>
    <para>Triggers collect information from information providers using the same mechanism as the Index service (within the context of the common aggregator
      framework); but once that data is collected, we can configure a <emphasis role="strong">trigger</emphasis> to perform an action based on that data.</para> 
      <para>Once the conditions are prepared, and the collected data is evaluated, the data will be compared to the conditions and, if there's a match, the trigger will set an action to occur.</para>
    <para>Learning to use triggers involves understanding what you are doing conceptually and knowing how to configure everything properly. Below we'll go through an example trigger configuration file and discuss some steps that should occur in an example setup. Generally when setting up a trigger you should follow the steps outlined in this tutorial.</para>
      <para>First let's explain what we are doing. We're going to set up a trigger to monitor the Default Index Service, and to tell us when a new entry is added to the Default Index Service. When a new entry is added, our trigger will execute a script that will create a [log] file in our $GLOBUS_LOCATION directory [and every two minutes that the new entry is still registered, we'll add a notification to this log file].  This is not necessarily a practical example of how you would use a trigger, but it's simple enough to give you a basic idea of how to set one up. So let's get started!</para>
  </section>
  <section id="trigger-howto-basic-tut"><title>Trigger Tutorial</title>
    <para><emphasis>This tutorial requires a working GT 4.1.3 or higher recent CVS install, or a patched GT 4.1.2 installation.<!-- We will be using a patched GT 4.1.2 install in this example--></emphasis>.</para>
    <orderedlist>
      <listitem>
        <para><emphasis role="strong">Trigger Registration:</emphasis></para> 
         <para>The first thing we do is to setup a trigger registration.  What this means is that the trigger service will be connected to an aggregator source.  The registration tells the trigger service which aggregator source (or, monitored service) it should pay attention to.  We can monitor many services at once, but in this example we will be monitoring the Default Index Service.  Our trigger registration will specify that we want to be monitoring the Default Index Service.  To do this we will specify a Member EPR in an aggregator configuration file. For this example, we will quickly walk through a new aggregator configuration; this will allow us to register the trigger (The trigger is actually registered once we use the <computeroutput>mds-servicegroup-add</computeroutput> command; see below).</para> 
        <para>Let's create the configuration file in the following location (this file is provided with new installs):
        <programlisting>$GLOBUS_LOCATION/etc/globus_wsrf_mds_trigger/trigger-registration-example.xml</programlisting></para>
        <para>The <link linkend="trigger-howto-basic-configfile">entire config file</link> is located further below. The following table breaks it down:</para>
        
        <informaltable>
          <tgroup cols="1">
            <colspec colnum="1" colname="col1"/>
            <tbody>
              <row><entry role="rowhead">A. Preliminaries</entry></row>
              <row>
                <entry>
                  <literallayout class="monospaced">
<emphasis role="strong">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;
&lt;ServiceGroupRegistrations
    xmlns="http://mds.globus.org/servicegroup/client"
    xmlns:xsd="http://www.w3.org/2001/XMLSchema"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xmlns:wsa="http://schemas.xmlsoap.org/ws/2004/03/addressing"
    xmlns:agg="http://mds.globus.org/aggregator/types"&gt;
&lt;/ServiceGroupRegistrations&gt;</emphasis>
                  </literallayout>
                  <para>As this is an XML document, it must be properly formatted XML.</para>  
                  <para>Start your file with the appropriate header.</para> 
                  <para>The ServiceGroupRegistration node is the root of the document.</para>
                </entry>
              </row>
              
              <row><entry role="rowhead">B. Aggregator Sink / Service Group Registration Information (for more information, go <ulink url="http://www.globus.org/toolkit/docs/4.0/info/aggregator/Query_Aggregator_Source.html">here</ulink>).</entry></row>
              
              <row>
                <entry>
                  <literallayout class="monospaced">
&lt;?xml version="1.0" encoding="UTF-8" ?&gt;
  &lt;ServiceGroupRegistrations
        xmlns="http://mds.globus.org/servicegroup/client"
        xmlns:xsd="http://www.w3.org/2001/XMLSchema"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xmlns:wsa="http://schemas.xmlsoap.org/ws/2004/03/addressing"
        xmlns:agg="http://mds.globus.org/aggregator/types"&gt;
    <emphasis role="strong">&lt;defaultServiceGroupEPR&gt;
    &lt;/defaultServiceGroupEPR&gt;</emphasis>
  &lt;/ServiceGroupRegistrations&gt;
                  </literallayout>
                  <para>In this section we will enter the Trigger Registration Service.</para>
                </entry>
              </row>
              <row>
                <entry><literallayout class="monospaced">
&lt;?xml version="1.0" encoding="UTF-8" ?&gt;
  &lt;ServiceGroupRegistrations
          xmlns="http://mds.globus.org/servicegroup/client"
          xmlns:xsd="http://www.w3.org/2001/XMLSchema"
          xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
          xmlns:wsa="http://schemas.xmlsoap.org/ws/2004/03/addressing"
          xmlns:agg="http://mds.globus.org/aggregator/types"&gt;
    &lt;defaultServiceGroupEPR&gt;
        <emphasis role="strong">&lt;wsa:Address&gt;
          http://127.0.0.1:8444/wsrf/services/TriggerRegistrationService
        &lt;/wsa:Address&gt;</emphasis>
    &lt;/defaultServiceGroupEPR&gt;
  &lt;/ServiceGroupRegistrations&gt;
                </literallayout>
                  <para>The Trigger Registration Service will register the monitored service (Member EPR).  <emphasis>Note: We will not be using https as the protocol, and the container should be started using the <computeroutput>-nosec</computeroutput> option until security has been properly tested.</emphasis></para> 
                </entry>
              </row>
              
              <row><entry role="rowhead">C. Aggregator Source Configuration (for more information, go <ulink url="http://www.globus.org/toolkit/docs/4.0/info/aggregator/Query_Aggregator_Source.html">here</ulink>).</entry></row>
              
              <row>
                <entry><literallayout class="monospaced">
&lt;?xml version="1.0" encoding="UTF-8" ?&gt;
  &lt;ServiceGroupRegistrations
          xmlns="http://mds.globus.org/servicegroup/client"
          xmlns:xsd="http://www.w3.org/2001/XMLSchema"
          xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
          xmlns:wsa="http://schemas.xmlsoap.org/ws/2004/03/addressing"
          xmlns:agg="http://mds.globus.org/aggregator/types"&gt;
      &lt;defaultServiceGroupEPR&gt;
          &lt;wsa:Address&gt;
          http://127.0.0.1:8444/wsrf/services/TriggerRegistrationService
          &lt;/wsa:Address&gt;
      &lt;/defaultServiceGroupEPR&gt;
      <emphasis role="strong">&lt;ServiceGroupRegistrationParameters&gt;
            xmlns="http://mds.globus.org/servicegroup/client"
            xmlns:wsa="http://schemas.xmlsoap.org/ws/2004/03/addressing"
            xmlns:agg="http://mds.globus.org/aggregator/types"&gt;
      &lt;/ServiceGroupRegistrationParameters&gt;</emphasis>
  &lt;/ServiceGroupRegistrations&gt;
                </literallayout>
                  <para>Now we will specify the parameters used to register a [monitored] resource (e.g. information provider) to the service group (i.e. our trigger registration service).</para>
                </entry>
              </row>
              
              <row>
                <entry>
                  <literallayout class="monospaced">
...
  &lt;ServiceGroupRegistrationParameters
        xmlns="http://mds.globus.org/servicegroup/client"
        xmlns:wsa="http://schemas.xmlsoap.org/ws/2004/03/addressing"
        xmlns:agg="http://mds.globus.org/aggregator/types"&gt;
      <emphasis role="strong">&lt;RegistrantEPR
        xmlns:wsa="http://schemas.xmlsoap.org/ws/2004/03/addressing"&gt;
        &lt;wsa:Address&gt;
            http://127.0.0.1:8444/wsrf/services/DefaultIndexService
        &lt;/wsa:Address&gt;
      &lt;/RegistrantEPR&gt;</emphasis>
  &lt;/ServiceGroupRegistrationParameters&gt;
  ...
                  </literallayout>
                  <para>We will set the RegistrantEPR to the entity (or information provider) to be monitored; in this case, we will be monitoring the DefaultIndexService.  <emphasis>Note: We refer often to the Registrant EPR as it's more generic name: Member EPR.</emphasis></para>
                </entry>
              </row>
              
              <row>
                <entry>
                  <literallayout class="monospaced">
...
&lt;ServiceGroupRegistrationParameters
      xmlns="http://mds.globus.org/servicegroup/client"
      xmlns:wsa="http://schemas.xmlsoap.org/ws/2004/03/addressing"
      xmlns:agg="http://mds.globus.org/aggregator/types"&gt;
  &lt;RegistrantEPR
      xmlns:wsa="http://schemas.xmlsoap.org/ws/2004/03/addressing"&gt;
      &lt;wsa:Address&gt;
          http://127.0.0.1:8444/wsrf/services/DefaultIndexService
      &lt;/wsa:Address&gt;
  &lt;/RegistrantEPR&gt;
  <emphasis role="strong">&lt;RefreshIntervalSecs&gt;600&lt;/RefreshIntervalSecs&gt;</emphasis>
&lt;/ServiceGroupRegistrationParameters&gt;
  ...
                  </literallayout>
                  <para>Set this to the number of seconds upon which the registration will be renewed (this is to keep the registration from expiring): <emphasis role="strong">600</emphasis>.</para>
                  <para>"600" means that we'll renew the registration every 10 minutes.</para>
                </entry>
              </row>
              
              <row>
                <entry>
                  <literallayout class="monospaced">
...
&lt;ServiceGroupRegistrationParameters
      xmlns="http://mds.globus.org/servicegroup/client"
      xmlns:wsa="http://schemas.xmlsoap.org/ws/2004/03/addressing"
      xmlns:agg="http://mds.globus.org/aggregator/types"&gt;
  &lt;RegistrantEPR
      xmlns:wsa="http://schemas.xmlsoap.org/ws/2004/03/addressing"&gt;
      &lt;wsa:Address&gt;
          http://127.0.0.1:8444/wsrf/services/DefaultIndexService
      &lt;/wsa:Address&gt;
  &lt;/RegistrantEPR&gt;
  &lt;RefreshIntervalSecs&gt;600&lt;/RefreshIntervalSecs&gt;
   <emphasis role="strong">&lt;Content xsi:type="agg:AggregatorContent"
              xmlns:agg="http://mds.globus.org/aggregator/types"&gt;
        &lt;agg:AggregatorConfig xsi:type="agg:AggregatorConfig"&gt;
        &lt;/agg:AggregatorConfig&gt;
        &lt;agg:AggregatorData /&gt;
   &lt;/Content&gt;</emphasis>
&lt;/ServiceGroupRegistrationParameters&gt;
  ...
                  </literallayout>
                  <para>Now we configure aggregator-source-specific configuration parameters.</para>
                  <para>Note: The AggregatorData element must be present, and it is also an empty element.</para>
                </entry>
              </row>
              <row>
                <entry>
                  <literallayout class="monospaced">
...
  &lt;Content xsi:type="agg:AggregatorContent"
          xmlns:agg="http://mds.globus.org/aggregator/types"&gt;
    &lt;agg:AggregatorConfig xsi:type="agg:AggregatorConfig"&gt;
        <emphasis role="strong">&lt;agg:GetResourcePropertyPollType 
                xmlns:wssg="http://docs.oasis-open.org/wsrf/2004/06/wsrf-WS-ServiceGroup-1.2-draft-01.xsd"&gt;
            &lt;agg:PollIntervalMillis&gt;30000&lt;/agg:PollIntervalMillis&gt;
        &lt;/agg:GetResourcePropertyPollType&gt;</emphasis>
    &lt;/agg:AggregatorConfig&gt;
    &lt;agg:AggregatorData /&gt;
  &lt;/Content&gt;
  ...
                  </literallayout>
                  <para>Set this to how often you'll be polling the information provider for data and refreshing the current information: <emphasis role="strong">30000</emphasis>.</para>
                  <para>"30000" means that you'll be checking the information provider every 30 seconds.  This is not typical!  We are only using such a short polling interval so that you can quickly visualize whether or not you've successfully set up this trigger!</para>
                  <para>The xmlns:wssg attribute should all be in one line.</para>
                </entry>
              </row>
              
              <row>
                <entry>
                  <literallayout class="monospaced">
...
  &lt;Content xsi:type="agg:AggregatorContent"
            xmlns:agg="http://mds.globus.org/aggregator/types"&gt;
    &lt;agg:AggregatorConfig xsi:type="agg:AggregatorConfig"&gt;
        &lt;agg:GetResourcePropertyPollType 
            xmlns:wssg="http://docs.oasis-open.org/wsrf/2004/06/\
                        wsrf-WS-ServiceGroup-1.2-draft-01.xsd"&gt;
            &lt;agg:PollIntervalMillis&gt;120000&lt;/agg:PollIntervalMillis&gt;
            <emphasis role="strong">&lt;agg:ResourcePropertyName&gt;wssg:Entry&lt;/agg:ResourcePropertyName&gt;</emphasis>
        &lt;/agg:GetResourcePropertyPollType&gt;
    &lt;/agg:AggregatorConfig&gt;
    &lt;agg:AggregatorData /&gt;
  &lt;/Content&gt;
  ...
                  </literallayout>
                  <para>Set this to the name of the resource property that the data is accessed by: <emphasis role="strong">wssg:Entry</emphasis>. <emphasis>wssg:Entry</emphasis> is one of the few resource properties available in the current implementation (this will likely change in future versions)</para>
                  <para>[The format is <emphasis>rp_namespace:rp_localname</emphasis>]</para>
                  <para>You can view some active ResourcePropertyNames as you poll the DefaultIndexService. For this example, this parameter is mostly irrelevant.</para>
                </entry>
              </row>
            </tbody>
          </tgroup>
        </informaltable>
        
        <para>Let's review the complete configuration file just so you can check that you have included everything properly:</para>
        <para><anchor id="trigger-howto-basic-configfile" xreflabel="Simple Trigger Config File"/><filename>$GLOBUS_LOCATION/etc/globus_wsrf_mds_trigger/trigger-registration-example.xml</filename></para>
        
        <screen>
&lt;ServiceGroupRegistrations
  xmlns="http://mds.globus.org/servicegroup/client"
  xmlns:xsd="http://www.w3.org/2001/XMLSchema"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xmlns:wsa="http://schemas.xmlsoap.org/ws/2004/03/addressing"
  xmlns:agg="http://mds.globus.org/aggregator/types"&gt;
  &lt;defaultServiceGroupEPR&gt;
    &lt;wsa:Address&gt;http://127.0.0.1:8444/wsrf/services/TriggerRegistrationService&lt;/wsa:Address&gt;
  &lt;/defaultServiceGroupEPR&gt;
  &lt;ServiceGroupRegistrationParameters
    xmlns="http://mds.globus.org/servicegroup/client"
    xmlns:wsa="http://schemas.xmlsoap.org/ws/2004/03/addressing"
    xmlns:agg="http://mds.globus.org/aggregator/types"&gt;
    &lt;RegistrantEPR
      xmlns:wsa="http://schemas.xmlsoap.org/ws/2004/03/addressing"&gt;
      &lt;wsa:Address&gt;http://127.0.0.1:8444/wsrf/services/DefaultIndexService&lt;/wsa:Address&gt;
    &lt;/RegistrantEPR&gt;
    &lt;RefreshIntervalSecs&gt;600&lt;/RefreshIntervalSecs&gt;
    &lt;Content xsi:type="agg:AggregatorContent"
      xmlns:agg="http://mds.globus.org/aggregator/types"&gt;
      &lt;agg:AggregatorConfig xsi:type="agg:AggregatorConfig"&gt;
        &lt;agg:GetResourcePropertyPollType 
          xmlns:wssg="http://docs.oasis-open.org/wsrf/2004/06/wsrf-WS-ServiceGroup-1.2-draft-01.xsd"&gt;
          &lt;agg:PollIntervalMillis&gt;30000&lt;/agg:PollIntervalMillis&gt;
          &lt;agg:ResourcePropertyName&gt;wssg:Entry&lt;/agg:ResourcePropertyName&gt;
        &lt;/agg:GetResourcePropertyPollType&gt;
      &lt;/agg:AggregatorConfig&gt;
      &lt;agg:AggregatorData /&gt;
    &lt;/Content&gt;
  &lt;/ServiceGroupRegistrationParameters&gt;
&lt;/ServiceGroupRegistrations&gt;    
        </screen>
        
        <!--
        
        EPR = End Point Reference - a reference to the delegated credential, can be used to later refresh the credentials.  Web services and WS-Resources are referenced using an "Endpoint Reference".  Services that create of locate WS-Resources return Endpoint References.  Web services are stateless; WS-Resources provide a context for stateful execution
        
        -->
        
        <para>You could simply copy these file contents and change the "127.0.0.1" to your hostname. Great! Now that we've got the configuration file set up, we need to register it with the Trigger Registration Service, so that the Trigger Service knows what to look out for.</para>
      </listitem>
      <listitem><para><emphasis role="strong">Trigger Action Script Configuration</emphasis>: Now that we have the trigger configuration file set to execute an action whenever our conditions are met, we need to determine what those actions are. We do this by setting up a Trigger Action Script.</para>

        <orderedlist>
          <listitem>
            <para>Here we write the action script:</para> 
            <para>We'll make it very simple:</para>
            <screen>
#!/bin/sh

DATE=`date`

echo "Trigger Service Entry: $DATE" &gt;&gt; $GLOBUS_LOCATION/trigger_service_base_action_log

cat &lt;&lt;EOF
&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;OurActionScriptOutput&gt;
  &lt;OurDataDetected&gt;true&lt;/OurDataDetected&gt;
&lt;/OurActionScriptOutput&gt;
EOF
            </screen>
	    <para><emphasis>Note: This example script should be provided if your have a recent installation, however if not:</emphasis></para>
            <para>Save this file as: <filename>$GLOBUS_LOCATION/libexec/trigger/default-script.sh</filename></para>
            <important><para>Be sure that this file is executable! (e.g. chmod u+x default-script.sh)</para></important>

          </listitem>
        </orderedlist>
      </listitem>
      <listitem><para><emphasis role="strong">Registration:</emphasis></para>
        <para>The registration step is necessary to connect the information source with the Trigger Registration Service (an aggregator service). 
        This step provides access to the information source data so that the trigger can then make this information available and act on it accordingly.</para>
        <para><emphasis>--&gt; Now start the container:</emphasis> (Note: the <computeroutput>-p</computeroutput> option allows you to specify a port.  We have been using 8444 in this example.  We will also specify <computeroutput>-nosec</computeroutput> until security for triggers has been adequately tested.)</para> 
          <screen>$GLOBUS_LOCATION/bin/globus-start-container -p 8444 -nosec</screen> 
          <para>You may also need to set up your environment variables, and/or generate a new proxy certificate: </para>
        <screen id="info-trigger-exampletest">
          source $GLOBUS_LOCATION/etc/globus-user-env.sh
          $GLOBUS_LOCATION/bin/grid-proxy-init -verify -debug
        </screen>
        <para>But before we create the trigger, let's just quickly test how many Entries are being registered by the Index Service. Type the following command in one line:</para> 
          <screen>$GLOBUS_LOCATION/bin/wsrf-query -s http://127.0.0.1:8444/wsrf/services/DefaultIndexService 'count(//*[local-name()="Entry"])'</screen> 
        <para>On our setup we get: <emphasis role="strong">3</emphasis>.</para>
      </listitem>
      <listitem><para><emphasis role="strong">Create Trigger Registration:</emphasis></para> 
        <para>Once the configurations have been properly set, it's easy to register them with the Trigger Registration Service.</para> 
            <para>We will create the trigger registration by running <emphasis role="strong"><link linkend="mds-servicegroup-add">mds-servicegroup-add</link></emphasis> to perform the registrations specified in the configuration file.</para> 
        <para>This tool takes an XML configuration file listing registrations, and causes those registrations to be made.</para>
            <para>Run the following command:</para> 
              <screen>$GLOBUS_LOCATION/bin/mds-servicegroup-add $GLOBUS_LOCATION/etc/globus_wsrf_mds_trigger/trigger-registration-example.xml</screen> 
              <important><para>Be sure the above command is on one line.</para></important>
            <para>If everything went well, you should get something like:</para>
            <screen>Processing configuration file...
INFO: Processed 1 registration entries
INFO: Successfully registered https://127.0.0.1:8443/wsrf/services/DefaultIndexService \
to servicegroup at https://127.0.0.1:8443/wsrf/services/TriggerRegistrationService
            </screen>
      </listitem>
      <listitem>
        <para><emphasis role="strong">Create Trigger:</emphasis></para> 
        <para>Now that we have created a trigger registration, and we have a service that will be monitored, we're ready to create the actual trigger whose parameters will indicate what information we will be evaluating against any incoming data.  It will also specify and execute the action script that we've created.  All trigger creation and management is performed via clients.</para>
	<para>In this HowTo, we will be using the command-line clients that are provided with your installation.  (There is also a web interface, but setting that up will be discussed in an upcoming HowTo.  The web interface is easier to use and more visually appealing than the command-line clients!)</para>
        <orderedlist>
          <listitem>
	    <para>We must configure the [command-line] clients according to your individual setup: 
	    <screen>$GLOBUS_LCATION/etc/globus_wsrf_mds_trigger/client-config-settings</screen>
            <para>This file should already be included in your install. It basically looks like this:</para>
	    <screen>
DefaultServiceAddress: http://127.0.0.1:8444/wsrf/services/


/* PLEASE CHOOSE ONLY **ONE** OF THE FOLLOWING PARAMETERS      */
/*                                                             */
/* GLTempFileLocation means that the location is under the     */
/* $GLOBUS_LOCATION path, so if you indicate :                 */
/*    GLTempFileLocation: /etc/whatever/                       */
/* this would map to:                                          */
/*    $GLOBUS_LOCATION/etc/whatever/                           */
/*                                                             */
/* Be sure that the                                            */
/*    $GLOBUS_LOCATION/etc/whatever/ directory exists!         */
/*                                                             */
/*                                                             */
/* If you use the TempFileLocation parameter, this will map    */
/* directly to that location on the filesystem.                */
/*                                                             */
/* Using both may lead to unpredictable behavior.              */


GLTempFileLocation: /etc/globus_wsrf_mds_trigger/.temporary_epr_files
#TempFileLocation: /work/z_test/
</screen>

            <para>The most important item to edit is the first line.  Be sure that the host service address corresponds to your deployed container.  When you start the container a list of service addresses will indicate what you should be using for this parameter.  We can leave the TempFileLocation parameter as it is.</para>
          </listitem>
          <listitem>
            <para>Now we create the trigger</para>
            <screen>$GLOBUS_LOCATION/bin/mds-trigger-create  -s http://127.0.0.1:8444/wsrf/services/DefaultIndexService default</screen>
            <important><para>When you create a trigger, an EPR is created and stored in a temporary file (the location of these files is specified in the client configuration with the TempFileLocation parameter).  <computeroutput>default</computeroutput> means that the temporary EPR file will be located in the directory you specified in the client configuration.  We recommend that you keep all of your EPR files in the same place!</para>
	    <para>The EPR file that is created is important since this is the only way to access your trigger.  If you stop the container, the EPR files created during that container session become invalid, and can be removed permanently.  When you restart the container, you will create new EPR files using this same client.</para></important>
	    <para>The client should produce output similar to the following:</para>
	    <screen>

   MDS4 Trigger Creation Client
   ----------------------------

** Output Filename: YOUR-GLOBUS-LOCATION/etc/globus_wsrf_mds_trigger/.temporary_epr_files/epr_20070617_142542.xml
**     Service URL: http://127.0.0.1:8444/wsrf/services/DefaultIndexService

--> Trigger has been created.
--> Endpoint reference written to file: YOUR-GLOBUS-LOCATION/etc/globus_wsrf_mds_trigger/.temporary_epr_files/epr_20070617_142542.xml
</screen>
          </listitem>
          <listitem>
            <para>Test the trigger creation by typing the following command:</para>
            <screen>mds-trigger-view</screen>
	    <para>This command should produce output similar to the following:</para>
	    <screen>
   MDS4 Trigger View Client
   ------------------------

Monitored Services (Trigger Registrations)

1) /wsrf/services/DefaultIndexService

Trigger Name: Default Trigger Name
EPR File Location: YOUR-GLOBUS-LOCATION/etc/globus_wsrf_mds_trigger/.temporary_epr_files/epr_20070617_142542.xml
Matching Rule: count(//*[local-name()='Entry'])<1
Status: DISABLED

</screen>
            <para>This output tells us that there is one trigger registration (with the DefaultIndexService) and that the trigger we have just created is called "Default Trigger Name", we see where the EPR file is located, we see a matching rule (which is an XPath query against the monitored service, or the DefaultIndexService), and we see that the trigger is DISABLED.  This means that the trigger will not fire, nor will it try to evaluate any data.  This is an inactive trigger.</para>
          </listitem>
          <listitem>
            <para>In order to make things happen you must enable the trigger.  This is done with the <computeroutput>mds-trigger-edit</computeroutput> command.</para>
	    <screen>mds-trigger-edit -e YOUR-GLOBUS-LOCATION/etc/globus_wsrf_mds_trigger/.temporary_epr_files/epr_20070617_142542.xml TriggerName="NewName"</screen>
	    <para>This will output something similar to:</para>
	    <screen>
   MDS4 Trigger Edit Client
   ------------------------

Note: currently, only one parameter may be edited at a time.
** EPR Filename: YOUR-GLOBUS-LOCATION/etc/globus_wsrf_mds_trigger/.temporary_epr_files/epr_20070617_143014.xml
** Edit Query: TriggerName=NewName

Trigger Parameter: TriggerName
Trigger Parameter Value: NewName

Setting TriggerName to NewName...
Done.
</screen>
             <para>Changing the name of the trigger is completely up to you.  It's not really important except if you're managing tons of triggers.  But let's enable this trigger.  By enabling/activating the trigger, we turn it "on", meaning that it will take the Matching Rule and evaluate this against incoming aggregaor data from our monitored service (the Default Index Service).</para>
	     <screen>mds-trigger-edit -e YOUR-GLOBUS-LOCATION/etc/globus_wsrf_mds_trigger/.temporary_epr_files/epr_20070617_142542.xml TriggerStatus="enabled"</screen>
	     <para>When this trigger is "enabled", we now have an active trigger that is actively evaluating data.  You may notice this in the service container screen.  But our trigger will not fire since the Matching Rule evaluates to false.  There is more than one entry in the Default Index Service, so when we use our Matching Rule, a false evaluation will not allow the trigger to fire.  So let's change our Matching Rule so that the trigger will evaluate to "true", thus firing the trigger.
	     <screen>mds-trigger-edit -e YOUR-GLOBUS-LOCATION/etc/globus_wsrf_mds_trigger/.temporary_epr_files/epr_20070617_142542.xml MatchingRule="count(//*[local-name()='Entry'])>1"</screen>
              <para>Now after a minute or so, you will notice that the trigger has fired successfully.  You can verify this by checking the contents of the log file we created in our action script from above:
	      <screen>more trigger_service_base_action_log</screen>
	      <para>This should look similar to the following</para>
	      <screen>
Trigger Service Entry: Sun Jun 17 14:45:26 CDT 2007
Trigger Service Entry: Sun Jun 17 14:45:56 CDT 2007
Trigger Service Entry: Sun Jun 17 14:46:26 CDT 2007
Trigger Service Entry: Sun Jun 17 14:46:56 CDT 2007
              </screen>
	      <para>There is a 30 second interval that we specified in our aggregator configuration file above.  This should probably be lengthened eventually so that you don't have the triggers going off so often.</para>
</screen>
          </listitem>
        </orderedlist>
      </listitem>
    </orderedlist>
  </section>
  <section id="trigger-howto-basic-congrats"><title>Congratulations!</title>  
    <para>You have now successfully setup, configured, registered, created, edited and tested a trigger from scratch!</para>
  <para><emphasis role="strong">Next Steps:</emphasis> Check out the documentation and create more triggers to perform actions more relevant to your own objectives. Experiment with the XPath queries to expand the possibilities of what you can use them for. If you have questions, feel free to contact us!</para>
  <para>Please keep in mind that this is in a highly developmental stage, so there may be errors, or unpredictable behavior.  Feel free to let us know what works, what doesn't, and your general experiences with the trigger service.</para>
  </section>
      