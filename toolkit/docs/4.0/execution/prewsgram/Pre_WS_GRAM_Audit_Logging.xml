<important>   <para>This feature is only available beginning with
      version 4.0.5 of the Globus Toolkit.
   </para></important>
   
   <section id="s-prewsgram-audit-logging-overview"><title>Overview</title>

      <para>
      Pre-WS GRAM includes mechanisms to provide access to audit and
        accounting information associated with jobs that Pre-WS GRAM submits to a local
      resource manager (LRM) such as PBS, LSF, or Condor.</para>
     
     <note> <para>Remember, GRAM is not a local resource manager but rather a protocol engine for
      communicating with a range of different local resource managers using a
      standard message format.</para></note>
     
      <para>In some scenarios, it is desirable to get general information about the usage of the
      underlying LRM, such as:</para>
      <itemizedlist>
         <listitem><para>What kinds of jobs were submitted via GRAM?</para></listitem>
         <listitem><para>How long did the processing of a job take?</para></listitem>
         <listitem><para>How many jobs were submitted by user X?</para></listitem>
      </itemizedlist>
     <para> The following three use cases give a better overview of the meaning and
      purpose of auditing and accounting:</para>
      <orderedlist>
         <listitem><para>
           <emphasis role="bold">Group Access</emphasis>.
           A grid resource provider allows a remote service (e.g.,
           a gateway or portal) to submit jobs on behalf of multiple users. The
           grid resource provider only obtains information about the identity of
           the remote submitting service and thus does not know the identity of
           the users for which the grid jobs are submitted. This group access is
           allowed under the condition that the remote service stores audit
           information so that, if and when needed, the grid resource provider
           can request and obtain information to track a specific job back to an
           individual user.
         </para></listitem>
         <listitem><para>
           <emphasis role="bold">Query Job Accounting</emphasis>.
           A client that submits a job needs to be able to
           obtain, after the job has completed, information about the resources
           consumed by that job. In portal and gateway environments where many
           users submit many jobs against a single allocation, this per-job
           accounting information is needed soon after the job completes so that
           client-side accounting can be updated. Accounting information is
           sensitive and thus should only be released to authorized parties.
         </para></listitem>
         <listitem><para>
           <emphasis role="bold">Auditing</emphasis>.
           In a distributed multi-site environment, it can be
           necessary to investigate various forms of suspected intrusion and
           abuse. In such cases, we may need to access an audit trail of the
           actions performed by a service. When accessing this audit trail, it
           will frequently be important to be able to relate specific actions
           to the user.
         </para></listitem>
      </orderedlist>

     <para>The audit record of a job is stored at the end of the processing cycle of a job - either when it is completely
     processed or failed.</para>
</section>
       <section><title>Audit and Accounting Records</title>
         
    <para>
           While audit and accounting records may be generated and stored by
           different entities in different contexts, we make the following assumptions in this chapter:</para>

         <informaltable>
           <tgroup cols="3">
             <thead>
               <row>
                 <entry>&nbsp;</entry>
                 <entry>Audit Records</entry>
                 <entry>Accounting Records</entry>
                 </row>
               </thead>
             <tbody>
               <row>
                 <entry>Generated by:</entry>
                 <entry>GRAM service</entry>
                 <entry>LRM to which the GRAM service submits jobs</entry>
               </row>
               <row>
                 <entry>Stored in:</entry>
                 <entry>Database, indexed by GJID</entry>
                 <entry>LRM, indexed by JID</entry>
               </row>
               <row>
                 <entry>Data that is stored:</entry>
                 <entry>See list below.</entry>
                 <entry>May include all information about the duration and resource-usage of a job</entry>
               </row>
             </tbody>
           </tgroup>
           </informaltable>
      <para>
        The audit record of each job contains the following data:</para>
      <itemizedlist>
        <listitem><para>
          <emphasis role="strong">job_grid_id</emphasis>:
          String representation of the resource EPR
        </para></listitem>
        <listitem><para>
            <emphasis role="strong">local_job_id</emphasis>:
          Job/process id generated by the scheduler
        </para></listitem>
        <listitem><para>
            <emphasis role="strong">subject_name</emphasis>:
          Distinguished name (DN) of the user
        </para></listitem>
        <listitem><para>
            <emphasis role="strong">username</emphasis>:
          Local username
        </para></listitem>
        <listitem><para>
            <emphasis role="strong">idempotence_id</emphasis>:
          Job id generated on the client-side
        </para></listitem>
        <listitem><para>
            <emphasis role="strong">creation_time</emphasis>:
          Date when the job resource is created
        </para></listitem>
        <listitem><para>
            <emphasis role="strong">queued_time</emphasis>:
          Date when the job is submitted to the scheduler
        </para></listitem>
        <listitem><para>
            <emphasis role="strong">stage_in_grid_id</emphasis>:
          String representation of the stageIn-EPR (RFT)
        </para></listitem>
        <listitem><para>
            <emphasis role="strong">stage_out_grid_id</emphasis>:
          String representation of the stageOut-EPR (RFT)
        </para></listitem>
        <listitem><para>
            <emphasis role="strong">clean_up_grid_id</emphasis>:
          String representation of the cleanUp-EPR (RFT)
        </para></listitem>
        <listitem><para>
            <emphasis role="strong">globus_toolkit_version</emphasis>:
          Version of the server-side GT
        </para></listitem>
        <listitem><para>
            <emphasis role="strong">resource_manager_type</emphasis>:
          Type of the resource manager (Fork, Condor, ...)
        </para></listitem>
        <listitem><para>
            <emphasis role="strong">job_description</emphasis>:
          Complete job description document
        </para></listitem>
        <listitem><para>
            <emphasis role="strong">success_flag</emphasis>:
          Flag that shows whether the job failed or finished successfully
        </para></listitem>
        <listitem><para>
            <emphasis role="strong">finished_flag</emphasis>:
          Flag that shows whether the job is already fully processed or
          still in progress
        </para></listitem>
      </itemizedlist>
       </section>
     
     <section><title>Pre-WS GRAM Service GJID</title>
      <para>  
        The Pre-WS GRAM service returns a "job contact" that is used to control the job. The job contact, by default, is already 
        in an acceptable GJID format; therefore, the Pre-WS GRAM client and service do not need to convert it in any way.
      </para>
     </section>
     
<section><title>Accessing Audit and Accounting Information</title>
      <para>
        To connect the two sets of records, both audit and accounting,
        we require that GRAM records the JID in each audit record that it
        generates. It is then straightforward for an audit service to respond
        to requests such as &quot;Give me the charge of the job with JID x&quot;  by:
          
         <orderedlist> 
           <listitem><para>first selecting matching record(s) from the audit table, </para></listitem>
           <listitem><para>then using the local JID(s) to join to the accounting table of the LRM and access relevant accounting record(s).</para></listitem></orderedlist>
      </para>
      <para>
        We propose a Web Service interface for accessing audit and accounting
          information.  <ulink url="http://www.globus.org/toolkit/docs/4.0/techpreview/ogsadai/">OGSA-DAI</ulink> 
          is a WSRF service that can create a single
        virtual database from two or more remote databases. 
        In the future, other per-job information such as job performance data
        could be stored using the GJID or local JID as an index, and then made
        available in the same virtual database.</para></section>

<section><title>For More Information</title>       
  <para>The rest of this chapter focuses on how to configure Pre-WS GRAM to enable
        Audit Logging. A case study for TeraGrid can be read
        <ulink url="http://www.teragridforum.org/mediawiki/index.php?title=GRAM4_Audit">
            here</ulink>, which also includes more information about how to use this data to get accounting
           information of a job, query the audit database for information
           via a Web Services interface, etc.
      </para>
</section>

<section id="s-prewsgram-audit-logging-funct"><title>Functionality</title>
  <para>Audit logging in Pre-WS GRAM is realized in the following way:</para>
  <orderedlist>
  <listitem><para>The job manager writes a file to disk for each job. This file contains the audit record. 
    The format of an audit record file that is logged to the database is a comma-separated list of double-quoted strings.</para></listitem>
  
  <listitem><para>The audit records are not inserted into the GRAM audit database directly. The job manager will, 
    at final job termination (FAILED or DONE state), write a record to a unique file in a directory specified by a configuration file. 
    These audit files must be uploaded by a program which can be called manually or be run periodically as a cron job. 
    The program is a perl script and is located in <filename>${GLOBUS_LOCATION}/libexec/globus-gram-audit</filename> and 
    creates audit records in the configured database from the user audit files. Once the record is uploaded, the program will 
    remove the audit file.</para></listitem>
  </orderedlist>
  <para>Here's an example on how a crontab entry must look like in order to run the script every 15 minutes:</para>
  
  <screen>0,15,30,45 * * * * ${GLOBUS_LOCATION}/libexec/globus-gram-audit</screen>
  
  <para>The script gets the necessary parameters to connect to the database from the configuration file 
    <filename>${GLOBUS_LOCATION}/etc/globus-job-manager-audit.conf</filename>, which is described below.</para>
  
  <para>The reason Pre-WS GRAM uses a different method than WS GRAM (writing audit files instead of directly inserting into a 
    database) is to have a more trusted entity write to the database, rather than requiring all Pre-WS GRAM users with the ability to do so. </para>
  <!-- from cris: the above sentence is a bit confusing to me - "rather than requiring all Pre-WS GRAM users with the ability to do so" 
  do you mean rather than requiring all Pre-WS GRAM users to become 'trusted entities'?-->
  
</section>

  <section id="s-prewsgram-audit-logging-config"><title>Configuring WS-GRAM To Enable Audit Logging</title>
    <para>Audit logging is turned off by default. To turn on Audit Logging, follow these steps:</para>
    
    <section><title>Configure Audit Record Directory</title>
      <para>Add the following line to <filename>$GLOBUS_LOCATION/etc/globus-job-manager.conf</filename>:</para>
     <screen> -audit-directory &lt;your desired audit record directory&gt;</screen>
    </section>
    
    <section><title>Create Audit Record Directory</title>
      <para>Create the audit record directory specified in the above configuration file with the following permissions:</para>
      <screen>rws-wsrwx</screen>
    </section>
    
        <section><title>Configure Log4J</title>
        <para>
          Add the following lines to the Log4j configuration in
          <filename>$GLOBUS_LOCATION/etc/log4j.properties</filename>
          to enable audit logging:
        </para>
        <screen># GRAM AUDIT
          log4j.category.org.globus.exec.service.exec.StateMachine.audit=DEBUG, AUDIT
          log4j.appender.AUDIT=org.globus.exec.utils.audit.AuditDatabaseAppender
          log4j.appender.AUDIT.layout=org.apache.log4j.PatternLayout
          log4j.additivity.org.globus.exec.service.exec.StateMachine.audit=false</screen>
        </section>
    
    <section><title>Add Database Connection Parameters</title>
      
      <para>Edit <filename>$GLOBUS_LOCATION/etc/globus-job-manager-audit.conf</filename> to include the correct database connection parameters. For example::</para>
      <screen>
        DRIVERCLASS:com.mysql.jdbc.Driver
        USERNAME:john
        PASSWORD:foo
        URL:jdbc:mysql://myhost/auditDatabase</screen>
    </section>
    
        <section><title>Create Audit Database</title>
        <para>
          Audit records are stored in a database which must be set up once. Currently we provide schemas for
          <itemizedlist>
            <listitem><para>
                MySQL (<filename>$GLOBUS_LOCATION/share/gram-service/gram_audit_schema_mysql.sql</filename>)
           </para></listitem>
           <listitem><para>
             Postgres (<filename>$GLOBUS_LOCATION/share/gram-service/gram_audit_schema_postgres-8.0.sql</filename>)
           </para></listitem>
          </itemizedlist>
          The following describes how to set up the database for audit records in MySQL:
          <orderedlist>
             <listitem><para>Create a database inside of MySQL</para></listitem>
             <listitem>
               <para>
                 Grant necessary privileges to the user who is configured in the JNDI
                 registry of WS-GRAM
               </para>
             </listitem>
             <listitem><para>Use the schema to create the table</para></listitem>
          </orderedlist>
          </para>
          <screen>host:~ feller$ mysql -u root -p
Enter password: 
Welcome to the MySQL monitor.  Commands end with ; or \g.
Your MySQL connection id is 16
Server version: 5.0.37 MySQL Community Server (GPL)

Type 'help;' or '\h' for help. Type '\c' to clear the buffer.

mysql&gt; create database auditDatabase;
Query OK, 1 row affected (0.09 sec)
 
            mysql&gt; GRANT ALL ON auditDatabase.* to globus@localhost identified by "foo";
            Query OK, 0 rows affected (0.32 sec)
            
            mysql&gt; exit
            Bye
            host:~ feller$ mysql -u globus -p auditDatabase &lt; ${GLOBUS_LOCATION}/share/gram-service/gram_audit_schema_mysql.sql 
            Enter password: 
            host:~ feller$</screen>
        </section>
    <section><title>Configure the Database in JNDI</title>
      <para>
        Add or modify the database configuration where the audit records are
        stored in <computeroutput>$GLOBUS_LOCATION/etc/gram-service/jndi-config.xml
        </computeroutput>:
      </para>
      <screen>&lt;resource name="auditDatabaseConfiguration" type="org.globus.exec.service.utils.AuditDatabaseConfiguration"&gt;
        &lt;resourceParams&gt;
        &lt;parameter&gt;
        &lt;name&gt;factory&lt;/name&gt;
        &lt;value&gt;org.globus.wsrf.jndi.BeanFactory&lt;/value&gt;
        &lt;/parameter&gt;
        &lt;parameter&gt;
        &lt;name&gt;driverClass&lt;/name&gt;
        &lt;value&gt;com.mysql.jdbc.Driver&lt;/value&gt;
        &lt;/parameter&gt;
        &lt;parameter&gt;
        &lt;name&gt;url&lt;/name&gt;
        &lt;value&gt;jdbc:mysql://&lt;host&gt;[:port]/auditDatabase&lt;/value&gt;
        &lt;/parameter&gt;
        &lt;parameter&gt;
        &lt;name&gt;user&lt;/name&gt;
        &lt;value&gt;globus&lt;/value&gt;
        &lt;/parameter&gt;
        &lt;parameter&gt;
        &lt;name&gt;password&lt;/name&gt;
        &lt;value&gt;foo&lt;/value&gt;
        &lt;/parameter&gt;
        &lt;parameter&gt;
        &lt;name&gt;globusVersion&lt;/name&gt;
        &lt;value&gt;4.0.3&lt;/value&gt;
        &lt;/parameter&gt;
        &lt;/resourceParams&gt;
        &lt;/resource&gt;</screen>
    </section>
    
  </section>
