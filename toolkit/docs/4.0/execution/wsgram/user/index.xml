<title>GT 4.0 WS GRAM: User's Guide</title>
<titleabbrev>User's Guide</titleabbrev>

<section id="s-wsgram-user-introduction"><title>Introduction</title>
<para>
    GRAM services provide secure job submission to many types of <glossterm linkend="job-scheduler">job schedulers</glossterm> 
  for users who have the right to access a job hosting resource in a Grid
    environment.  The existence of a <link linkend="s-wsgram-user-proxygen">valid proxy</link>
  is actually <emphasis role="strong">required</emphasis> for job submission.  All GRAM job submission options are
  supported transparently through the embedded request document input. In fact,
    the job startup is done by submitting a client-side provided <glossterm linkend="job-description">job description</glossterm>
  to the GRAM services. This submission can be made by end-users with the 
    GRAM <link linkend="r-wsgram-commandline">command-line tools</link>.
</para>
</section>

<section id="s-wsgram-user-newfunctionality"><title>New Functionality in GT4</title>

<section id="s-wsgram-user-submissionid"><title>Submission ID</title>
<para>
  A submission ID may be used in the GRAM protocol for reliability in the face
  of message faults or other transient errors in order to ensure that at most
  one instance of a job is executed, i.e. to prevent accidental duplication of
  jobs under rare circumstances with client retry on failure. By default, the
    <glossterm linkend="globusrun-ws">globusrun-ws</glossterm> program will generate a submission ID (<glossterm linkend="uuid">uuid</glossterm>).  One can override
  this behavior by supplying a submission ID as a command line argument.
</para>
<para>
  If a user is unsure whether a job was submitted successfully, he
  should resubmit using the same ID as was used for the previous attempt.
</para>

</section>


<section id="s-wsgram-user-jobholdandrelease"><title>Job hold and release</title>
<para>
It is possible to specify in a job description that the job be 
put on hold when it reaches a chosen state (see <ulink url="../WS_GRAM_Approach.html">GRAM
Approach</ulink>
documentation for more information about the executable 
job state machine, and see the<ulink url="schemas/mj_types.html#element_holdState"> job
description XML schema documentation</ulink> for information about how to specify a held
state).
This is useful, for example, when a GRAM client wishes to directly 
access output files written by the job (as opposed to waiting for 
the stage-out step to transfer files from the job host). The client would  
request that the file cleanup process be held until released, 
giving the client an opportunity to fetch all remaining/buffered 
data after the job completes but <emphasis>before</emphasis> the output files are 
deleted. </para>
<para><command>globusrun-ws</command> uses job hold and release to ensure client-side 
streaming of remote files in batch mode.
</para>
</section>



<section id="s-wsgram-user-multijobs"><title>MultiJobs</title>
    <para>The new job description XML schema allows for specification of a <glossterm linkend="multijob">multijob</glossterm>, 
i.e., a job that is itself composed of several executable jobs.
This is useful in order to bundle a group of jobs together and submit 
them as a whole to a remote GRAM installation.</para>
</section>
<section id="s-wsgram-user-jobandprocessrendezvous"><title>Job and process rendezvous</title>
<para>WS GRAM services implement a <ulink url="../wsrendezvous/index.html">rendezvous</ulink> 
mechanism to perform synchronization between job processes in a multiprocess job and 
between subjobs in a multijob. The job application can in fact register binary information, for 
instance process information or subjob information, and get notified when 
all the other processes or subjobs have registered their own information.
This is useful for parallel jobs which need to rendezvous 
at a "barrier" before proceeding with computations, in the case when no 
native application API is available to help do the rendezvous.</para>
</section>
</section>

<section>
   <title>Changed Functionality in GT4</title>
   <section>
     <title>Independent resource keys (4.0.5+ only)</title>
     <important>
       <para>
         This change in functionality is only available starting with GT 4.0.5.
       </para>
     </important>
     <para>  
       WS GRAM enables the client to add a self-generated resource key to the
       input type when submitting a new job request to the
       ManagedJobFactoryService (MJFS). This enables the client to keep in
       contact with the job in case the server fails after the job was created but
       before the EndpointReference (EPR) of the newly created job was sent to
       the client.</para>
       
     <para>The client is then able to create an EPR itself with the
       self-generated job UUID and the address of the
       ManagedExecutableJobService (MEJS) and then query for the state of the job.
     </para>
     <para>
       In former versions of WS GRAM, the job UUID that was generated on the
       client-side was used in WS GRAM as the resource key of the created job
       resource. This has changed: starting with GT 4.0.5, WS GRAM now creates its own job UUID,
       even if the client provides one in the input of its call to the MJFS,
       and returns this job key inside the EPR which is then returned to the client.
       With the self-generated job key, the client can still contact the MJFS and the MJFS will simply use that mapping.
       But the client cannot contact the MEJS with that self-generated job key
       as part of an EPR in order to query for job state.
     </para>
   </section>
</section>  

<section id="s-wsgram-user-usagescenarios"><title>Usage scenarios</title>
  <para>The following scenarios walk you through tasks typically performed by WS GRAM users.</para>
  
  <itemizedlist>
    <listitem><para><link linkend="s-wsgram-user-proxygen">Generating a valid proxy</link></para></listitem>
    <listitem><para><link linkend="s-wsgram-user-simplejob">Submitting a simple job</link></para></listitem>
    <listitem><para><link linkend="s-wsgram-user-jobwithcontact">Submitting a job with the contact string</link></para></listitem>
    <listitem><para><link linkend="s-wsgram-user-specifyingsimplejob">Submitting a job with the job description</link></para></listitem>
    <listitem><para><link linkend="s-wsgram-user-delegating">Delegating credentials</link></para></listitem>
    <listitem><para><link linkend="s-wsgram-user-findingschedulers">Finding which schedulers are interfaced by the WS GRAM installation</link></para></listitem>
    <listitem><para><link linkend="s-wsgram-user-specifyingstaging">Specifying file staging in the job description</link></para></listitem>
    <listitem><para><link linkend="s-wsgram-user-specifyingmultijob">Specifying and submitting a multijob</link></para></listitem>
    <listitem><para><link linkend="s-wsgram-user-lifetime">Lifetime of jobs</link></para></listitem>
    <listitem><para><link linkend="s-wsgram-user-specifyingextensions">Specifying and handling custom job description extensions (4.0.5+, update pkg available)</link></para></listitem>
    <listitem><para><link linkend="s-wsgram-user-softenv">Specifying SoftEnv keys in the job description (4.0.5+ only)</link></para></listitem>
    <listitem><para><link linkend="s-wsgram-user-substitutionvariables">Specifying substitution variables in a job description (new info for 4.0.5+)</link></para></listitem>
    <listitem><para><link linkend="s-wsgram-user-selfgeneratedkey">Specifying a self generated resource key during job submission (new info for 4.0.5+)</link></para></listitem>
  </itemizedlist>

<section id="s-wsgram-user-proxygen"><title>Generating a valid proxy</title>
<para>In order to generate a valid proxy file, use the 
<ulink url="../../security/prewsaa/user-index.html#grid-proxy-init">grid-proxy-init</ulink> 
tool available under <computeroutput>$GLOBUS_LOCATION/bin</computeroutput>:
<screen>
% bin/grid-proxy-init
Your identity: /O=Grid/OU=GlobusTest/OU=simpleCA.mymachine/OU=mymachine/CN=John Doe
Enter GRID pass phrase for this identity:
Creating proxy ................................. Done
Your proxy is valid until: Tue Oct 26 01:33:42 2004
</screen>
</para>
</section>

<section id="s-wsgram-user-simplejob"><title>Submitting a simple job</title>

<para>
  Use the <command>globusrun-ws</command> command to submit a
  simple job without writing a job description document.  With the <option>-c</option> option,
  a job description will be generated assuming the first arg is the executable
  and the remaining are arguments.  For example:
</para>

<screen>
   % globusrun-ws -submit -c /bin/touch touched_it
   Submitting job...Done.
   Job ID: uuid:4a92c06c-b371-11d9-9601-0002a5ad41e5
   Termination time: 04/23/2005 20:58 GMT
   Current job state: Active
   Current job state: CleanUp
   Current job state: Done
   Destroying job...Done.
</screen>

<para>Confirm that the job worked by verifying the file was touched:</para>
  
<screen>
   % ls -l ~/touched_it 
   -rw-r--r--  1 smartin globdev 0 Apr 22 15:59 /home/smartin/touched_it

   % date
   Fri Apr 22 15:59:20 CDT 2005
</screen>

<note><para>
  You did not tell globusrun-ws where to run your job, so the default
  of <computeroutput>localhost</computeroutput> was used.
</para></note>
</section> <!-- s-wsgram-user-simplejob -->


<section id="s-wsgram-user-jobwithcontact"><title>Submitting a job with the contact string</title>

<para>
  Use <command>globusrun-ws</command> to submit the same touch job, but this time specify the 
  contact string.
</para>

<screen>
   % globusrun-ws -submit -F https://lucky0.mcs.anl.gov:8443/wsrf/services/ManagedJobFactoryService -c /bin/touch touched_it
   Submitting job...Done.
   Job ID: uuid:3050ad64-b375-11d9-be11-0002a5ad41e5
   Termination time: 04/23/2005 21:26 GMT
   Current job state: Active
   Current job state: CleanUp
   Current job state: Done
   Destroying job...Done.
</screen>

<para>
  Try the same job to a remote host.  Type <screen>globusrun-ws -help</screen> to learn the
  details about the contact string.
</para>

</section>
    <!-- s-wsgram-user-jobwithcontact -->

    <section id="s-wsgram-user-specifyingsimplejob"><title>Submitting a job with the job description</title>

<para>The user writes the specifications of a job submission to a job description XML file.</para>
<para>Here is an example of a simple job description:</para>
<screen>
&lt;job&gt;
    &lt;executable&gt;/bin/echo&lt;/executable&gt;
    &lt;argument&gt;this is an example_string &lt;/argument&gt;
    &lt;argument&gt;Globus was here&lt;/argument&gt;
    &lt;stdout&gt;${GLOBUS_USER_HOME}/stdout&lt;/stdout&gt;
    &lt;stderr&gt;${GLOBUS_USER_HOME}/stderr&lt;/stderr&gt;
&lt;/job&gt;
</screen>

<para>
  Tell <command>globusrun-ws</command> to read the job description from a file, using the <option>-f</option>
  option:
</para>

<screen>
% bin/globusrun-ws -submit -f test_super_simple.xml
Submitting job...Done.
Job ID: uuid:c51fe35a-4fa3-11d9-9cfc-000874404099
Termination time: 12/17/2004 20:47 GMT
Current job state: Active
Current job state: CleanUp
Current job state: Done
Destroying job...Done.
</screen>
<para>

Note the usage of the substitution variable <computeroutput>${GLOBUS_USER_HOME}</computeroutput> 
which resolves to the user home directory.</para>
<para>
Here is an example with more job description parameters:</para>
<screen>
&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;job&gt;
    &lt;executable&gt;/bin/echo&lt;/executable&gt;
    &lt;directory&gt;/tmp&lt;/directory&gt;
    &lt;argument&gt;12&lt;/argument&gt;
    &lt;argument&gt;abc&lt;/argument&gt;
    &lt;argument&gt;34&lt;/argument&gt;
    &lt;argument&gt;this is an example_string &lt;/argument&gt;
    &lt;argument&gt;Globus was here&lt;/argument&gt;
    &lt;environment&gt;
        &lt;name&gt;PI&lt;/name&gt;
        &lt;value&gt;3.141&lt;/value&gt;
    &lt;/environment&gt;
    &lt;stdin&gt;/dev/null&lt;/stdin&gt;
    &lt;stdout&gt;stdout&lt;/stdout&gt;
    &lt;stderr&gt;stderr&lt;/stderr&gt;
    &lt;count&gt;2&lt;/count&gt;
&lt;/job&gt;
</screen>

<para>Note that in this example, 
<itemizedlist>  
  <listitem><para>A <computeroutput>&lt;directory&gt;</computeroutput> element specifies that the command will be
    executed in the <computeroutput>/tmp</computeroutput> directory on the execution machine.</para></listitem>
  
  <listitem><para>An <computeroutput>&lt;stdout&gt;</computeroutput> element specifies the standard output as the relative path 
  <computeroutput>stdout</computeroutput>. </para></listitem>
  </itemizedlist>
  The output is therefore written to <computeroutput>/tmp/stdout</computeroutput>: 
</para>
<screen>
% cat /tmp/stdout
12 abc 34 this is an example_string  Globus was here
</screen>

    </section>
    <section id="s-wsgram-user-delegating"><title>Delegating credentials</title>
<para>
  There are three different uses of delegated credentials: </para>
<orderedlist>      
    <listitem><para> for use by the <glossterm linkend="mejs">MEJS</glossterm> to create a remote user proxy, </para></listitem>
    <listitem><para>for use by the MEJS to contact RFT, and </para></listitem>
    <listitem><para> for use by RFT to contact the GridFTP servers.  </para></listitem>
      </orderedlist>
     <para> The EPRs to each of these are
specified in three job description elements--they are:
<itemizedlist>       
       <listitem><para><computeroutput>jobCredentialEndpoint</computeroutput></para></listitem>
       <listitem><para><computeroutput>stagingCredentialEndpoint</computeroutput></para></listitem>
       <listitem><para><computeroutput>transferCredentialEndpoint</computeroutput></para></listitem>
       </itemizedlist>
       respectively.  Please
see the <ulink url="#s-wsgram-Public_Interfaces-domain-schema">job description
schema</ulink> and <ulink url="schemas/rft_types.html">RFT
transfer request schema</ulink> documentation for more details about these
elements.</para>


<para>
The <command>globusrun-ws</command> command can either delegate
these credentials automatically for a particular job or reuse
pre-delegated credentials (see next paragraph) through the use of command-line
arguments for specifying the credentials' EPR files.  Please see the
  <link linkend="globusrun-ws"> globusrun-ws
documentation</link> for details on these command-line arguments.
</para>

<para>It is possible to use delegation 
  <ulink url="../../security/delegation/WS_AA_Delegation_Service_Interface_Commandline_Frag.html">command-line
clients</ulink> to obtain and refresh delegated credentials in order to use them
when submitting jobs to WS GRAM. This enables the submission of
many jobs using a shared set of delegated credentials.  This can significantly
decrease the number of remote calls for a set of jobs, thus improving
performance.
</para>


</section>
<section id="s-wsgram-user-findingschedulers"><title>Finding which schedulers are interfaced by the WS GRAM installation</title>

<para>
   Unfortunately there is no option yet to print the list of local resource 
   managers supported by a given WS-GRAM service installation. But there is a way to check whether or not WS-GRAM
   supports a certain local resource manager. The following command gives an example of how a client
   could find out if Condor is available at the remote site:
   <screen>
wsrf-query \
    -s https://&lt;hostname&gt;:&lt;port&gt;/wsrf/services/ManagedJobFactoryService \
    -key {http://www.globus.org/namespaces/2004/10/gram/job}ResourceID Condor \
    "//*[local-name()='version']"
   </screen>
   Replace host and port settings with the values you need.
   If Condor is available on the server-side, the output should look something like the following: 
   <screen>
  &lt;ns1:version xmlns:ns1="http://mds.globus.org/metadata/2005/02"&gt;4.0.3&lt;/ns1:version&gt;
   </screen>
   In this example, the output indicates that a GT is listening on the server-side, that Condor is
   available and that the GT version is 4.0.3.
   If no GT is running at all on the specified host and/or port or if the specified local resource manager
   is not available on the server-side, the output will be an error message.
</para>	
<para>On the server-side, the <emphasis>GRAM name</emphasis> 
of  local resource managers for which GRAM support has been installed can be obtained 
by looking at the GRAM configuration on the GRAM server-side machine, as explained 
    <link linkend="s-wsgram-Interface_Config_Frag-managerconfig">here</link>.
</para><para>
The GRAM name of the local resource manager can be used with the <emphasis>factory type</emphasis> 
option of the job submission command-line tool to specify which factory resource to 
use when submitting a job. 
</para>

</section>
<section id="s-wsgram-user-specifyingstaging"><title>Specifying file staging in the job description</title>

<para>In order to do file staging, one must add specific elements to the job description and delegate credentials appropriately (see
<ulink url="#s-wsgram-user-delegating">Delegating credentials</ulink>). The 
file transfer directives follow the <ulink url="schemas/rft_types.html">RFT
syntax</ulink>, which allows only for third-party transfers.  Each file transfer
must therefore specify a source URL and a destination URL.  URLs are specified
as GridFTP URLs (for remote files) or as file URLs (for files local to the
service--these are converted internally to full GridFTP URLs by the service).
</para>
<para>
For instance, in the case of staging a file <emphasis>in</emphasis>, the source
URL would be a GridFTP URL (for example, 
<filename>gsiftp://job.submitting.host:2811/tmp/mySourceFile</filename>) resolving to a source document accessible on the file system
of the job submission machine (for instance <filename>/tmp/mySourceFile</filename>). 
  At run-time, the Reliable File Transfer service used by the
MEJS on the remote machine would reliably fetch the remote file using the
GridFTP protocol and write it to the specified local file (for example,  
<filename>file:///${GLOBUS_USER_HOME}/my_transfered_file</filename>,
which resolves to  <filename>~/my_transfered_file</filename>). Here
is how the stage-in directive would look:

<screen>
  &lt;fileStageIn&gt;
      &lt;transfer&gt;
          &lt;sourceUrl&gt;<computeroutput>gsiftp://job.submitting.host:2811/tmp/mySourceFile</computeroutput>&lt;/sourceUrl&gt;
          &lt;destinationUrl&gt;<computeroutput>file:///${GLOBUS_USER_HOME}/my_transfered_file</computeroutput>&lt;/destinationUrl&gt;
      &lt;/transfer&gt;
  &lt;/fileStageIn&gt;
</screen> 
</para>
<note><para>Additional RFT-defined quality of service requirements may be specified 
      for each transfer. See the <ulink url="../../data/rft/">RFT</ulink> documentation for more information.
</para></note>
<para>
Here is an example job description with file stage-in and stage-out:</para>

<screen>
&lt;job&gt;
    &lt;executable&gt;my_echo&lt;/executable&gt;
    &lt;directory&gt;${GLOBUS_USER_HOME}&lt;/directory&gt;
    &lt;argument&gt;Hello&lt;/argument&gt;
    &lt;argument&gt;World!&lt;/argument&gt;
    &lt;stdout&gt;${GLOBUS_USER_HOME}/stdout&lt;/stdout&gt;
    &lt;stderr&gt;${GLOBUS_USER_HOME}/stderr&lt;/stderr&gt;
    &lt;fileStageIn&gt;
        &lt;transfer&gt;
            &lt;sourceUrl&gt;gsiftp://job.submitting.host:2811/bin/echo&lt;/sourceUrl&gt;
            &lt;destinationUrl&gt;file:///${GLOBUS_USER_HOME}/my_echo&lt;/destinationUrl&gt;
        &lt;/transfer&gt;
    &lt;/fileStageIn&gt;
    &lt;fileStageOut&gt;
        &lt;transfer&gt;
            &lt;sourceUrl&gt;file:///${GLOBUS_USER_HOME}/stdout&lt;/sourceUrl&gt;
            &lt;destinationUrl&gt;gsiftp://job.submitting.host:2811/tmp/stdout&lt;/destinationUrl&gt;
        &lt;/transfer&gt;
    &lt;/fileStageOut&gt;
    &lt;fileCleanUp&gt;
        &lt;deletion&gt;
            &lt;file&gt;file:///${GLOBUS_USER_HOME}/my_echo&lt;/file&gt;
        &lt;/deletion&gt;
    &lt;/fileCleanUp&gt;
&lt;/job&gt;
</screen>

<para>Note that the job description XML does not need to include a reference to the schema 
  that describes its syntax. As a matter of fact, it is also possible to omit the namespace 
  in the GRAM job description XML elements. The submission of this job to the GRAM services causes the following sequence 
  of actions:
</para>
<orderedlist>
<listitem><simpara> The <computeroutput>/bin/echo</computeroutput> executable is transferred from the submission machine 
    to the GRAM host file system. The destination location is the HOME directory of the 
    user on behalf of whom the GRAM services executed the job 
    (see <computeroutput>&lt;fileStageIn&gt;</computeroutput>).</simpara></listitem>
<listitem><simpara> The transferred executable is used to print a test string  
     (see <computeroutput>&lt;executable&gt;</computeroutput>, <computeroutput>&lt;directory&gt;</computeroutput> and 
      the <computeroutput>&lt;argument&gt;</computeroutput> elements) on the standard output, which is 
      redirected to a local file (see <computeroutput>&lt;stdout&gt;</computeroutput>).</simpara></listitem>
<listitem><simpara> The standard output file is transferred to the submission machine 
     (see <computeroutput>&lt;fileStageOut&gt;</computeroutput>).</simpara></listitem>
<listitem><simpara> The file that was initially transferred during the stage-in phase is removed 
     from the file system of the GRAM installation (see <computeroutput>&lt;fileCleanup&gt;</computeroutput>).</simpara></listitem>
</orderedlist>
</section>

  <section id="s-wsgram-user-specifyingmultijob"><title>Specifying and submitting a multijob</title>
    <para>The job description XML schema allows for specification of a <emphasis>multijob</emphasis>
      i.e. a job that is itself composed of several executable jobs, which we 
      will refer to as <emphasis>subjobs</emphasis>.</para>
      
      <note><para>Subjobs cannot be multijobs, so the structure is not recursive.</para></note>
        
    <para>This is useful, for example, if you want to bundle a group of jobs together and submit 
    them as a whole to a remote GRAM installation.</para>
    
<note>    <para>
      No relationship can be specified between the subjobs of a multijob.
      The subjobs are submitted to job factory services 
      in order of appearance in the multijob description.</para></note>
    <para>
      Within a <ulink url="schemas/gram_job_description.html#element_multiJob">multijob description</ulink>, 
      each subjob description must include an endpoint to which the factory submits the subjob. This 
      enables the at-once submission of several jobs to different hosts.
      The factory to which the multijob is submitted acts as an intermediary tier 
      between the client and the eventual executable job factories. </para>
    <para>
      Here is an example of a multijob description:</para>
    
    <screen>
      &lt;?xml version="1.0" encoding="UTF-8"?&gt;
      &lt;multiJob xmlns:gram="http://www.globus.org/namespaces/2004/10/gram/job" 
      xmlns:wsa="http://schemas.xmlsoap.org/ws/2004/03/addressing"&gt;
      &lt;factoryEndpoint&gt;
      &lt;wsa:Address&gt;
      https://localhost:8443/wsrf/services/ManagedJobFactoryService
      &lt;/wsa:Address&gt;
      &lt;wsa:ReferenceProperties&gt;
      &lt;gram:ResourceID&gt;Multi&lt;/gram:ResourceID&gt;
      &lt;/wsa:ReferenceProperties&gt;
      &lt;/factoryEndpoint&gt;
      &lt;directory&gt;${GLOBUS_LOCATION}&lt;/directory&gt;
      &lt;count&gt;1&lt;/count&gt;
      
      &lt;job>
      &lt;factoryEndpoint&gt;
      &lt;wsa:Address&gt;https://localhost:8443/wsrf/services/ManagedJobFactoryService&lt;/wsa:Address&gt;
      &lt;wsa:ReferenceProperties&gt;
      &lt;gram:ResourceID&gt;Fork&lt;/gram:ResourceID&gt;
      &lt;/wsa:ReferenceProperties&gt;
      &lt;/factoryEndpoint&gt;
      &lt;executable&gt;/bin/date&lt;/executable&gt;
      &lt;stdout&gt;${GLOBUS_USER_HOME}/stdout.p1&lt;/stdout&gt;
      &lt;stderr&gt;${GLOBUS_USER_HOME}/stderr.p1&lt;/stderr&gt;
      &lt;count&gt;2&lt;/count&gt;
      &lt;/job&gt;
      
      &lt;job&gt;
      &lt;factoryEndpoint&gt;
      &lt;wsa:Address&gt;https://localhost:8443/wsrf/services/ManagedJobFactoryService&lt;/wsa:Address&gt;
      &lt;wsa:ReferenceProperties&gt;
      &lt;gram:ResourceID>Fork&lt;/gram:ResourceID&gt;
      &lt;/wsa:ReferenceProperties&gt;
      &lt;/factoryEndpoint&gt;
      &lt;executable&gt;/bin/echo&lt;/executable&gt;
      &lt;argument&gt;Hello World!&lt;/argument&gt;        
      &lt;stdout&gt;${GLOBUS_USER_HOME}/stdout.p2&lt;/stdout&gt;
      &lt;stderr&gt;${GLOBUS_USER_HOME}/stderr.p2&lt;/stderr&gt;
      &lt;count&gt;1&lt;/count&gt;
      &lt;/job&gt;
      
      &lt;/multiJob&gt;
    </screen>
    <para><emphasis>Notes:</emphasis>
    </para>
    <itemizedlist>
      <listitem><simpara>The <computeroutput>&lt;ResourceID&gt;</computeroutput> element within the <computeroutput>&lt;factoryEndpoint&gt;</computeroutput> WS-Addressing endpoint structures must be qualified with the 
        appropriate GRAM namespace.</simpara></listitem>
      <listitem><simpara>Apart from the <computeroutput>&lt;factoryEndpoint&gt;</computeroutput> element, all elements at the enclosing multijob level 
        act as defaults for the subjob parameters, in this example <computeroutput>&lt;directory&gt;</computeroutput> and <computeroutput>&lt;count&gt;</computeroutput>.</simpara></listitem>
      <listitem><simpara>The default <computeroutput>&lt;count&gt;</computeroutput> value is overridden in the subjob descriptions.</simpara></listitem>
    </itemizedlist>
    <para>
      
      In order to submit a multijob description, use a job submission <link linkend="r-wsgram-commandline">command-line tool</link> 
      and specify the Managed Job Factory resource to be <computeroutput>Multi</computeroutput>.
      
      For example, submitting the multijob description above using <computeroutput>globusrun-ws</computeroutput>, we obtain:</para>
    
    <screen>
      % bin/globusrun-ws -submit -f test_multi.xml
      Delegating user credentials...Done.
      Submitting job...Done.
      Job ID: uuid:bd9cd634-4fc0-11d9-9ee1-000874404099
      Termination time: 12/18/2004 00:15 GMT
      Current job state: Active
      Current job state: CleanUp
      Current job state: Done
      Destroying job...Done.
      Cleaning up any delegated credentials...Done.
    </screen>
    
    <para>A multijob resource is created by the factory and exposes a set of 
      WSRF resource properties different than the resource properties of 
      an executable job. The state machine of a multijob is also different 
      since the multijob represents the <emphasis>overall</emphasis> execution of all the 
      executable jobs of which it is composed.
      
    </para>
  </section>

  <section id="s-wsgram-user-lifetime"><title>Lifetime of jobs</title>
    <para>
       Jobs submitted to WS-GRAM have a lifetime. If the lifetime of a ManagedJob
       resource expires the job will be destroyed after cleanup steps had been
       performed and the job's persistence data will removed.
    </para>
    <para>
       For executable jobs the user-relevant steps in cleanup are:
       <itemizedlist>
         <listitem><simpara>
             Cancellation of the job at the local resource manager if it's
             still running.      
         </simpara></listitem>
         <listitem><simpara>
             Performing fileCleanUp if specified in the job description
         </simpara></listitem>
       </itemizedlist>
       If a multi job expires all sub-jobs will be destroyed.
    </para>
    <para>
       The default C-client <computeroutput>globusrun-ws</computeroutput> and the
       Java API GramJob (for developers) set this value by default to 24 hours. If
       a user wants a job to have a longer lifetime it must explicitly specify it.
    </para>
    
    <section id="s-wsgram-user-lifetime-submission">
      <title>Specifying a lifetime in submission</title>
      <para>
        Using the C-client globusrun-ws the lifetime of a job can be set in 2 ways
        in job submission. The first example shows how to set a relative lifetime,
        i.e. the job will expire in 48h from now:
      </para>
      <screen>globusrun-ws -submit -term "+48:00" -b -o myJob.epr -f myJob.xml</screen>
      <para>
        The second example shows how to set an absolute lifetime. The job will expire
        at the given date:
      </para>
      <screen>globusrun-ws -submit -term "10/23/2008 12:00" -b -o myJob.epr -f myJob.xml</screen>
      <para>
        In both example the job had been submitted in batch mode, which makes sense
        for longer running jobs.
      </para>
      <note><para>
        Specyfing the lifetime in the short way using
        <computeroutput>+HH:MM</computeroutput> should not be used with
        globusrun-ws before GT version 4.0.7. See
        <ulink url="http://bugzilla.globus.org/globus/show_bug.cgi?id=5711">
        here</ulink> for more information.
      </para></note>
    </section>
    
    <section id="s-wsgram-user-lifetime-wsrf">
      <title>Setting a lifetime on an existing job</title>
      <para>
        The lifetime of a job can also be changed after the submission. The following
        example shows how to set a new termination time of a job resource, assuming
        that the Endpoint Reference (EPR) of the job is stored in the file
        <computeroutput>myJob.epr</computeroutput>. The new lifetime is provided in
        seconds (604800 in this example [one week]):
      </para>
      <screen>[martin@osg-test1 ~]$ wsrf-set-termination-time -e myJob.epr 604800</screen>
      <para>
        The output could be something like this:
      </para>
      <screen>requested: Tue May 13 09:27:15 CDT 2008
scheduled: Tue May 13 09:27:15 CDT 2008</screen>
    </section>
    
  </section>
  
  <section id="s-wsgram-user-substitutionvariables"><title>Specifying substitution variables in a job description</title>
    
    <para>
      Job description variables are special strings in a job description that are
      replaced by the GRAM service with values that the client-side does not
      <emphasis>a priori</emphasis> know. Job description variables can be used
      in any path-like string or URL specified in the job description.
    </para>
    <para>
      An example of a variable is
      <computeroutput>${GLOBUS_USER_HOME}</computeroutput>, which represents the
      path to the HOME directory on the file system where the job is executed.
      The set of variables is fixed in the GRAM service implementation.  This is 
      different from previous implementations of <glossterm linkend="rsl">RSL</glossterm>
      substitutions in GT2 and GT3,
      where a user could define a new variable for use inside a job description
      document.  This was done to preserve the simplicity of the job description
      XML schema (relative to the GT3.2 RSL schema), which does not require a 
      specialized XML parser to serialize a job description document.
    </para>
    <para>
      Details of the RSL variables are in the
      <ulink url="schemas/gram_job_description.html#SchemaProperties">job
        description doc</ulink> and the
      <ulink url="admin-index.html#s-wsgram-admin-substitution-variables">substitution
        variable section</ulink> of the admin guide.
    </para>
    
    
     
<important><title>If you are using 4.0.5+:</title>
  <para>
    Beginning with version 4.0.5, additional variables can be defined on the
        server side for use in the job description. 
  </para>
  <para>
    Currently, users cannot get information from WS GRAM about whether or not additional variables are defined on the 
    server side and, if so, what their names and values are. For now, this information must be published by the provider.
  </para>
</important>
    
    
  </section>
  
  <section id="s-wsgram-user-selfgeneratedkey"><title>Specifying a self-generated resource key during job submission</title>
    
    <para>
      WS GRAM enables a client to add a self-generated resource key to the input
      type when submitting a new job request to the ManagedJobFactoryService (MJFS).
      The client should make sure to provide a universal unique identifier (UUID) as the 
      job resource key. For information about UUID's please read 
      <ulink url="http://en.wikipedia.org/wiki/Universally_Unique_Identifier">here</ulink>.
    </para>
    <para>
      Providing its own UUID enables a client to resubmit a job in case the server did
      not respond to a prior job submission request (due to network failures, for example). If
      the client submits a job with an already existing resource key a second time,
      the job will not be started again because it is already running. This avoids
      unnecessary and undesired resource usage and enables a reliable job submission.
    </para>
    
    <important><title>If you are using 4.0.5+:</title>
      <para>
        Beginning with version 4.0.5, WS GRAM now creates its own job
        UUID, even if the client provides one in the input of its call to the MJFS, and
        returns this job UUID inside the endpoint reference (EPR) to the client.
        The client can still contact the ManagedJobFactoryService (MJFS)
        with the self-generated job resource key in order to resubmit a potentially not
        'lost' and submitted job. But the client can no longer contact the ManagedExecutableJobService (MEJS) with that
        self-generated job key as part of an EPR in order to query for job state. </para>
        
      <para>If it is unclear whether a job request has been started by the server,
        the client must submit the job with the same job UUID again in order to get
        an EPR from the MJFS. The client can then query for job state or
        destroy the job.
      </para>
    </important>
    

    
  </section>
  
  
<section id="s-wsgram-user-specifyingextensions"><title>Specifying and handling custom job description extensions (4.0.5+, update pkg available)</title>

  <important>
    <para>
      This feature has been added as of GT 4.0.5. For versions older than 4.0.5, an update package 
      is available to upgrade your installation. See the
      <ulink url="http://www.globus.org/toolkit/downloads/development/">GT Development Downloads</ulink>
      page for the latest links.
    </para>
  </important>

<para>
Basic support is provided for specifying custom extensions to the job
description. There are plans to improve the usability of this feature, but at
this time it involves a bit of work.
</para>
<para>
Specifying the actual custom elements in the job description is trivial. Simply add any elements that you need between the beginning and ending
<computeroutput>extensions</computeroutput> tags at the bottom of the job
description as in the following basic example:
<screen>
&lt;job&gt;
    &lt;executable&gt;/home/user1/myapp&lt;/executable&gt;
    &lt;extensions&gt;
        &lt;myData&gt;
            &lt;var1&gt;hello&lt;/var1&gt;
            &lt;var2&gt;world&lt;/var2&gt;
        &lt;/myData&gt;
    &lt;/extensions&gt;
&lt;/job&gt;
</screen>
</para>
<para>
To handle this data, you must alter the appropriate perl scheduler
script (i.e. fork.pm for the Fork scheduler, etc...) to parse the data returned 
from the <computeroutput>$description->extensions()</computeroutput> sub.
</para>

<para>
  More information about job description extension support can be found <link linkend="r-wsgram-extensions">here</link>.
</para>

</section>

<!--
<section id="s-wsgram-user-jobidsub">
<title>Per-job customization with job ID substitution variable.</title>
<para>
To allow for customization of values, such as paths, on a per-job basis; a job
description substitution variable named "GLOBUS_JOB_ID" can be used.
</para>
<para>
For example:
</para>
<para>
<screen>
&lt;job&gt;
    &lt;executable>/bin/date&lt;executable&gt;
    &lt;stdout>/tmp/stdout.${GLOBUS_JOB_ID}&lt;stdout&gt;
    &lt;stderr>/tmp/stderr.${GLOBUS_JOB_ID}&lt;stderr&gt;
    &lt;fileStageOut&gt;
        &lt;transfer&gt;
            &lt;sourceUrl&gt;file:///tmp/stdout.${GLOBUS_JOB_ID}&lt;sourceUrl&gt;
         &lt;destinationUrl&gt;gsiftp://mymachine.mydomain.com/out.${GLOBUS_JOB_ID}&lt;destinationUrl&gt;
        &lt;transfer&gt;
    &lt;fileStageOut&gt;
&lt;job>
</screen>
</para>
</section>
-->


<section id="s-wsgram-user-softenv"><title>Specifying SoftEnv keys in the job description (4.0.5+ only)</title>

<note>  <para>
     This feature is only available beginning with
     version 4.0.5 of the toolkit.
  </para></note>
   
  <para>
    For a short introduction to SoftEnv please have a look at the
    <link linkend="r-wsgram-softenv">SoftEnv
      chapter</link>.
  </para>
  <para>
    If SoftEnv is enabled on the server-side, nothing needs to be added to a job
    description to set up the environment which is specified in the
    <computeroutput>.soft</computeroutput> file in the remote home directory of
    the user before the job is submitted to the scheduler.</para>
   
  <para>If a different software
    environment should be used than the one specified in the remote
    <computeroutput>.soft</computeroutput> file, the user must provide 
    SoftEnv parameters in the extensions element of the job
    description. </para>
    
  <para>The schema of the extension element for software selection
    in the job description is as follows:
  </para>
  <screen>&lt;element name="softenv" type="xsd:string"&gt;</screen>
  <para>  
    For example, to add the SoftEnv commands <command>@teragrid-basic</command>,
    <command>+intel-compilers</command>, <command>+atlas</command>, and <command>+tgcp</command> to the job process'
    environment, the user would specify the following <computeroutput>&lt;extensions&gt;</computeroutput> element
    in the job description:
  </para>
  <screen>&lt;extensions&gt;
  &lt;softenv&gt;@teragrid-basic&lt;/softenv&gt;
  &lt;softenv&gt;+intel-compilers&lt;/softenv&gt;
  &lt;softenv&gt;+atlas&lt;/softenv&gt;
  &lt;softenv&gt;+tgcp&lt;/softenv&gt;
&lt;/extensions&gt;</screen>
  <para>
    So far there is no way for a user to learn from the remote service
    itself whether or not SoftEnv support is enabled. Currently, the only way to check this is to submit a job 
    with <computeroutput>/bin/env</computeroutput> as the executable and watch the results.
  </para>
  
  <para>The following table describes what happens in various scenarios if SoftEnv is disabled or enabled on the server side:</para>
  
  <informaltable>
    <tgroup cols="3">
      <thead>
        <row>
          <entry>&nbsp;</entry>
          <entry>Disabled on server side</entry>
          <entry>Enabled on server side</entry>
        </row>
      </thead>
      <tbody>
        <row>
          <entry><para><emphasis role="strong">User provides no SoftEnv extensions:</emphasis></para></entry>
          <entry>
            <para>No SoftEnv environment is configured before job submission, even
            if the user has a <computeroutput>.soft</computeroutput> file in their
              remote home directory.</para>
          </entry>
          <entry>
            <para>If the user has a <computeroutput>.soft</computeroutput> file (and no
            <computeroutput>.nosoft</computeroutput> file) in their remote home directory,
            then the environment defined in the <computeroutput>.soft</computeroutput>
              file will be configured before job submission.</para>
            <para>If the user has a <computeroutput>.nosoft</computeroutput> file in their remote
            home directory, no environment will be prepared.
          </para></entry>
        </row>
        
        <row>
          <entry><para><emphasis role="strong">User provides valid SoftEnv extensions:</emphasis></para></entry>
          <entry>
            <para>
              If SoftEnv is not installed on the server then no environment
              will be configured
            </para>
            <para>
              If SoftEnv is installed, the environment the user specifies in the <computeroutput>&lt;extensions&gt;</computeroutput>
              elements overwrites any SoftEnv configuration the user
              specifies in a <computeroutput>.soft</computeroutput> or 
              <computeroutput>.nosoft</computeroutput> file in their remote home directory.
              The environment will be configured as specified by the user in the 
              <computeroutput>&lt;extensions&gt;</computeroutput> elements before job submission.
            </para>     
          </entry>
          <entry>
            <para>
              The specified environment overwrites any SoftEnv configuration the user
              specifies in a <computeroutput>.soft</computeroutput> or a 
              <computeroutput>.nosoft</computeroutput> file in their remote home directory.
              The environment will be configured as specified by the user in the 
              <computeroutput>&lt;extensions&gt;</computeroutput> elements before job submission.
            </para>
          </entry>
        </row>
  
        <row>
          <entry><para><emphasis role="strong">User provides invalid SoftEnv extensions:</emphasis></para></entry>
          <entry>
            <para>
              If SoftEnv is not installed on the server, then no environment
              will be configured.
            </para>
            <para>
              If SoftEnv is installed, the environment the user specifies in the <computeroutput>&lt;extensions&gt;</computeroutput>
              elements overwrites any SoftEnv configuration the user
              specifies in a <computeroutput>.soft</computeroutput> or a 
              <computeroutput>.nosoft</computeroutput> file in their remote home directory.
              Only the valid keys in the SoftEnv <computeroutput>&lt;extensions&gt;</computeroutput> elements will be configured.
              If no valid key is found, no environment will be configured.
              SoftEnv warnings are logged to the stdout of the job.
            </para>
          </entry>
          <entry>
            <para>
              The specified environment overwrites any SoftEnv configuration the user
              specifies in a <computeroutput>.soft</computeroutput> or a 
              <computeroutput>.nosoft</computeroutput> file in their remote home directory.
              Only the valid keys in the SoftEnv <computeroutput>&lt;extensions&gt;</computeroutput> elements will be configured.
              If no valid key is found, no environment will be configured.
              SoftEnv warnings are logged to stdout of the job.
            </para>
          </entry>
        </row>
        
        <row>
          <entry>&nbsp;</entry>
          <entry>
            <para>
              In general, jobs do not fail if they have SoftEnv extensions in their description and SoftEnv is disabled (or not even installed) 
              on the server side. But they will fail if they rely on environments being set up before job submission.
            </para>
          </entry>
          <entry>
            &nbsp;
          </entry>
        </row>
      </tbody>
    </tgroup>
    </informaltable>
  
<note>
  <para>In the current implementation, it is not possible to call executables
    directly whose paths are defined in SoftEnv without specifiying the
    complete path to the executable.
  </para>

  <para>
    For example, if a database query must
    be executed using the
    <command>mysql</command> command and <command>mysql</command> is not in the default path, then the direct use of
    mysql as an executable in the jobs description document will fail, even if
    the use of SoftEnv is configured. The <command>mysql</command> command must be written to a
    script which is in the default path. </para>
    
  <para>Thus a job submission with the
    following job description document will fail:
  </para>
  <screen>
&lt;job&gt;
  ...
  &lt;executable&gt;mysql&lt;/executable&gt;
  ...
&lt;/job&gt;
  </screen>
  <para>
    But when the command is embedded inside a shell script which is
    specified as the executable in the job description document, it will work:
  </para>
  <screen>
#!/bin/sh
  ...
  mysql ...
    ...
  </screen>
</note>
  
<note>
  <para>The use of invalid SoftEnv keys in the extension part of the job
    description document does not generate errors.
  </para>
</note>
  
  <!--
  <section>
    <title>Open Questions</title>
    <para>
      <itemizedlist>
        <listitem>
          <para>
            What about the packages  for Condor and PBS on
            <ulink url="http://www.globus.org/toolkit/downloads/development/">
            http://www.globus.org/toolkit/downloads/development/</ulink>?
          </para>
        </listitem>
        <listitem>   
          <para>
            Is the extension package globus_gram_job_manager_scripts-0.3
            now part of a the software or must it be downloaded separately?
          </para>
        </listitem>
        <listitem>
          <para>Provide link to SoftEnv?</para>
        </listitem>
        <listitem>
          <para>
            What about the predefined softenv key in the JNDI configuration?
            Is it already there? I can't find it in JNDI.
            (<ulink url="http://bugzilla.mcs.anl.gov/globus/show_bug.cgi?id=4207">
            http://bugzilla.mcs.anl.gov/globus/show_bug.cgi?id=4207</ulink>)
          </para>
        </listitem>
        <listitem>
          <para>  
            I can't see that the mappings added to the
            idempotenceIdMap are removed at any time. Should we add this in
            the remove()-method of the MEJR?
          </para>
        </listitem>
      </itemizedlist>
    </para>
   </section>
   -->
 </section>

</section>


<section id="s-wsgram-user-commandline"><title>Command-line tools</title>
    <para>Please see the <xref linkend="r-wsgram-commandline"/>.</para>

</section>

<section id="s-wsgram-user-gui"><title>Graphical user interfaces</title>
&WS_GRAM_Interface_GUI_Frag;
</section>

<section id="s-wsgram-user-troubleshooting"><title>Troubleshooting</title> &WS_GRAM_Troubleshooting_Frag;
</section>

<section id="s-wsgram-user-usage"><title>Usage statistics collection by the Globus Alliance</title>
&WS_GRAM_Usage_Statistics_Frag;
</section>

