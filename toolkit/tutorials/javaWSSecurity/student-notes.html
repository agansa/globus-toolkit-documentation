<?php



$title="Tutorial: Java WS Security in GT4 - Student Notes";



include_once( "/mcs/www-unix.globus.org/include/globus_header.inc" );



?>



<h1><?php echo $title; ?></h1>
<ul>
<li><a href="#conventions">Document Conventions</a></li>
<li><a href="#exercise1">Exercise 1: Setup</a></li>
<li><a href="#exercise2">Exercise 2: Authentication</a></li>
<li><a href="#exercise3">Exercise 3: Authorization</a></li>
<li><a href="#exercise4">Exercise 4: Resource-level security</a></li>
<li><a href="#exercise5">Exercise 5: Notification security</a></li>
<li><a href="#exercise6">Exercise 6: Host certificates</a></li>
<li><a href="#exercise7">Exercise 7: Anonymous access</a></li>
<li><a href="#exercise8">Exercise 8: GSI Secure Message Security</a></li>
<li><a href="#exercise9">Exercise 9: The Bank Service</a></li>
<li><a href="#exercise10">Exercise 10: The Finance Service</a></li>
<li><a href="#troubleshooting">Troubleshooting!</a></li>
</ul>

<h2><a name="conventions"></a>Document Conventions</h2>
<ul>
<li>For the hands-on exercises:</li>
<ul>
<li>Instructions for the hands-on exercises are written in black</li>
<li>The first several exercises requires that you issue commands from two different command windows running on your machine:</li>
<blockquote>
<p class="command">
One window will be used to run Globus Toolkit software and will be referred to as the <i>GT window</i> in these notes.  Commands typed in the GT window will be bounded by a box of this color.
</p>

<p class="ex1-command">
The second window will be used to modify and execute student code and will be referred to as the <i>Exercise window</i>.  Exercise commands will be bounded by a box of this color.
</p>

<p class="ex2-command">
Later in the tutorial, we will use a third window to indicate commands
your neighbor will run against your container to test things.
</p>
<p>
<font color="red">Red command text can be cut and pasted directly into your command window</font><br>
Black command text indicates that intelligent replacement is required
</p>
<p>You might consider coloring the backgrounds of your
Terminal/Command/Xterm windows to match the colors used in the
tutorial. Though not necessary, you may find this helpful in
identifying windows.</p>
</blockquote>
</ul>


<h2><a name="exercise1" id="exercise1"></a>Exercise 1: Setup</h2>

<p>Overview: In this exercise you will install the demo service that will be
used for the rest of the tutorial.  You will also acquire an X.509 credential
and verify that you can start the webservices container and interact with
a secure service.</p>

<p>If you haven't yet done so, now is the time to:</p>
<p class="command">
Open a command window for running the Globus container (the <b>GT window</b>)
</p>

<p class="ex1-command">
Open a second window for building, modify and executing demonstration code (the <b>Exercise window</b>)
</p>

<h3>Untar the gt install tarball in the GT window:</h3>

<p class="command">
Download the
<a href="gt-install.tar.gz">GT software</a>
from the tutorial website.  In your GT window execute the following:
<br>
$ <font color="red">mkdir /tmp/tutorial</font><br>
$ <font color="red">cd /tmp/tutorial</font><br>
$ <font color="red">tar xzf ws-core-4.0.3-bin.tar.gz</font><br>
tar: A lone zero block at 33981
</p>

<h3>Set environment variables in the GT window:</h3>
<p class="command">
$ <font color="red">cd ws-core-4.0.3</font><br>
$ <font color="red">export GLOBUS_LOCATION=$PWD</font><br>
$ <font color="red">echo $GLOBUS_LOCATION</font><br>
/tmp/tutorial/ws-core-4.0.3
</p>

<h3>Untar the tutorial tarball in the Exercise window:</h3>

<p class="ex1-command">
Download the
<a href="securityTutorial.tar.gz">GT Tutorial software</a>
from the tutorial website.  In your GT window execute the following:
<br>
$ <font color="red">cd /tmp/tutorial</font><br>
$ <font color="red">tar xzf securityTutorial.tar.gz</font><br>
$ <font color="red">cd securityTutorial</font><br>
$ <font color="red">export TUTORIAL_DIR=$PWD</font><br>
$ <font color="red">cd $TUTORIAL_DIR/counterService</font><br>
</p>

<h3>Set environment variables in the Exercise window:</h3>
<p class="ex1-command">
$ <font color="red">export GLOBUS_LOCATION=<i>[use the value that was echoed earlier in the GT window, not $PWD]</i></font>
</p>

<h3>Build and deploy the tutorial code in the Exercise window:</h3>
<p class="ex1-command">
$ <font color="red">ant deploy</font><br>
Buildfile: build.xml<br>
<br>
deploy:<br>
<br>
dist:<br>
<br>
[many more messages ...]<br>
<br>
BUILD SUCCESSFUL<br>
Total time: 20 seconds<br>
</p>
<p>As long as your build ends with BUILD SUCCESSFUL, don't mind any warnings
generated during the build.  If you see "BUILD FAILED", please contact
an instructor.</p>

<h3>Start a web service container without security in the GT window:</h3>
<p class="command">
$ <font color="red">bin/globus-start-container -nosec</font><br>
Starting SOAP server at: http://10.0.1.3:8080/wsrf/services/ <br>
With the following services:<br>
<br>
[1]: http://10.0.1.3:8080/wsrf/services/AdminService<br>
[2]: http://10.0.1.3:8080/wsrf/services/AuthzCalloutTestService<br>
[3]: http://10.0.1.3:8080/wsrf/services/ContainerRegistryEntryService<br>
[4]: http://10.0.1.3:8080/wsrf/services/ContainerRegistryService<br>
[5]: http://10.0.1.3:8080/wsrf/services/CounterService<br>
[6]: http://10.0.1.3:8080/wsrf/services/ManagementService<br>
[7]: http://10.0.1.3:8080/wsrf/services/NotificationConsumerFactoryService<br>
[8]: http://10.0.1.3:8080/wsrf/services/NotificationConsumerService<br>
[9]: http://10.0.1.3:8080/wsrf/services/NotificationTestService<br>
[10]: http://10.0.1.3:8080/wsrf/services/PersistenceTestSubscriptionManager<br>
[11]: http://10.0.1.3:8080/wsrf/services/SampleAuthzService<br>
[12]: http://10.0.1.3:8080/wsrf/services/SecureCounterService<br>
[13]: http://10.0.1.3:8080/wsrf/services/SecurityTestService<br>
[14]: http://10.0.1.3:8080/wsrf/services/ShutdownService<br>
[15]: http://10.0.1.3:8080/wsrf/services/SubscriptionManagerService<br>
[16]: http://10.0.1.3:8080/wsrf/services/TestAuthzService<br>
[17]: http://10.0.1.3:8080/wsrf/services/TestRPCService<br>
[18]: http://10.0.1.3:8080/wsrf/services/TestService<br>
[19]: http://10.0.1.3:8080/wsrf/services/TestServiceRequest<br>
[20]: http://10.0.1.3:8080/wsrf/services/TestServiceWrongWSDL<br>
[21]: http://10.0.1.3:8080/wsrf/services/TutorialCounterService<br>
[22]: http://10.0.1.3:8080/wsrf/services/Version<br>
[23]: http://10.0.1.3:8080/wsrf/services/WidgetNotificationService<br>
[24]: http://10.0.1.3:8080/wsrf/services/WidgetService<br>
[25]: http://10.0.1.3:8080/wsrf/services/gsi/AuthenticationService<br>
</p>
<p>
Control will not return to the prompt. This container will stay running until
you exit it with Control-C. If you need to start up the container on an
alternate port, use the "-p" command-line argument.  For example,
"bin\globus-start-container -nosec -p 8888" will cause the container to listen
on port 8888.
</p>

<h3>In the Exercise window, create a new CounterService:</h3>
<p class="ex1-command">
$ <font color="red">$GLOBUS_LOCATION/bin/tutorial-counter-create -s http://localhost:8080/wsrf/services/TutorialCounterService -o epr1</font><br>
Counter created. EPR written to file: epr1<br>
$ <font color="red">$GLOBUS_LOCATION/bin/tutorial-counter-add -e epr1 10
</font><br>
Value 10 added<br>
$ <font color="red">$GLOBUS_LOCATION/bin/tutorial-counter-subtract -e epr1 11</font><br>
Value 11 subtracted<br>
$ <font color="red">$GLOBUS_LOCATION/bin/tutorial-counter-getValue -e epr1</font><br>
Current counter value -1<br>
$ <font color="red">$GLOBUS_LOCATION/bin/wsrf-destroy -e epr1</font><br>
Destroy operation was successful
</p>

<h3>Kill the webservice container in the GT window:</h3>
<p>
Press Control-C to stop the container.
</p>
<p class="command">
^CStopped SOAP Axis server at: http://10.0.1.3:8080/wsrf/services/
</p>

<p>Congratulations, you've installed the GT4.0.3 webservices container and
deployed the tutorial code into it.  The create/add/substract/query/destroy
operations are going to form the basis of the rest of this tutorial.  Our
first step will be to add transport security to the container.</p>

<h3>Request a certificate from the Globus Certificate Service in the GT window:</h3>
<p class="command">
$ <font class="red">mkdir -p share/certificates</font><br>
$ <font class="red">cd share/certificates/</font><br>
$ <font class="red">wget http://gcs.globus.org:8080/gcs/cacert/b38b4d8c.0</font><br>
--13:16:02--  http://gcs.globus.org:8080/gcs/cacert/b38b4d8c.0<br>
           =&gt; `b38b4d8c.0'<br>
Resolving gcs.globus.org... 140.221.8.17<br>
Connecting to gcs.globus.org|140.221.8.17|:8080... connected.<br>
HTTP request sent, awaiting response... 200 OK<br>
Length: 1,001 [text/plain]<br>
<br>
100%[====================================&gt;] 1,001         --.--K/s             <br>
<br>
13:16:02 (23.87 MB/s) - `b38b4d8c.0' saved [1001/1001]<br>
$ <font class="red">cd ../..</font><br>
$ <font class="red">bin/grid-cert-request -caEmail null -dir tmp</font><br>
A certificate request and private key will be created.<br>
You will be asked to enter a PEM pass phrase.<br>
This pass phrase is akin to your account password,<br>
and is used to protect your key file.<br>
If you forget your pass phrase, you will need to<br>
obtain a new certificate.<br>
<br>
Enter PEM pass phrase:<br>
Verifying password - Enter PEM pass phrase:<br>
Generating a 1024 bit RSA private key<br>
A private key and a certificate request has been generated with the subject:<br>
<br>
/O=Grid/CN=bacon<br>
<br>
The private key is stored in /private/tmp/tutorial/ws-core-4.0.3/tmp/userkey.pem<br>
The request is stored in /private/tmp/tutorial/ws-core-4.0.3/tmp/usercert_request.pem<br>
</p>
<p>Upload the generated request file (/tmp/tutorial/ws-core-4.0.3/tmp/usercert_request.pem)
to <a href="http://gcs.globus.org:8080/gcs/usercert.html">
http://gcs.globus.org:8080/gcs/usercert.html</a> using the
"Upload certificate request from file" option.  Please do not try to copy/paste
- the certificate request is sensitive to whitespace.  Save the generated
certificate to /tmp/tutorial/ws-core-4.0.3/tmp/usercert.pem using the
"Click here to download the cert" link.  Again, please don't try to copy/paste
the certificate.
</p>
<h3>Create a proxy and start a secure container in the GT window:</h3>
<p class="command">
$ <font class="red">ls -l tmp</font><br>
total 24<br>
-rw-r--r--   1 bacon  bacon   814 Nov 28 05:17 usercert.pem<br>
-rw-r--r--   1 bacon  wheel  1165 Nov 28 09:42 usercert_request.pem<br>
-rw-------   1 bacon  wheel   963 Nov 28 09:42 userkey.pem<br>
</p>
<p>If your usercert.pem is still size 0, you are not done.  Make sure that
you have saved the certificate from GCS into $GLOBUS_LOCATION/tmp/usercert.pem.
</p>
<p class="command">
$ <font class="red">bin/grid-proxy-init -cert tmp/usercert.pem -key tmp/userkey.pem</font><br>
Your identity: C=US,O=Globus Alliance,OU=User,CN=10ef1609891.c37b8d9e<br>
Enter GRID pass phrase for this identity: [enter passphrase from above]<br>
Creating proxy, please wait...<br>
Proxy verify OK<br>
Your proxy is valid until Fri Nov 17 01:52:39 CST 2006<br>
$ <font class="red">bin/globus-start-container</font><br>
Starting SOAP server at: https://10.0.1.3:8443/wsrf/services/<br>
With the following services<br>
<br>
[1]: https://10.0.1.3:8443/wsrf/services/AdminService<br>
[2]: https://10.0.1.3:8443/wsrf/services/AuthzCalloutTestService<br>
[3]: https://10.0.1.3:8443/wsrf/services/ContainerRegistryEntryService<br>
[4]: https://10.0.1.3:8443/wsrf/services/ContainerRegistryService<br>
[5]: https://10.0.1.3:8443/wsrf/services/CounterService<br>
[6]: https://10.0.1.3:8443/wsrf/services/ManagementService<br>
[7]: https://10.0.1.3:8443/wsrf/services/NotificationConsumerFactoryService<br>
[8]: https://10.0.1.3:8443/wsrf/services/NotificationConsumerService<br>
[9]: https://10.0.1.3:8443/wsrf/services/NotificationTestService<br>
[10]: https://10.0.1.3:8443/wsrf/services/PersistenceTestSubscriptionManager<br>
[11]: https://10.0.1.3:8443/wsrf/services/SampleAuthzService<br>
[12]: https://10.0.1.3:8443/wsrf/services/SecureCounterService<br>
[13]: https://10.0.1.3:8443/wsrf/services/SecurityTestService<br>
[14]: https://10.0.1.3:8443/wsrf/services/ShutdownService<br>
[15]: https://10.0.1.3:8443/wsrf/services/SubscriptionManagerService<br>
[16]: https://10.0.1.3:8443/wsrf/services/TestAuthzService<br>
[17]: https://10.0.1.3:8443/wsrf/services/TestRPCService<br>
[18]: https://10.0.1.3:8443/wsrf/services/TestService<br>
[19]: https://10.0.1.3:8443/wsrf/services/TestServiceRequest<br>
[20]: https://10.0.1.3:8443/wsrf/services/TestServiceWrongWSDL<br>
[21]: https://10.0.1.3:8443/wsrf/services/TutorialCounterService<br>
[22]: https://10.0.1.3:8443/wsrf/services/Version<br>
[23]: https://10.0.1.3:8443/wsrf/services/WidgetNotificationService<br>
[24]: https://10.0.1.3:8443/wsrf/services/WidgetService<br>
[25]: https://10.0.1.3:8443/wsrf/services/gsi/AuthenticationService<br>

</p>
<h3>From the exercise window, run the client:</h3>
<p>Note the change from http to https, and from port 8080 to 8443!</p>
<p class="ex1-command">
$ <font color="red">$GLOBUS_LOCATION/bin/tutorial-counter-create -s https://localhost:8443/wsrf/services/TutorialCounterService -o epr1</font><br>
Counter created. EPR written to file: epr1
</p>

<h3>Kill the webservice container in the GT window:</h3>
<p>Press Control-C to stop the container.</p>
<p class="command">
^CStopped SOAP Axis server at: http://10.0.1.3:8080/wsrf/services/
</p>

<p>Now we have our tutorial service running inside of a webservices
container, and we are able to communicate with it using SSL.  Now we
can explore the different options for authentication, authorization,
and delegation in the following chapters.
</p>
<h2><a name="exercise2" id="exercise2"></a>Exercise 2: Authentication </h2>
<p>In this exercise we are going to change our service.  We are going to
make the "create" command require GSI Secure Transport authentication, and the
"add" command will require GSI Secure Conversation authentication.
We will leave the "subtract" operation unauthenticated.
</p>
<h3>Modify files in the Exercise window:</h3>
<p>If you are not familiar with commenting out XML or WSDL,
the comment tags are "&lt;!--" and "--&gt;". For instance:
</p><p class="ex1-command">
This line is not commented out<br>
&lt;!-- This line is commented out --&gt;<br>
&lt;!-- <br>
These lines<br>are both commented out <br>
--&gt;<br>
</p>
<p>
You must modify 5 files in order to successfully complete this exercise.
All of the files are in the securityTutorial directory.
All modifications you need to make to source files today begin with a comment
tag of "EXERCISE n: &lt;type of modification needed&gt;" and end with
"END OF EXERCISE n &lt;type of modification&gt;".  Some files contain more
than one set of changes to be made for a given file.
The 5 files to modify are:</p>
<p class="ex1-command">
<b>counterService/service/java/source/deploy-server.wsdd</b><br>
Uncomment the securityDescriptor<br>
<br>
<b>counterService/service/java/source/etc/security_descriptor.xml</b><br>
Uncomment the security descriptor entries for the various methods.<br>
<br>
<b>counterService/client/java/source/src/org/globus/tutorial/counter/Create.java</b><br>
Add a property to the client's stub that sets GSI Transport encryption<br>
<br>
<b>counterService/client/java/source/src/org/globus/tutorial/counter/Add.java</b><br>
Add logic to set security properties based on a descriptor file<br>
Comment out the section that sets "No Authorization". This is a good
reminder that sometimes there will be more than one section to
comment/uncomment.<br>
<br>
<b>counterService/client/java/source/src/org/globus/tutorial/counter/Subtract.java</b><br>
Same changes as the Add client - add the descriptorFile section, and comment
out the noAuthorization section.<br>
<br>
<b>counterService/client/java/source/src/org/globus/tutorial/counter/GetCounterValue.java</b><br>
Add a GSITransport with encryption property.<br>
<br>
<b>counterService/client/java/source/etc/conversation_encryption.xml</b><br>
Uncomment the GSISecureConversation section.<br>
<br>
<b>counterService/client/java/source/etc/message_signature.xml</b><br>
Uncomment the GSISecureMessage section.<br>
</p>

<h3>Rebuild the tutorial code in the Exercise window:</h3>
<p class="ex1-command">
$ <font color="red">cd $TUTORIAL_DIR/counterService</font><br>
$ <font color="red">ant deploy</font><br>
Buildfile: build.xml<br>
<br>
deploy:<br>
[...]<br>
BUILD SUCCESSFUL<br>
Total time: 23 seconds<br>
</p>
<p>If your build fails, make sure that you caught both halves of each comment/uncomment pair.</p>

<h3>Start a secure container in the GT window:</h3>
<p class="command">
$ <font color="red">bin/globus-start-container</font><br>
Starting SOAP server at: https://10.0.1.3:8443/wsrf/services/<br>
With the following services:<br>
[...]<br>
[24]: https://10.0.1.3:8443/wsrf/services/WidgetService<br>
[25]: https://10.0.1.3:8443/wsrf/services/gsi/AuthenticationService<br>
</p>

<h3>Use the secure clients to interact with the services in the Exercise window:</h3>
<p class="ex1-command">
$ <font color="red">$GLOBUS_LOCATION/bin/tutorial-counter-create -s https://localhost:8443/wsrf/services/TutorialCounterService -o epr1</font><br>
Counter created. EPR written to file: epr1<br>
$ <font color="red">$GLOBUS_LOCATION/bin/tutorial-counter-add
-e epr1 -f
$GLOBUS_LOCATION/etc/globus_tutorial_counter_client/conversation_encryption.xml
13
</font><br>
Value 13 added<br>
$ <font color="red">$GLOBUS_LOCATION/bin/tutorial-counter-subtract
-e epr1 -f
$GLOBUS_LOCATION/etc/globus_tutorial_counter_client/message_signature.xml
11</font><br>
Value 11 subtracted<br>
$ <font color="red">$GLOBUS_LOCATION/bin/tutorial-counter-getValue -e epr1</font><br>
Current counter value 2<br>
$ <font color="red">$GLOBUS_LOCATION/bin/wsrf-destroy -e epr1 -z none</font><br>
Destroy operation was successful
</p>
<p>We modified the source code to tutorial-counter-create to use GSITransport
security with privacy enabled, so it can communicate to the createCounter method
of the service, which has been setup with GSITransport security in the service's
security descriptor.
</p>
<p>The tutorial-counter-add client was modified so it can use a
security descriptor file that is specified on the commandline. This
lets the client change behavior depending on how the service has been
configured.</p>
<p>In this case, our conversation_encryption.xml file is setup to use
GSISecureConversation with privacy enabled for authentication,
with nothing selected for authorization. This matches the
authentication method we selected for the add method in the service's
security descriptor, so the services communicate correctly.
</p>
<p>Similarly, the tutorial-counter-subtract was modified to use a
descriptor. However, the security settings on the service's subtract
operation are different than the settings on the Add operation, so we
used a different security descriptor. For subtract, we used
GSISecureMessage with integrity checking,
not privacy. Again, this matches the selection made in the service's
security descriptor.</p>
<p>We did not change any security settings on the destroy operation, so
the wsrf-destroy still succeeds.  However, unlike last time, this time we
are destroying a counter inside of a secure container.  wsrf-destroy assumes
that the container will be running under host credentials in this scenario,
but we are running under personal credentials.  Therefore we have to tell
wsrf-destroy explicitly not to authorize the service by specifying "-z none".
</p>

<h3>Stop the container in the GT Window</h3>
<p>
Press Control-C to stop the container.
</p>
<p class="command">
^CStopped SOAP Axis server at: https://10.0.1.3:8443/wsrf/services/
</p>

<h2><a name="exercise3" id="exercise3"></a>Exercise 3: Authorization</h2>
<p>In this section we will add authorization to the clients and
services. Start by sharing Tutorial Service addresses (the URL like
https://10.0.1.3:8443/wsrf/services/TutorialCounterService) with your
neighbor. Before you begin this exercise, make sure both you and your
neighbor are able to create counter services on each other's computers.
If one or both of you has "127.0.0.1" for an address, see <a href="#logicalhost">this troubleshooting tip</a>.
</p>
<p>Once you're done with that verification, we will add authorization
so that only you can create counters, as well as add and subtract, in
your own container. We will leave the query open, however, so other
people can read your counter's current setting.
</p>

<h3>Start a container in your GT window:</h3>
<p class="command">
$ <font color="red">bin/globus-start-container</font><br>
...<br>
[25]: https://10.0.1.3:8443/wsrf/services/gsi/AuthenticationService
</p>

<h3>In your exercise window, create a counter on your neighbor's computer:</h3>
<p class="ex1-command">
$ <font color="red">$GLOBUS_LOCATION/bin/tutorial-counter-create -s </font>https://neighbors.host:8443/wsrf/services/TutorialCounterService <font color="red">-o neighborEPR</font><br>
Counter created. EPR written to file: neighborEPR<br>

</p><p>In this exercise we will modify the service so that only authorized users may create new counter resources.</p>

<h3>Stop your container in the GT window:</h3>
<p>Press Control-C to stop the container.</p>
<p class="command">
^CStopped SOAP Axis server at: http://10.0.1.3:8443/wsrf/services/</p>

<h3>Modify files in your Exercise window:</h3>
<p class="ex1-command">
<b>counterService/service/java/source/etc/security_descriptor.xml</b><br>
Comment out the authz value of "none", and uncomment the authz value
of "self".<br>
<br>
<b>counterService/client/java/source/src/org/globus/tutorial/counter/Create.java
</b><br>
The same change, but this time from the client side - comment out the authz
value of none, and uncomment the authz value of self.<br>
<br>
<b>counterService/client/java/source/etc/conversation_encryption.xml</b><br>
The same change, again on the client side, but this time in a client-side
security descriptor.<br>
<br>
</p>

<h3>Deploy the modified code in the Exercise window:</h3>
<p class="ex1-command">
$ <font color="red">cd $TUTORIAL_DIR/counterService</font><br>
$ <font color="red">ant deploy</font><br>
...<br>
BUILD SUCCESSFUL<br>
Total time: 34 seconds<br>
</p>
<h3>Restart the container in the GT window:</h3>
<p class="command">
$ <font color="red">bin/globus-start-container</font><br>
...<br>
[25]: https://10.0.1.3:8443/wsrf/services/gsi/AuthenticationService
</p>

<h3>Use the secure Create to create a new counter:</h3>

<p class="ex1-command">
$ <font color="red">$GLOBUS_LOCATION/bin/tutorial-counter-create -s https://localhost:8443/wsrf/services/TutorialCounterService -o epr1</font><br>
Counter created. EPR written to file: epr1<br>
$ <font color="red">$GLOBUS_LOCATION/bin/tutorial-counter-create -s </font>https://neighbors.host:8443/wsrf/services/TutorialCounterService <font color="red">-o neighborEPR</font><br>
Error: ; nested exception is: <br>
org.globus.common.ChainedIOException: Authentication failed [Caused by:
Operation unauthorized (Mechanism level: Authorization failed. Expected
"/C=US/O=Globus Alliance/OU=User/CN=10f2e485835.75b047a0" target but
received "/DC=org/DC=doegrids/OU=People/CN=Charles Bacon 332900")]<br>
$ <font color="red">$GLOBUS_LOCATION/bin/tutorial-counter-add
-e epr1 -f
$GLOBUS_LOCATION/etc/globus_tutorial_counter_client/conversation_encryption.xml
13</font><br>
Value 13 added
</p>

<p>Your client and service succeed in authorizing each other, because
they have the same identity. Your client fails to authorize your
neighbor's service because it was expecting to receive its own identity
from the service, but instead received your neighbor's identity. The
client side authorization is done as a part of the handshake in the
case of GSI Secure Transport and hence is completed before service is
invoked. </p>

<h3>Stop the container in the GT Window</h3>
<p class="command">
^CStopped SOAP Axis server at: https://10.0.1.3:8443/wsrf/services/
</p>

<h2><a name="exercise4" id="exercise4"></a>Exercise 4: Resource-level security</h2>
<p>In this chapter we'll be working on a different service.</p>

<h3>Modify files in the Exercise window:</h3>
<p class="ex1-command">
<b>counterService/service/java/source/deploy-server.wsdd</b><br>
Uncomment the SecureTutorialCounterService service descriptor<br>
<br>
<b>counterService/service/java/source/deploy-jndi-config.xml</b><br>
Uncomment the SecureTutorialCounterService JNDI section<br>
<br>
<b>counterService/service/java/source/src/org/globus/tutorial/impl/counter/SecureCounterService.java</b><br>
Uncomment the addAuthorizedDN operation, comment out the "not implemented yet" eexception.<br>

<br>
<b>counterService/service/java/source/src/org/globus/tutorial/impl/counter/SecureCounterResource.java</b><br>
Make SecureCounterResource implement SecureResource<br>
Uncomment the part of the initialize method<br>
Uncomment the getSecurityDescriptor and addAuthorizedDN functions<br>
<br>
<b>counterService/client/java/source/etc/conversation_encryption_none.xml</b><br>
Add GSISecureConversation with privacy to the descriptor.<br>
<br>
<b>counterService/client/java/source/etc/conversation_signature.xml</b><br>
Add GSISecureConversation with integrity checking to the descriptor<br>
<br>
<b>counterService/client/java/source/etc/message_signature.xml</b><br>
Comment out the "none" authz, uncomment the "self" authz.<br>
</p>

<h3>Deploy the modified code in the Exercise window:</h3>
<p class="ex1-command">
$ <font color="red">cd $TUTORIAL_DIR/counterService</font><br>
$ <font color="red">ant deploy</font><br>
...<br>
BUILD SUCCESSFUL<br>
Total time: 26 seconds<br>
</p>
<h3>Restart the container in the GT window:</h3>
<p class="command">
$ <font color="red">bin/globus-start-container</font><br>
...<br>
[26]: https://10.0.1.3:8443/wsrf/services/gsi/AuthenticationService
</p>

<h3>Use the secure clients to interact with the services in the Exercise window:</h3>
<p>Watch out!  The name of the service has changed.  If you use command
history in your shell, you will still be interacting with the old service.
Make sure you copy and paste the commands below!
</p>
<p class="ex1-command">
$ <font color="red">$GLOBUS_LOCATION/bin/tutorial-counter-create -s https://localhost:8443/wsrf/services/SecureTutorialCounterService -o epr1</font><br>
$ <font color="red">$GLOBUS_LOCATION/bin/tutorial-counter-add
-e epr1 -f
$GLOBUS_LOCATION/etc/globus_tutorial_counter_client/conversation_encryption.xml
12</font><br>
Value 12 added
</p>
<p>As expected, you are still allowed to invoke the "add" operation on
your own
counter. However, your neighbor currently cannot - have them try it. Be
careful again - conversation_encryption_none is a new security
descriptor, so you need to copy and paste this command, don't use
command history!
</p>

<!-- FIXME: scenario spefic detail <p> <b><font color="purple">Details on how to share EPR file. </font></b> </p> -->

<p class="ex2-command">
neighbor$ <font color="red">$GLOBUS_LOCATION/bin/tutorial-counter-add
-e epr1 -f
$GLOBUS_LOCATION/etc/globus_tutorial_counter_client/conversation_encryption_none.xml
10</font><br>
Error:
org.globus.wsrf.impl.security.authorization.exceptions.AuthorizationException:
"/DC=org/DC=doegrids/OU=People/CN=Charles Bacon 332900" is not
authorized to use operation: {http://www.globus.org/counter}add on this
service
</p>
<p>Your counter resource is now protected against unauthorized additions.
 However you can add their identity
to the list of authorized identities if you so choose.  Get their identity
from the error message, then add it as an authorized DN:</p>
<p class="ex1-command">
$ <font color="red">$GLOBUS_LOCATION/bin/tutorial-counter-addAuthzDN
-e epr1 -f
$GLOBUS_LOCATION/etc/globus_tutorial_counter_client/message_signature.xml</font> "/DC=org/DC=doegrids/OU=People/CN=Charles Bacon 332900"<br>
"/DC=org/DC=doegrids/OU=People/CN=Charles Bacon 332900" added as authorized user
</p>
<p>Now when they try to use your counter, they should be successful:</p>
<p class="ex2-command">
neighbor$ <font color="red">$GLOBUS_LOCATION/bin/tutorial-counter-add
-e epr1 -f
$GLOBUS_LOCATION/etc/globus_tutorial_counter_client/conversation_encryption_none.xml
10</font><br>
Value 10 added
</p>
<p>By the way, did you see why your neighbor had to use the
conversation_encryption_none.xml client descriptor instead of
conversation_encryption.xml? If their client had tried
self-authorization it would have failed, because your container is not
running under the same identity as their client. It's only because we
set the client-side authorization to "none" that we were able to get to
the serverice-side authorization decision.
</p>
<p>The create operation in your container is still protected by self
authorization, so even after you've added their DN to an existing counter
they are still not able to create new counters of their own.</p>

<h3>Stop your container in the GT window:</h3>
<p>
Press Control-C to stop the container.
</p>
<p class="command">
^CStopped SOAP Axis server at: http://10.0.1.3:8443/wsrf/services/</p>

<h2><a name="exercise5" id="exercise5"></a>Exercise 5: Notification security</h2>

<p>In this exercise, we will use a version of the secure counter
service that has notifications enabled called
NotificationTutorialCounterService. This service will send a
notification to any subscribers when the counter value is
changed.</p>

<h3>Modify files in the Exercise window:</h3>
<p class="ex1-command">
<b>counterService/service/java/source/deploy-server.wsdd</b><br>
Uncomment the NotificationTutorialCounterService<br>
<br>
<b>counterService/service/java/source/deploy-jndi-config.xml</b><br>
Uncomment the NotificationTutorialCounterService<br>
<br>
<b>counterService/service/java/source/etc/notification_security_descriptor.xml</b><br>
Add GSISecureConversation and GSITransport to the subscribe operation<br>
<br>
<b>counterService/service/java/source/src/org/globus/tutorial/impl/counter/NotificationCounterResource.java</b><br>
Add the code (in two sections) to implement service-side notifications<br>
<br>
<b>counterService/client/java/source/src/org/globus/tutorial/counter/AddWithNotifications.java</b><br>
Uncomment the client-side notification handling code<br>
</p>

<h3>Deploy the modified code in the Exercise window:</h3>
<p class="ex1-command">
$ <font color="red">cd $TUTORIAL_DIR/counterService</font><br>
$ <font color="red">ant deploy</font><br>
...<br>
BUILD SUCCESSFUL<br>
Total time: 26 seconds<br>
</p>

<h3>Restart the container in the GT window:</h3>
<p class="command">
$ <font color="red">bin/globus-start-container</font><br>
...<br>
[27]: https://10.0.1.3:8443/wsrf/services/gsi/AuthenticationService
</p>

<h3>Use the secure clients to interact with the services in the Exercise window:</h3>
<p>Note the new service name: NotificationTutorialCounterService.  Make sure
you're using that new service for this exercise.</p>
<p class="ex1-command">
$ <font color="red">$GLOBUS_LOCATION/bin/tutorial-counter-create -s https://localhost:8443/wsrf/services/NotificationTutorialCounterService -o epr1</font><br>
Counter created. EPR written to file: epr1<br>
$ <font color="red">$GLOBUS_LOCATION/bin/tutorial-counter-notifications-add -e epr1 154</font><br>
Value 154 added<br>
Waiting for notifications<br>
Got notification with value: 154<br>
$ <font color="red">$GLOBUS_LOCATION/bin/tutorial-counter-notifications-add -e epr1 13</font><br>
Value 13 added<br>
Waiting for notifications<br>
Got notification with value: 167<br>
</p>

<p>Now we have working secure notifications from the resource to our client.</p>

<h3>Stop your container in the GT window:</h3>
<p>Press Control-C to stop the container.</p>
<p class="command">
^CStopped SOAP Axis server at: http://10.0.1.3:8443/wsrf/services/</p>

<h2><a name="exercise6" id="exercise6"></a>Exercise 6: Host certificates</h2>

<p>In this exercise you will obtain a host
certificate from the same CA as your user certificate and change the
container to use them rather than your user certificate. This implies
that client side authorization should be changed to host authorization.</p>

<p>We will also use a new incarnation of the counter service called the SecureMessageCounterService.</p>

<h3>Get host certificates for your machine using GCS in the GT window:</h3>
<p class="command">
$ <font color="red">bin/grid-cert-request -host `hostname` -caEmail null -dir etc/hostCerts</font><br>
Generating a 1024 bit RSA private key<br>
A private key and a certificate request has been generated with the subject:<br>
<br>
/O=Grid/CN=host/bacon.local<br>
<br>
The private key is stored in /private/tmp/tutorial/ws-core-4.0.3/etc/hostCerts/hostkey.pem<br>
The request is stored in /private/tmp/tutorial/ws-core-4.0.3/etc/hostCerts/hostcert_request.pem<br>
</p>
<p>Upload the generated request file (/tmp/tutorial/ws-core-4.0.3/tmp/usercert_request.pem)
to <a href="http://gcs.globus.org:8080/gcs/servicecert.html">
http://gcs.globus.org:8080/gcs/servicecert.html</a>
using the
"Upload certificate request from file" option. Also, fill in your full
hostname in the "Full hostname (including domain) of the host on which
the certificate will be used" entry box, then submit.</p>
<p>Please do not try to copy/paste
- the certificate request is sensitive to whitespace.  Save the generated
certificate to /tmp/tutorial/ws-core-4.0.3/etc/hostCerts/hostcert.pem using the
"Click here to download the cert" link.  Again, please don't try to copy/paste
the certificate.
</p>

<h3>Copy a new container security descriptor from the Exercise window:</h3>

<p class="ex1-command">
$ <font color="red">cp $TUTORIAL_DIR/etc/global_security_descriptor.xml $GLOBUS_LOCATION/etc/globus_wsrf_core</font>
</p>

<h3>Edit the container's server-config.wsdd in the GT window:</h3>
<p>Add a line reading &lt;parameter name="containerSecDesc" 
value="etc/globus_wsrf_core/global_security_descriptor.xml"/&gt; to the file after
the line reading "CONTAINER_SECURITY_DESCRIPTOR".</p>
<p class="command">
$ <font color="red">pico $GLOBUS_LOCATION/etc/globus_wsrf_core/server-config.wsdd</font><br>
$ <font color="red">grep -A2 CONTAINER_SECURITY_DESCRIPTOR etc/globus_wsrf_core/server-config.wsdd</font><br>
        &lt;!-- @CONTAINER_SECURITY_DESCRIPTOR@ --&gt;<br>
        &lt;parameter name="containerSecDesc" value="etc/globus_wsrf_core/global_security_descriptor.xml"/&gt;<br>
</p>
<h3>Modify files in the Exercise window:</h3>
<p class="ex1-command">
<b>counterService/client/java/source/src/org/globus/tutorial/counter/Create.java</b><br>
Add host authorization to the create client<br>
<br>
<b>counterService/service/java/source/deploy-server.wsdd</b><br>
Uncomment the SecureMessageCounterService service definition. Note that gridmap file is configured for use by this service.<br>
<br>
<b>counterService/service/java/source/deploy-jndi-config.xml</b><br>
Uncomment the SecureMessageCounterService service definition. Note that
is uses a different descriptor that uses gridmap authorization.<br>
<br>
<b>counterService/service/java/source/etc/security_descriptor_1.xml</b><br>
Uncomment to configure a gridmap file.<br>
<br>
<b>counterService/service/java/source/etc/secureMsgCounterGridmap</b><br>
<br>Add your DN to the file to allow access to the service. To get your DN you can run <br>
$ <font color="red">$GLOBUS_LOCATION/bin/grid-proxy-info -globus -issuer </font><br>
issuer  : /C=US/O=Globus Alliance/OU=User/CN=101497d3dcd.3dcd5aef
<br>
The mapping can be dummy since the SecureMessageCounterService only checks for presence in gridmap.
</p>

<h3>Deploy the modified code in the Exercise window:</h3>
<p class="ex1-command">
$ <font color="red">cd $TUTORIAL_DIR/counterService</font><br>
$ <font color="red">ant deploy</font><br>
...<br>
BUILD SUCCESSFUL<br>
Total time: 26 seconds<br>
</p>

<h3>Restart the container in the GT window:</h3>
<p class="command">
$ <font color="red">bin/globus-start-container</font><br>
...<br>
[28]: https://10.0.1.3:8443/wsrf/services/gsi/AuthenticationService
</p>

<h3>Create a counter from the Exercise window:</h3>
<p>Note that we started using `hostname` to identity our container so
that the right IP address will be used for host-based authentication.
Also, note the change in service name to SecureMessageCounterService.</p>
<p class="ex1-command">
$ <font color="red">$GLOBUS_LOCATION/bin/tutorial-counter-create -s https://`hostname`:8443/wsrf/services/SecureMessageCounterService -o epr1</font><br>
Counter created. EPR written to file: epr1<br>
</p>

<p>Now we have host-based authentication working for our counter service.</p>

<h3>Stop your container in the GT window:</h3>
<p>
Press Control-C to stop the container.
</p>
<p class="command">
^CStopped SOAP Axis server at: http://10.0.1.3:8443/wsrf/services/</p>


<h2><a name="exercise7" id="exercise7"></a>Exercise 7: Anonymous access</h2>

<p>Anonymous access is useful when your container is running in SSL mode,
which requires security to reach a service, but some operations should be
open to all users.  You can have gridmap or self authorization on the
"secure" operations, but leave other operations open for anyone to use.</p>
<p>Any client that has access to credentials can choose to present an
anonymous identity during the authentication process, but it is up to
the service whether that identity should be authorized.</p>

<h3>Modify files in the Exercise window:</h3>
<p class="ex1-command">
<b>counterService/client/java/source/src/org/globus/tutorial/counter/GetCounterValue.java</b><br>
Add Anonymous access to the security properties<br>
</p>

<h3>Deploy the modified code in the Exercise window:</h3>
<p class="ex1-command">
$ <font color="red">cd $TUTORIAL_DIR/counterService</font><br>
$ <font color="red">ant deploy</font><br>
...<br>
BUILD SUCCESSFUL<br>
Total time: 26 seconds<br>
</p>

<h3>Restart the container in the GT window:</h3>
<p class="command">
$ <font color="red">bin/globus-start-container </font><br>
...<br>
[28]: https://10.0.1.3:8443/wsrf/services/gsi/AuthenticationService
</p>

<h3>Access the getValue operation with anonymous credentials in the Exercise window:</h3>
<p class="ex1-command">$ <font color="red">$GLOBUS_LOCATION/bin/tutorial-counter-create -s https://`hostname`:8443/wsrf/services/SecureMessageCounterService -o epr1</font><br>
Counter created. EPR written to file: epr1<br>
$ <font color="red">$GLOBUS_LOCATION/bin/grid-proxy-destroy</font><br>
$ <font color="red">$GLOBUS_LOCATION/bin/tutorial-counter-getValue -e epr1</font><br>
Error:
org.globus.wsrf.impl.security.authorization.exceptions.AuthorizationException: "&lt;anonymous&gt;" is
not authorized to use operation: {http://www.globus.org/counter}getValue on this
service </p>

<p> The above failed since gridmap authorization does not allow anonymous access.</p>

<h3>Stop your container in the GT window:</h3>
<p>Press Control-C to stop the container.</p>
<p class="command">^CStopped SOAP Axis server at: https://10.0.1.3:8443/wsrf/services/</p>

<h3>Disable authentication for getValue method:</h3>

<p>Since only authentication calls are authorized, disabling authentication for getValue method will allow for anonymous access.</p>

<p class="ex1-command"><b>counterService/service/java/source/etc/security_descriptor_1.xml</b><br>
Comment authentication policy for getValue. Note default auth-method is set to none.<br>
</p>

<h3>Deploy the modified code in the Exercise window:</h3>
<p class="ex1-command">$ <font color="red">cd $TUTORIAL_DIR/counterService</font><br>
$ <font color="red">ant deploy</font><br>
...<br>
BUILD SUCCESSFUL<br>
Total time: 26 seconds<br>
</p>

<h3>Restart the container in the GT window:</h3>
<p class="command">$ <font color="red">bin/globus-start-container </font><br>
...<br>
[28]: https://10.0.1.3:8443/wsrf/services/gsi/AuthenticationService</p>

<h3>Access the getValue operation with anonymous credentials in the Exercise window:</h3>

<p class="ex1-command">$ <font color="red">$GLOBUS_LOCATION/bin/grid-proxy-init -cert $GLOBUS_LOCATION/tmp/usercert.pem -key $GLOBUS_LOCATION/tmp/userkey.pem</font><br>
$ <font color="red">$GLOBUS_LOCATION/bin/tutorial-counter-create -s https://`hostname`:8443/wsrf/services/SecureMessageCounterService -o epr1</font><br>
Counter created. EPR written to file: epr1<br>
$ <font color="red">$GLOBUS_LOCATION/bin/grid-proxy-destroy</font><br>
$ <font color="red">$GLOBUS_LOCATION/bin/tutorial-counter-getValue -e epr1</font><br>
Current counter value 0<br>
$ <font color="red">$GLOBUS_LOCATION/bin/grid-proxy-init -cert $GLOBUS_LOCATION/tmp/usercert.pem -key $GLOBUS_LOCATION/tmp/userkey.pem</font><br>
</p>

<h3>Stop your container in the GT window:</h3>
<p>Press Control-C to stop the container.</p>
<p class="command">^CStopped SOAP Axis server at: https://10.0.1.3:8443/wsrf/services/</p>

<h2><a name="exercise8" id="exercise8"></a>Exercise 8: GSI Secure Message Security</h2>

<p> In this exercise we will focus on GSI Secure Message Security and
use privacy protection on invocations. This also highlights the
client-side authorization step being done after the actual operation
has been completed on the server.</p>

<h3>Modify files in the Exercise window:</h3>
<p class="ex1-command"><b>counterService/client/java/source/src/org/globus/tutorial/counter/GetCounterValue.java</b><br>
Add GSI Secure Message integrity to the getValue client<br>
<br>
<b>counterService/client/java/source/etc/message_encryption_host.xml</b><br>
<b>counterService/client/java/source/etc/message_encryption_self.xml</b><br>
These two will be our secure message client security descriptors.<br>
<br>
<b>counterService/service/java/source/etc/security_descriptor_1.xml</b><br>
This will add policy to require secure message privacy for the subtract method on the server side.</p>

<h3>Deploy the modified code in the Exercise window:</h3>
<p class="ex1-command">$ <font color="red">cd $TUTORIAL_DIR/counterService</font><br>
$ <font color="red">ant deploy</font><br>
...<br>
BUILD SUCCESSFUL<br>
Total time: 26 seconds<br>
</p>

<h3>Restart the container in the GT window:</h3>
<p>Notice that we're starting with -nosec to turn off transport
security.  Our Secure Message security will still be active though.</p>
<p class="command">$ <font color="red">bin/globus-start-container -nosec</font><br>
...<br>
[28]: http://10.0.1.3:8080/wsrf/services/gsi/AuthenticationService</p>

<h3>Create a counter from the Exercise window:</h3>
<p class="ex1-command">$ <font color="red">mkdir etc</font><br>
$ <font color="red">cp $GLOBUS_LOCATION/etc/hostCerts/hostcert.pem etc/serverCert.pem</font><br>
$ <font color="red">$GLOBUS_LOCATION/bin/tutorial-counter-create -s http://`hostname`:8080/wsrf/services/SecureMessageCounterService -o epr1</font><br>
Counter created. EPR written to file: epr1<br>
$ <font color="red">$GLOBUS_LOCATION/bin/tutorial-counter-subtract
-e epr1 -f
$GLOBUS_LOCATION/etc/globus_tutorial_counter_client/message_encryption_host.xml
11</font><br>
Value 11 subtracted<br>
$ <font color="red">$GLOBUS_LOCATION/bin/tutorial-counter-getValue -e epr1</font><br>
Current counter value -11<br>
$ <font color="red">$GLOBUS_LOCATION/bin/tutorial-counter-subtract
-e epr1 -f
$GLOBUS_LOCATION/etc/globus_tutorial_counter_client/message_encryption_self.xml
11</font><br>
2006-11-28 16:32:05,144 WARN authorization.BasicSubjectAuthorization
[main,authorize:88] Authorization failed: expected principals
[/C=US/O=Globus Alliance/OU=User/CN=10f2e485835.75b047a0], peer
principals [/C=US/O=Globus Alliance/OU=Service/CN=host/bacon.local]<br>
2006-11-28 16:32:05,151 ERROR wssec.WSSecurityClientHandler
[main,handleResponse:83]
org.globus.wsrf.impl.security.authorization.exceptions.AuthorizationException:
Authorization failed.<br>
Error: ; nested exception is: <br>
        javax.xml.rpc.soap.SOAPFaultException: Authorization failed.<br>
$ <font color="red">$GLOBUS_LOCATION/bin/tutorial-counter-getValue -e epr1</font><br>
Current counter value -22<br>
</p>

<p>That last message illustrates that secure message client-side authorization takes place <b>after</b> the operation is performed. So the valus of the counter was altered despite client authorization failing.</p>

<h3>Stop your container in the GT window:</h3>
<p>Press Control-C to stop the container.</p>
<p class="command">^CStopped SOAP Axis server at: http://10.0.1.3:8080/wsrf/services/</p>

<h2><a name="exercise9" id="exercise9"></a>Exercise 9: The Bank Service</h2>
<p>To show some more complicated service
interactions, we're going
to introduce the Bank Service in this exercise. This comprises of two
services BankFactoryService and a BankService. The factory service has
a single operation to create bank accounts. The accounts themselves can
be accessed through the Bank Service. </p>

<p> We will first deploy the insecure bank service and interact with it to ensure the installation is correct.</p>

<h3>Deploy the bank service code in the Exercise window:</h3>
<p>Notice that we're operating from bankService/ now.</p>
<p class="ex1-command">$ <font color="red">cd $TUTORIAL_DIR/bankService</font><br>
$ <font color="red">ant deploy</font><br>
...<br>
BUILD SUCCESSFUL<br>
Total time: 36 seconds<br>
</p>

<h3>Restart the container in the GT window:</h3>
<p class="command">$ <font color="red">bin/globus-start-container</font><br>
...<br>
[30]: https://10.0.1.3:8443/wsrf/services/gsi/AuthenticationService</p>

<h3>Interact with the bank service in the Exercise window:</h3>
<p>The bank-create-account command takes the location of a bank factory
service, an opening deposit, and the subject name of the user who is
authorized to interact with the account.</p>

<p class="ex1-command">$ <font color="red">$GLOBUS_LOCATION/bin/grid-proxy-info -issuer -globus</font>
issuer     : /C=US/O=Globus Alliance/OU=User/CN=101497d3dcd.3dcd5aef
$ <font color="red">$GLOBUS_LOCATION/bin/bank-create-account -s https://localhost:8443/wsrf/services/BankFactoryService -o bankAccount 75.10 </font>"DN
from previous step"<br>
Bank account created. EPR written to file: bankAccount<br>
$ <font color="red">$GLOBUS_LOCATION/bin/bank-deposit -e bankAccount 20.0
</font><br>
Amount 20.0 deposited<br>
$ <font color="red">$GLOBUS_LOCATION/bin/bank-withdraw -e bankAccount 100.0
</font><br>
Error: java.rmi.RemoteException: Error creating account.Insufficient funds; nested exception is: <br>
        java.lang.Exception: Insufficient funds<br>
$ <font color="red">$GLOBUS_LOCATION/bin/bank-withdraw -e bankAccount 90.0
</font><br>
Amount 90.0 withdrawn<br>
$ <font color="red">$GLOBUS_LOCATION/bin/bank-get-balance -e bankAccount
</font><br>
Current balance: 5.10</p>

<h3>Stop your container in the GT window:</h3>
<p>Press Control-C to stop the container.</p>
<p class="command">^CStopped SOAP Axis server at: https://10.0.1.3:8443/wsrf/services/</p>

<h3> Security Model for Bank Services</h3>

<p> Now we will try to indtroduce a security model for these services.</p>

<p>We require that only administrators of the Bank
Factory Service are allowed to create accounts. That is enforced by a
separate gridmap file for the factory service.</p>

<p> The actual bank account is created for
individual customers and the account has a separate authorization that
allows only the customer to access the account. So the Bank Service
allows for wthdraw/deposit/getCurrentBalance only for the account owner.</p>

<p> For the purpose of this exercise assume you are
the administrator for the Bank Factory Service on your machine and that
a neighbor of yours is the customer you are creating account for.</p>


<h3>Modify files in the Exercise window:</h3>
<p class="ex1-command"><b>bankService/service/java/source/etc/factory_security_descriptor.xml</b><br>
Modify the BankFactoryService to use gridmap authorization<br>
<br>
<b>bankService/service/java/source/etc/factoryGridMap</b><br>
Add your DN to the gridMap as an administrator. To get your DN: <br>
<font color="red">$$GLOBUS_LOCATION/bin/grid-proxy-info -issuer -globus</font><br>
issuer   : /C=US/O=Globus Alliance/OU=User/CN=101497d3dcd.3dcd5aef<br>
<br>
Your entry in the file should look like:<br>
"/C=US/O=Globus Alliance/OU=User/CN=101497d3dcd.3dcd5aef" ranantha <br>
<br>
<b>bankService/service/java/source/etc/resource_security_descriptor.xml</b><br>
Setup secure conversation for deposit and withdraw, with run-as set to caller.  Also, reject limited proxies.<br>
<br>
<b>bankService/service/java/source/src/org/globus/tutorial/impl/bankService/BankResource.java</b><br>
Enforce that only the authorized DN passed as parameter when a Bank account/resource is created is allowed to access it.<br>
<br>
<b>bankService/client/java/source/src/org/globus/tutorial/bank/client/Create.java</b><br>
Modify the create client to perform host authorization<br>
<br>
<b>bankService/client/java/source/src/org/globus/tutorial/bank/client/TutorialBaseClient.java</b><br>
Modify the client base class to use security descriptors<br>
<br>
<b>bankService/client/java/source/etc/conversation_delegation_host.xml</b><br>
Create the client-side descriptor to perform secure conversation with
delegation and host authorization for withdraw and deposit.<br>
<br>
<b>bankService/client/java/source/etc/message_signature_host.xml</b><br>
Create the client-side descriptor to perform secure message for getBalance<br>
</p>

<h3>Deploy the bank service code in the Exercise window:</h3>
<p class="ex1-command">$ <font color="red">cd $TUTORIAL_DIR/bankService</font><br>
$ <font color="red">ant deploy</font><br>
...<br>
BUILD SUCCESSFUL<br>
Total time: 36 seconds<br>
</p>

<h3>Restart the container in the GT window:</h3>
<p class="command">$ <font color="red">bin/globus-start-container</font><br>
...<br>
[30]: https://10.0.1.3:8443/wsrf/services/gsi/AuthenticationService</p>

<h3>Interact with the bank service in the Exercise window:</h3>

<p> Create a bank account for your neighbor using your factory service.</p>

<!-- FIXME Scenario specific <p> <b><font color="purple"> A note here on how neighbor can get his DN ?</font></b> </p> -->

<p class="ex1-command">$ <font color="red">$GLOBUS_LOCATION/bin/bank-create-account -s https://`hostname`:8443/wsrf/services/BankFactoryService -o neighborAccount 75.10</font> "Neighbor's
DN"<br>
Bank account created. EPR written to file: neighborAccount<br>
</p>

<p>Now your neighbor can interact with the account you created for them using the EPR in the file neighborAccount:</p>

<p class="ex2-command">neighbor$ <font color="red">
$GLOBUS_LOCATION/bin/bank-deposit -e neighborAccount -f
$GLOBUS_LOCATION/etc/globus_bank_client/conversation_delegation_host.xml
100</font><br>
Amount 100 deposited<br>
neighbor$ <font color="red">$GLOBUS_LOCATION/bin/bank-get-balance -e neighborAccount -f $GLOBUS_LOCATION/etc/globus_bank_client/message_signature_host.xml</font><br>
Current balance: 175.10</p>

<p> But since your factory service is protected with
a gridmap file that only has your DN, your neighbor cannot create new
accounts on your service. Share your Bank Factory Service URL and have
them try it.</p>

<p> Although you are the administrator you will not be able to access your neighbor's account because only he is authorized.</p>

<p class="ex1-command">$ <font color="red">
$GLOBUS_LOCATION/bin/bank-deposit -e neighborAccount -f
$GLOBUS_LOCATION/etc/globus_bank_client/conversation_delegation_host.xml
100</font><br>
Error:
org.globus.wsrf.impl.security.authorization.exceptions.AuthorizationException: "/C=US/O=Globus Alliance/OU=User/CN=101497d3dcd.3dcd5aef" is
not authorized to use operation:
{http://www.globus.org/tutorial/bank}deposit on this service</p>

<h3>Stop your container in the GT window:</h3>
<p>Press Control-C to stop the container.</p>
<p class="command">^CStopped SOAP Axis server at: https://10.0.1.3:8443/wsrf/services/</p>


<h2><a name="exercise10" id="exercise10"></a>Exercise 10: The Finance Service</h2>

<p> The Finance Service is a simple tool that can be used to calculate
future value of some investment. It uses the balance from a bank
account as the principle amount.</p>

<p> A separate service credential will be requested and used for the
Finance Service. Also, gridmap authorization with the gridmap file
configured at the container level determines who can access the
finance service.</p>

<p> For the finance service to be able to access the bank account for
some user, the user needs to delegate his credential to the Delegation
Service and provide the Finance Service with an EPR. The Delegation
Service also uses the container level gridmap file to restrict who can
use the service.</p>

<h3>Deploy the finance service from the Exercise window:</h3>
<p class="ex1-command">$ <font color="red">cd $TUTORIAL_DIR/financeService</font><br>
$ <font color="red">ant deploy</font><br>
...<br>
BUILD SUCCESSFUL<br>
Total time: 36 seconds<br>
</p>

<h3>Request a service credential for the FinanceService in the GT window:</h3>

<p>While this is similar to obtaining host certificate, it has an additional step of specifying the service name with the request. </p>

<p class="command">$ <font color="red">bin/grid-cert-request -host `hostname` -service FinanceService -dir etc/globus_finance_service/certs -caEmail null </font><br>
Generating a 1024 bit RSA private key<br>
A private key and a certificate request has been generated with the subject:<br>
<br>
/O=Grid/CN=FinanceService/bacon-57.mcs.anl.gov<br>
<br>
The private key is stored in /private/tmp/tutorial/ws-core-4.0.3/etc/globus_finance_service/certs/FinanceServicekey.pem<br>
The request is stored in /private/tmp/tutorial/ws-core-4.0.3/etc/globus_finance_service/certs/FinanceServicecert_request.pem<br>
</p>

<p>Upload the generated request file (etc/globus_finance_service/certs/FinanceServicecert_request.pem)
to <a href="http://gcs.globus.org:8080/gcs/servicecert.html">
http://gcs.globus.org:8080/gcs/servicecert.html</a> using the
"Upload certificate request from file" option.  </p>

<p> Also, fill in your full hostname in the "Full hostname (including
domain) of the host on which the certificate will be used" entry box. </p>

<p> <b>Also, add "FinanceService" as the service name, then submit.</b></p>

<p>Please do not try to copy/paste
- the certificate request is sensitive to whitespace.  Save the generated
certificate to $GLOBUS_LOCATION/etc/globus_finance_service/certs/FinanceServicecert.pem using the
"Click here to download the cert" link.  Again, please don't try to copy/paste
the certificate.
</p>

<h3>Modify files in the Exercise window:</h3>
<p class="ex1-command">
<b>$TUTORIAL_DIR/etc/global_security_descriptor.xml</b><br>
Configure the container to have a default grid-mapfile<br>
<br>
<b>$TUTORIAL_DIR/etc/containerGridMap</b><br>
Add your DN and your neighbor's DN to the grid mapfile.<br>
<br>
<b>financeService/service/java/source/etc/security_descriptor.xml</b><br>
Configure the FinanceService to use the service credential and to
perform gridmap authorization. Note that no gridmap file is configured and contianer gridmap file is used.<br>
<br>
<b>financeService/service/java/source/src/org/globus/tutorial/impl/financeService/FinanceResource.java</b><br>
Edit so that only the caller may use the created resource. <br>
Also, register a listener with the Delegation Service for the
delegation EPR, to be able to access credential and recieve updates.<br>
Finally, set the delegated credential as the resource's credential so
that all invocations from the resource uses those credentials.<br>
<br>
<b>financeService/service/java/source/src/org/globus/tutorial/impl/financeService/FinanceService.java</b><br>
Edit the getValue function so it contacts Delegation Service to get delegated credentials. <br>
<br>
<b>financeService/client/java/source/src/org/globus/tutorial/finance/client/TutorialBaseClient.java</b><br>
<b>financeService/client/java/source/src/org/globus/tutorial/finance/client/Create.java</b><br>
<b>financeService/client/java/source/src/org/globus/tutorial/finance/client/GetCurrentBalance.java</b><br>
<b>financeService/client/java/source/etc/conversation_signature_self.xml</b><br>
Set up client-side security. Note the authorization here is Host-based with the service name embedded.<br>
</p>
<p>Additionally, copy the grid-mapfile and container security descriptor into your GLOBUS_LOCATION:
</p>
<p class="ex1-command">
$ <font color="red">cp $TUTORIAL_DIR/etc/global_security_descriptor.xml $GLOBUS_LOCATION/etc/globus_wsrf_core/
 </font><br>
$ <font color="red">cp $TUTORIAL_DIR/etc/containerGridMap  $GLOBUS_LOCATION/etc/globus_wsrf_core/
</font><br>
</p>


<h3>Deploy the modified code in the Exercise window:</h3>
<p class="ex1-command">
$ <font color="red">cd $TUTORIAL_DIR/financeService</font><br>
$ <font color="red">ant deploy</font><br>
...<br>
BUILD SUCCESSFUL<br>
Total time: 26 seconds<br>
</p>

<h3>Restart the container in the GT window:</h3>
<p class="command">
$ <font color="red">bin/globus-start-container -nosec</font><br>
...<br>
[30]: http://10.0.1.3:8080/wsrf/services/gsi/AuthenticationService
</p>

<h3>Use Finance Service for your account:</h3>

<p>Now we're going to setup several services that are going to work 
together.  We will start first with creating account and setting up finance service for yourself. 
</p><ol>
<li> Create a bank account for yourself
</li><li> Delegate your credential
</li><li> Create a finance service account for that bank account and
provide EPR to delegated credential for the service to be able to
access the account.
</li><li> Use the calculate tool with finance service.
</li></ol>

<p class="ex1-command">
$ <font color="red">$GLOBUS_LOCATION/bin/bank-create-account
-s http://`hostname`:8080/wsrf/services/BankFactoryService -o myAccount
-d 100.45 "`$GLOBUS_LOCATION/bin/grid-proxy-info -issuer`"</font><br>
Bank account created. EPR written to file: myAccount<br><br>

$ <font color="red">$GLOBUS_LOCATION/bin/globus-credential-delegate -h `hostname` -p 8080 -m conv myDelegEPR</font><br>
EPR will be written to: myDelegEPR<br>
Delegated credential EPR:<br>
Address: http://140.221.57.233:8080/wsrf/services/DelegationService<br>
Reference property[0]:<br>
&lt;ns1:DelegationKey
xmlns:ns1="http://www.globus.org/08/2004/delegationService"&gt;8d7c4c90-856b-11db-916f-89c52a3c6120&lt;/ns1:DelegationKey&gt;<br><br>

$ <font color="red">$GLOBUS_LOCATION/bin/finance-create -o myFinanceEPR -s http://`hostname`:8080/wsrf/services/FinanceService myAccount myDelegEPR</font><br>
Finance resource created. EPR written to  file: myFinanceEPR<br><br>

$ <font color="red">$GLOBUS_LOCATION/bin/finance-calculate
-f
$GLOBUS_LOCATION/etc/globus_finance_client/conversation_signature_self.xml
-e myFinanceEPR 3.2 5</font><br>
At a rate of 3.2% ,in 5 years your return will be 117.58<br><br>

$ <font color="red">$GLOBUS_LOCATION/bin/finance-get-balance -s http://`hostname`:8080/wsrf/services/FinanceService myAccount myDelegEPR</font><br>
Current balance: 100.45
</p>

<h3>Neigbor uses your Finance Service :</h3>

<p> Now you can have your neighbor use your finance service to
calcualte returns for a balance for his bank account. He can use a bank
account on a container running on his machine or you can create an
account for him using your Bank Factory Service.</p>

<ol>
<li> Create a bank account for your neighbor
</li><li> Have your neighbor delegate his credentials to your container
</li><li> Have your neighbor create a finance service account with his account and delegated EPR
</li></ol>

<p class="ex1-command">
$ <font color="red">$GLOBUS_LOCATION/bin/bank-create-account
-s http://`hostname`:8080/wsrf/services/BankFactoryService -o
neighborAccount -d 100.45 </font>"Neighbor's DN"<br>
Bank account created. EPR written to file: neighborAccount<br>
</p>

<p class="ex2-command">
neighbor$ <font color="red">$GLOBUS_LOCATION/bin/globus-credential-delegate -h YourHostName -p 8080 -m conv neighborDelegEPR</font><br>
EPR will be written to: neighborDelegEPR<br>
Delegated credential EPR:<br>
Address: http://140.221.57.233:8080/wsrf/services/DelegationService<br>
Reference property[0]:<br>
&lt;ns1:DelegationKey
xmlns:ns1="http://www.globus.org/08/2004/delegationService"&gt;8d7c4c90-856b-11db-916f-89c52a3c6120&lt;/ns1:DelegationKey&gt;<br><br>

neighbor$ <font color="red">$GLOBUS_LOCATION/bin/finance-create
-o neighborFinanceEPR -s
http://YourHostName:8080/wsrf/services/FinanceService neighborAccount
neighborDelegEPR</font><br>
Finance resource created. EPR written to  file: myFinanceEPR<br><br>

$ <font color="red">$GLOBUS_LOCATION/bin/finance-calculate
-f
$GLOBUS_LOCATION/etc/globus_finance_client/conversation_signature_self.xml
-e neighborFinanceEPR 3.2 5</font><br>
At a rate of 3.2% ,in 5 years your return will be 117.58<br><br>
</p>

<p> You will see errors if you use your delegated credentials to calculate returns for your neighbor's account.</p>

<p class="ex1-command">
$ <font color="red">$GLOBUS_LOCATION/bin/finance-get-balance -s http://`hostname`:8080/wsrf/services/FinanceService neighborAccount myDelegEPR</font><br>Error:
org.globus.wsrf.impl.security.authorization.exceptions.AuthorizationExcep
tion: "/C=US/O=Globus Alliance/OU=User/CN=101497d3dcd.3dcd5aef" is not
authorized to use operation:
{http://www.globus.org/tutorial/bank}getCurrentBalance on this service<br>
</p>

<h3>Stop your container in the GT window:</h3>
<p>
Press Control-C to stop the container.
</p>
<p class="command">
^CStopped SOAP Axis server at: http://10.0.1.3:8443/wsrf/services/</p>

<h2><a name="troubleshooting"></a>Troubleshooting!</h2>
<ul>
<li>
Error: ; nested exception is: <br>
        java.net.SocketException: Broken pipe
<blockquote>
You've tried to create a counter, but the container is not running.
</blockquote>
</li>
<li>
Failed to start container: Container failed to initialize [Caused by: Secure container requires valid credentials]
<blockquote>
You've tried to start the container, but don't have a valid proxy.  Run
bin/grid-proxy-init -cert tmp/usercert.pem -key tmp/userkey.pem.
</blockquote>
</li>
<li>
Error: ; nested exception is: <br>
        GSSException: Defective credential detected [Caused by: Proxy file (/tmp/x509up_u501) not found.]<br>
<blockquote>
You've tried to use a secure client, but don't have a valid proxy.  Run
bin/grid-proxy-init -cert tmp/usercert.pem -key tmp/userkey.pem.
</blockquote>
</li>
<li>
Error: java.rmi.RemoteException: ; nested exception is: <br>
        org.globus.wsrf.NoSuchResourceException
<blockquote>
You've used a epr1 file that is no longer valid because of a container
restart.  Create a new counter.
</blockquote>
</li>
<li><a name="logicalHost"></a>Setting a preferred IP address for your host (to fix 127.0.0.1 troubles):
<blockquote>
Find out your current IP address, and add a line to
<code>$GLOBUS_LOCATION/etc/globus_wsrf_core/server-config.wsdd</code> under
the <code>&lt;globalConfiguration&gt;</code> section: 
<p class="command">
&lt;parameter name="logicalHost" value="xxx.xxx.xxx.xxx"/&gt;
</p>
<p>Here's an example of the file with that parameter set:</p><p class="command">&lt;globalConfiguration&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;parameter name="sendXsiTypes" value="true"/&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;parameter name="logicalHost" value="192.168.123.104"/&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;!-- @CONTAINER_SECURITY_DESCRIPTOR@ --&gt;<br>
</p></blockquote>

</li><li>Error: org.globus.wsrf.security.SecurityException: [SEC]Operation name could not be determined
<blockquote> You might be contacting the wrong service. If you are using <i>-e</i> option for an EPR file, check your create command to ensure you are contact the correct service to create a new resource. 
</blockquote>
</li>

</ul>

<?php include("/mcs/www-unix.globus.org/include/globus_footer.inc"); ?>